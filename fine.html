<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>章鱼喷墨机</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/nzP9sgxr/chan-125.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

    <style>
        /* --- 全局与主题样式 --- */
        :root {
            --bg-color: #fce4ec;
            --primary-color: #ff80ab;
            --secondary-color: #f48fb1;
            --accent-color: #90caf9;
            --text-color: #444;
            --white-color: #fff;
            --border-radius: 18px;
            --phone-corner-radius: 0px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --top-pinned-bg: #fff0f5;
            --online-status-color: #4CAF50;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #fce4ec, #f8bbd0);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .phone-screen {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            max-height: 850px;
            background-color: var(--white-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: var(--phone-corner-radius);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .app-header .back-btn,
        .app-header .action-btn {
            background: none;
            border: none;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #cancel-multi-select-btn {
            font-size: 14px !important;
            font-weight: 500 !important;
            color: var(--white-color) !important;
            background-color: var(--primary-color) !important;
            border-radius: 10px !important;
            padding: 5px 10px !important;
            width: auto !important;
            height: auto !important;
        }

        .app-header .action-btn-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-header .action-btn-group .action-btn {
            font-size: 16px;
            font-weight: 600;
            width: auto;
            padding: 6px 12px;
            border-radius: 10px;
        }

        .app-header .action-btn-group #create-group-btn {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .app-header .action-btn-group #add-chat-btn {
            font-size: 28px;
            padding: 0;
            width: 40px;
            height: 40px;
            background-color: transparent;
            color: var(--primary-color);
            border-radius: 50%;
        }

        .app-header .action-btn img {
            width: 28px;
            height: 28px;
        }

        .app-header .title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .app-header .title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .app-header .subtitle {
            font-size: 12px;
            color: #888;
            display: flex;
            align-items: center;
            margin-top: 2px;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--online-status-color);
            margin-right: 5px;
        }

        .app-header .placeholder {
            width: 40px;
        }

        #home-screen {
            justify-content: space-between;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
            padding: 50px 0;
        }

        .time-widget {
            text-align: center;
            padding: 0 20px;
            color: var(--text-color);
        }

        .time-widget .time {
            font-size: 72px;
            font-weight: 600;
        }

        .time-widget .date {
            font-size: 18px;
            color: #666;
        }

        #home-screen.day-mode .time-widget,
        #home-screen.day-mode .time-widget .date,
        #home-screen.day-mode .app-icon .app-name {
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .app-grid {
            width: 100%;
            padding: 20px 40px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            justify-content: center;
            align-content: center;
            margin-top: 40px;
        }

        #home-screen.day-mode .time-widget,
        #home-screen.day-mode .time-widget .date,
        #home-screen.day-mode .app-icon .app-name {
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .dock {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            margin: 0 20px;
            min-height: 80px;
            gap: 15px;
        }

        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            text-decoration: none;
        }

        .icon-img {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            margin-bottom: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            object-fit: cover;
        }

        .app-icon:hover .icon-img {
            transform: translateY(-5px);
        }

        .app-icon .app-name {
            font-size: 12px;
            color: var(--text-color);
            font-weight: 500;
        }

        .content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        .placeholder-text {
            text-align: center;
            color: #aaa;
            margin-top: 50px;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-window {
            background: var(--white-color);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            width: 85%;
            max-width: 340px;
            animation: slideUp 0.4s ease-out;
        }

        .modal-window h3 {
            margin-top: 0;
            text-align: center;
            color: var(--primary-color);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #edit-group-member-modal,
        #create-member-for-group-modal {
            z-index: 102;
        }

        #edit-group-member-modal .avatar-preview,
        #create-member-for-group-modal .avatar-preview {
            width: 80px;
            height: 80px;
        }

        .context-menu {
            position: fixed;
            z-index: 1000;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            padding: 5px 0;
            animation: fadeIn 0.1s ease;
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
        }

        .context-menu-item:hover {
            background-color: #f5f5f5;
        }

        .context-menu-item.danger {
            color: #e53935;
        }

        .action-sheet-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 200;
            display: none;
            align-items: flex-end;
            animation: fadeIn 0.3s ease;
        }

        .action-sheet-overlay.visible {
            display: flex;
        }

        .action-sheet {
            background: #f7f7f7;
            width: 100%;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease-out;
        }

        .action-sheet-button {
            width: 100%;
            background: white;
            border: none;
            padding: 15px;
            font-size: 16px;
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .action-sheet-button.danger {
            color: #e53935;
        }

        .action-sheet-button:last-child {
            margin-bottom: 0;
        }

        #chat-list-screen .content,
        #world-book-screen .content {
            padding: 10px 0 0 0;
        }

        .list-container {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .list-item:hover {
            background-color: #fdf6f8;
        }

        .chat-item.pinned {
            background-color: var(--top-pinned-bg);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #eee;
        }

        .group-avatar {
            border-radius: 10px;
        }

        .item-details {
            flex-grow: 1;
            overflow: hidden;
        }

        .item-details-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 16px;
        }

        .item-preview-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .item-preview {
            font-size: 14px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }

        .pin-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        #chat-room-screen {
            background-size: cover;
            background-position: center;
        }

        #chat-room-screen .content {
            display: flex;
            flex-direction: column;
            padding: 10px;
            padding-bottom: 10px;
            transition: padding-bottom 0.3s ease;
        }

        #chat-room-screen.multi-select-active .content {
            padding-bottom: 70px;
        }

        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 10px;
            scroll-behavior: smooth;
        }

        .message-wrapper {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
            transition: background-color 0.2s;
            flex-direction: column;
        }

        .message-wrapper.group-message {
            margin-bottom: 18px;
        }

        .message-wrapper.sent {
            align-items: flex-end;
        }

        .message-wrapper.received {
            align-items: flex-start;
        }

        .message-wrapper.system-notification {
            align-items: center;
        }

        .message-bubble-row {
            display: flex;
            width: 100%;
            align-items: flex-start;
        }

        .message-wrapper.sent .message-bubble-row {
            flex-direction: row-reverse;
        }

        .message-wrapper.multi-select-selected {
            background-color: rgba(144, 202, 249, 0.2);
            border-radius: var(--border-radius);
        }

        .message-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .group-nickname {
            position: absolute;
            top: -15px;
            font-size: 11px;
            color: #888;
            white-space: nowrap;
            width: 70px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-time {
            font-size: 9px;
            color: #aaa;
            margin-top: 3px;
        }

        .message-bubble {
            max-width: 260px;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            line-height: 1.4;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin: 0 8px;
            cursor: pointer;
            font-size: 15px;
        }

        .message-bubble.sent {
            border-bottom-right-radius: 5px;
        }

        .message-bubble.received {
            border-bottom-left-radius: 5px;
        }

        .system-notification-bubble {
            background-color: rgba(200, 200, 200, 0.5);
            color: #666;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 10px;
            text-align: center;
        }

        .image-bubble {
            max-width: 120px;
            border-radius: var(--border-radius);
            margin: 0 8px;
            padding: 4px;
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .image-bubble img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: calc(var(--border-radius) - 4px);
        }

        .message-wrapper.sent .image-bubble {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .image-bubble {
            border-bottom-left-radius: 5px;
        }

        .voice-bubble {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin: 0 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 90px;
            max-width: 200px;
        }

        .message-wrapper.sent .voice-bubble {
            border-bottom-right-radius: 5px;
            flex-direction: row-reverse;
        }

        .message-wrapper.received .voice-bubble {
            border-bottom-left-radius: 5px;
        }

        .voice-bubble .play-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .voice-bubble .duration {
            font-size: 13px;
            margin: 0 8px;
            white-space: nowrap;
        }

        .message-wrapper.sent .play-icon {
            transform: scaleX(-1);
        }

        .voice-transcript {
            font-size: 14px;
            color: #555;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 8px 12px;
            margin-top: 5px;
            margin-left: 54px;
            margin-right: 54px;
            border-radius: 10px;
            line-height: 1.6;
            max-width: calc(100% - 108px);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .voice-transcript.active {
            display: block;
        }

        .message-wrapper.sent .voice-transcript {
            align-self: flex-end;
            margin-right: 54px;
            margin-left: auto;
        }

        .message-wrapper.received .voice-transcript {
            align-self: flex-start;
            margin-left: 54px;
            margin-right: auto;
        }

        .pv-card {
            width: 230px;
            aspect-ratio: 1 / 1;
            background-color: #f0f0f0;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            margin: 0 8px;
        }

        .message-wrapper.sent .pv-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .pv-card {
            border-bottom-left-radius: 5px;
        }

        .pv-card-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 0.5s ease-in-out;
            z-index: 2;
        }

        .pv-card-image-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .pv-card-content {
            padding: 15px;
            height: 100%;
            overflow-y: auto;
            color: var(--text-color);
            line-height: 1.6;
            font-size: 15px;
            background-color: white;
            position: relative;
            z-index: 1;
        }

        .pv-card-footer {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
            color: white;
            padding: 20px 10px 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 3;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }

        .pv-card-footer.hidden {
            opacity: 0;
        }

        .pv-card-footer svg {
            width: 14px;
            height: 14px;
            fill: white;
            flex-shrink: 0;
        }

        .transfer-card {
            width: 240px;
            height: auto;
            border-radius: var(--border-radius);
            margin: 0 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
        }

        .message-wrapper.sent .transfer-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .transfer-card {
            border-bottom-left-radius: 5px;
            cursor: pointer;
        }

        .transfer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            filter: blur(4px);
            transform: scale(1.1);
            z-index: 1;
        }

        .transfer-card.sent-transfer::before {
            background-image: url('https://i.postimg.cc/sxN893WF/IMG-20250712.png');
        }

        .transfer-card.received-transfer::before {
            background-image: url('https://i.postimg.cc/FzR8LY7g/IMG-20250712-170703.png');
        }

        .transfer-card .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 2;
            transition: background-color 0.5s ease;
        }

        .transfer-card.received .overlay {
            background-color: rgba(255, 182, 193, 0.4);
        }

        .transfer-card.returned .overlay {
            background-color: rgba(100, 100, 100, 0.5);
        }

        .transfer-content {
            position: relative;
            z-index: 3;
            padding: 20px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .transfer-title {
            font-size: 14px;
            margin: 0 0 5px 0;
            opacity: 0.9;
        }

        .transfer-amount {
            font-size: 28px;
            font-weight: bold;
            margin: 0;
        }

        .transfer-remark {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transfer-status {
            font-size: 12px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            opacity: 0.8;
        }

        .gift-card {
            width: 230px;
            background-color: #fff;
            border: 2px solid #333;
            border-radius: var(--border-radius);
            box-shadow: 4px 4px 0px #ddd;
            padding: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            margin: 0 8px;
            position: relative;
            overflow: hidden;
        }

        .message-wrapper.sent .gift-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .gift-card {
            border-bottom-left-radius: 5px;
        }

        .gift-card-icon {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .gift-card-text {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
        }

        .gift-card-description {
            font-size: 14px;
            color: #555;
            background-color: rgba(240, 240, 240, 0.9);
            padding: 8px 12px;
            margin-top: 5px;
            margin-left: 54px;
            margin-right: 54px;
            border-radius: 10px;
            line-height: 1.6;
            max-width: calc(100% - 108px);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .gift-card-description.active {
            display: block;
        }

        .message-wrapper.sent .gift-card-description {
            align-self: flex-end;
            margin-right: 54px;
            margin-left: auto;
        }

        .message-wrapper.received .gift-card-description {
            align-self: flex-start;
            margin-left: 54px;
            margin-right: auto;
        }

        .gift-card-received-stamp {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 2px 6px;
            transform: rotate(15deg);
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
        }

        .gift-card.received .gift-card-received-stamp {
            opacity: 1;
        }

        .load-more-btn {
            background-color: #e0e0e0;
            color: #757575;
            border: none;
            padding: 8px 16px;
            margin: 10px auto;
            border-radius: 15px;
            cursor: pointer;
            display: block;
            font-size: 13px;
            font-weight: 500;
        }

        .load-more-btn:hover {
            background-color: #d1d1d1;
        }

        .typing-indicator {
            text-align: center;
            color: #aaa;
            font-style: italic;
            font-size: 14px;
            padding: 10px 0;
            display: none;
        }

        #sticker-bar {
            flex-shrink: 0;
            padding: 0 10px 5px;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        .sticker-bar-btn {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
        }

        .sticker-bar-btn svg {
            width: 28px;
            height: 28px;
            fill: #888;
        }

        #sticker-modal {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35%;
            max-height: 250px;
            background: #f7f7f7;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            z-index: 25;
            display: none;
            flex-direction: column;
        }

        #sticker-modal.visible {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        #sticker-modal .header {
            padding: 10px 15px;
            font-weight: bold;
            color: var(--text-color);
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sticker-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
        }

        .sticker-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .sticker-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .sticker-item span {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        #add-sticker-modal .modal-window {
            max-width: 360px;
        }

        #sticker-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            background-color: #f9f9f9;
        }

        #sticker-preview img {
            max-width: 100%;
            max-height: 100%;
        }

        .chat-input-wrapper {
            flex-shrink: 0;
            display: flex;
            flex-direction: column; /* 核心改动：将主轴方向设为垂直 */
        }

        .message-input-area {
            display: flex;
            align-items: center;
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            border-top: 1px solid #eee;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            gap: 10px;
            border-bottom-left-radius: var(--phone-corner-radius);
            border-bottom-right-radius: var(--phone-corner-radius);
            overflow: hidden;
        }

        .message-input-area input {
            flex-grow: 1;
            border: none;
            padding: 12px;
            border-radius: 18px;
            background-color: #f0f0f0;
        }

        .message-input-area input:focus {
            outline: none;
        }

        .message-input-area .icon-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .message-input-area .icon-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .message-input-area .icon-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .message-input-area .icon-btn.send-btn {
            font-size: 18px;
        }

        #multi-select-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            border-top: 1px solid #eee;
            z-index: 20;
            border-bottom-left-radius: var(--phone-corner-radius);
            border-bottom-right-radius: var(--phone-corner-radius);
            animation: slideUp 0.3s ease-out;
        }

        #multi-select-bar.visible {
            display: flex;
        }

        .settings-sidebar {
            position: absolute;
            top: 0;
            right: -100%;
            width: 80%;
            height: 100%;
            background: #fff;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.4s ease-in-out;
            z-index: 101;
            display: flex;
            flex-direction: column;
        }

        .settings-sidebar.open {
            right: 0;
        }

        .settings-sidebar .header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            text-align: center;
            color: var(--primary-color);
        }

        .settings-sidebar .content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .settings-sidebar .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .settings-sidebar .avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .settings-sidebar .avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #fce4ec;
            border-radius: 10px;
            background-color: #fff;
            transition: border-color 0.3s;
            font-family: var(--font-family);
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group.radio-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .form-group.radio-group label {
            margin-bottom: 0;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(255, 128, 171, 0.5);
        }

        label.btn-primary {
            color: var(--white-color) !important;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .btn-secondary {
            background-color: var(--accent-color);
            color: var(--white-color);
            margin-bottom: 15px;
        }

        .btn-secondary:hover {
            background-color: #64b5f6;
            box-shadow: 0 4px 15px rgba(144, 202, 249, 0.5);
        }

        .btn-neutral {
            background-color: #bdbdbd;
            color: var(--white-color);
        }

        .btn-neutral:hover {
            background-color: #9e9e9e;
        }

        .btn-danger {
            background-color: #ef5350;
            color: white;
        }

        .btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: var(--white-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .btn.loading .spinner {
            display: block;
        }

        .btn.loading .btn-text {
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .wallpaper-preview {
            width: 100%;
            aspect-ratio: 9 / 16;
            max-height: 400px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            background-size: cover;
            background-position: center;
            border: 3px dashed var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-style: italic;
            background-color: #fff8fa;
        }

        .toast {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 14px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
        }

        #world-book-selection-modal,
        #invite-member-modal,
        #group-recipient-selection-modal {
            z-index: 102;
        }

        #world-book-selection-modal .modal-window,
        #invite-member-modal .modal-window,
        #group-recipient-selection-modal .modal-window {
            width: 90%;
            max-width: 380px;
        }

        #world-book-selection-list,
        #invite-member-selection-list,
        #group-recipient-selection-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 40vh;
            overflow-y: auto;
        }

        .world-book-select-item,
        .invite-member-select-item,
        .group-recipient-select-item {
            display: flex;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .world-book-select-item:last-child,
        .invite-member-select-item:last-child,
        .group-recipient-select-item:last-child {
            border-bottom: none;
        }

        .world-book-select-item input[type="checkbox"],
        .invite-member-select-item input[type="checkbox"],
        .group-recipient-select-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
        }

        .world-book-select-item label,
        .invite-member-select-item label,
        .group-recipient-select-item label {
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .invite-member-select-item img,
        .group-recipient-select-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* --- Group Chat Specific Styles --- */
        .member-selection-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            max-height: 40vh;
            overflow-y: auto;
        }

        .member-selection-item {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .member-selection-item:last-child {
            border-bottom: none;
        }

        .member-selection-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .member-selection-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .member-selection-item label {
            font-weight: 500;
            color: var(--text-color);
        }

        #group-settings-sidebar .group-avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        #group-settings-sidebar .group-avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            cursor: pointer;
        }

        #group-settings-sidebar .group-members-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        #group-settings-sidebar .group-member,
        #group-settings-sidebar .add-member-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        #group-settings-sidebar .group-member img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
            border: 2px solid #eee;
        }

        #group-settings-sidebar .add-member-btn .add-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #ccc;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }

        #group-settings-sidebar .add-member-btn:hover .add-icon {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        #group-settings-sidebar .group-member span,
        #group-settings-sidebar .add-member-btn span {
            font-size: 12px;
            text-align: center;
            color: var(--text-color);
        }

        #customize-screen .icon-custom-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        #customize-screen .icon-custom-item:last-child {
            border-bottom: none;
        }

        #customize-screen .icon-preview {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
        }

        #customize-screen .icon-details {
            flex-grow: 1;
        }

        #customize-screen .icon-details p {
            margin: 0 0 8px 0;
            font-weight: 600;
        }

        #customize-screen .icon-details input {
            width: calc(100% - 70px);
        }

        #customize-screen .reset-icon-btn {
            background: #e0e0e0;
            color: #555;
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }

        /* --- Tutorial Screen Styles --- */
        .tutorial-item {
            margin-bottom: 15px;
            border: 1px solid #fce4ec;
            border-radius: 12px;
            overflow: hidden;
            background-color: #fff8fa;
        }

        .tutorial-header {
            padding: 12px 18px;
            font-weight: 600;
            color: var(--secondary-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tutorial-header::after {
            content: '▼';
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .tutorial-item.open .tutorial-header::after {
            transform: rotate(180deg);
        }

        .tutorial-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease;
            padding: 0 10px;
        }

        .tutorial-item.open .tutorial-content {
            padding: 10px 10px;
            /* A large value to ensure it expands to fit the content */
            max-height: 5000px;
        }

        .tutorial-content img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }


#sticker-modal .header .action-btn-group {
    align-items: center !important;
}
/* --- NEW: Reply Preview Bar Styles --- */
/* ▼▼▼ 使用新的样式替换旧的 #reply-preview-bar 相关样式 ▼▼▼ */
        /* ▼▼▼ 使用这版【主题自适应】样式替换旧的 #reply-preview-bar 相关样式 ▼▼▼ */
        #reply-preview-bar {
            display: none;
            flex-direction: row;
            align-items: center;
            padding: 8px 12px;
            /* 改回中性的浅灰色背景 */
            background-color: #f0f0f0; 
            border-radius: 12px;
            margin: 0 10px 8px 10px;
            animation: slideUp 0.2s ease-out;
            gap: 10px;
        }

        #reply-preview-bar.visible {
            display: flex;
        }

        .reply-preview-content {
            flex-grow: 1;
            padding-left: 0;
            border-left: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .reply-preview-sender {
            font-size: 14px;
            font-weight: 600;
            /* 关键：使用主题的主颜色 */
            color: var(--primary-color);
            line-height: 1.3;
        }

        .reply-preview-text {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        #cancel-reply-btn {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            /* 改回中性的按钮颜色 */
            background-color: #d0d0d0;
            color: white;
            font-size: 18px;
            line-height: 24px;
            align-self: center;
        }

        /* --- NEW: Reply Quote Styles --- */
       /* ▼▼▼ 使用这版【主题自适应】样式替换旧的 .reply-quote-bubble 相关样式 ▼▼▼ */

        .reply-quote-sender {
            font-weight: 600;
            /* 关键：使用主题的主颜色作为发送者名称颜色 */
            color: var(--primary-color);
            margin-bottom: 3px;
            display: block;
        }

        .reply-quote-text {
            color: #555;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

/* ▼▼▼ 添加这段全新的CSS代码，并删除旧的 .reply-quote-bubble 样式 ▼▼▼ */
        .internal-reply-quote {
            padding: 6px 10px;
            margin-bottom: 8px;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.07); /* 嵌入式引用的背景色，比气泡稍深 */
            font-size: 13px;
            cursor: pointer;
        }

        /* 针对浅色气泡的优化 */
        .message-bubble.received .internal-reply-quote {
            background-color: rgba(0, 0, 0, 0.07);
        }

        /* 针对深色或彩色气泡的优化 */
        .message-bubble.sent .internal-reply-quote {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .internal-reply-sender {
            font-weight: 600;
            color: var(--primary-color); /* 沿用主题色 */
            display: block;
        }

        .internal-reply-text {
            color: inherit; /* 继承父气泡的文字颜色 */
            opacity: 0.7; /* 让引用文字稍浅一些 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

/* --- NEW: Beautified Video Call Screen Styles --- */
#video-call-screen {
    background-color: #333; /* 使用深色背景 */
    color: white;
    flex-direction: column;
    justify-content: space-between;
    position: relative; /* 为绝对定位的子元素提供容器 */
}

#video-call-screen .video-area {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* 使用对方的头像作为背景 */
    background-image: url(''); /* 这里先留空，JS会动态设置 */
    background-size: cover; /* 图片按比例缩放以覆盖整个容器 */
    background-position: center; /* 图片居中显示 */
    opacity: 0.6; /* 稍微调低透明度 */
    //filter: blur(10px); /* 可以保留一定的模糊效果 */
}

#video-call-screen .video-header {
    position: relative; /* 确保在内容流中，并高于背景 */
    z-index: 2;
    padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top));
    display: flex;
    align-items: center;
    gap: 12px;
    background: none; /* 移除背景，让模糊背景透出来 */
}

#video-call-screen .video-call-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

#video-call-screen .caller-info {
    display: flex;
    flex-direction: column;
}

#video-call-screen .caller-info h1 {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
    line-height: 1.2;
}

#video-call-screen .caller-info span {
    font-size: 14px;
    color: #eee;
}

#video-call-screen .pip-view {
    position: absolute;
    top: calc(60px + env(safe-area-inset-top)); /* 放在标题栏下方 */
    right: 20px;
    width: 100px;
    height: 150px;
    background-color: #444;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    background-size: cover;
    background-position: center;
    z-index: 2;
}

#video-call-screen .video-controls {
    position: relative; /* 确保在内容流中，并高于背景 */
    z-index: 2;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 30px;
    padding-bottom: calc(30px + env(safe-area-inset-bottom));
    background: none; /* 移除背景 */
}

#video-call-screen .video-control-btn {
    background: rgba(255, 255, 255, 0.15);
    border: none;
    border-radius: 50%;
    width: 64px; /* 增大按钮尺寸 */
    height: 64px;
    display: flex;
    flex-direction: column; /* 让文字在图标下方 */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    backdrop-filter: blur(10px);
    transition: background-color 0.2s ease;
}

#video-call-screen .video-control-btn:active {
    background-color: rgba(255, 255, 255, 0.3);
}

#video-call-screen .video-control-btn.toggled {
    background: white;
    color: black;
}

#video-call-screen .video-control-btn svg {
    width: 28px;
    height: 28px;
    fill: currentColor;
}

/* 挂断按钮的特殊样式 */
#video-call-screen .end-call-btn {
    background-color: #e53935;
    transform: scale(1.1); /* 让挂断按钮更突出 */
}
#video-call-screen .end-call-btn:active {
    background-color: #c42c28;
}

#video-call-screen .end-call-btn svg {
     transform: rotate(135deg);
}

/* --- NEW: Video Call Chat Log Styles --- */
#video-chat-log {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 85%;
    max-height: 40%;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-radius: 12px;
    padding: 10px;
    overflow-y: auto;
    display: none; /* 默认隐藏 */
    flex-direction: column;
    gap: 8px;
    color: white;
    font-size: 14px;
    z-index: 5;
    transition: opacity 0.3s ease;
}

#video-chat-log.visible {
    display: flex;
}

#video-chat-log .video-chat-message {
    padding: 6px 10px;
    border-radius: 8px;
    max-width: 80%;
    line-height: 1.4;
    word-wrap: break-word;
}

#video-chat-log .my-message {
    background-color: rgba(255, 255, 255, 0.25);
    align-self: flex-end;
    text-align: right;
}

#video-chat-log .their-message {
    background-color: rgba(0, 0, 0, 0.3);
    align-self: flex-start;
}

#video-chat-log .message-sender {
    font-weight: bold;
    font-size: 12px;
    opacity: 0.8;
    margin-bottom: 2px;
}
/* ▼▼▼ 请修改这一部分的CSS选择器 ▼▼▼ */
#voice-to-text-btn.toggled.recording { /* 这是修改后的选择器 */
    background-color: #e53935; /* 变成红色 */
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(229, 57, 53, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(229, 57, 53, 0); }
}
/* --- NEW: Group Video Call Grid Styles --- */
/* ▼▼▼ Use this new version to replace the old #group-video-grid style ▼▼▼ */
/* --- NEW: Group Video Call Grid Styles (Circular) --- */
#group-video-grid {
    position: absolute;
    top: calc(80px + env(safe-area-inset-top)); 
    left: 8px; 
    right: 8px; 
    bottom: calc(120px + env(safe-area-inset-bottom)); 
    display: grid;
    /* 修改点：减小了最小尺寸，让圆形窗口更小 */
    grid-template-columns: repeat(auto-fit, minmax(75px, 1fr)); 
    /* 修改点：增大了间距，避免圆形靠太近 */
    gap: 15px; 
    padding: 10px; 
    overflow-y: auto;
    z-index: 1;
    display: none; 
}

.participant-tile {
    position: relative;
    width: 100%;
    /* 修改点：将宽高比设为1/1，这是形成正圆形的基础 */
    aspect-ratio: 1 / 1;
    /* 修改点：将圆角设置为50%，使其变为圆形 */
    border-radius: 50%;
    overflow: hidden;
    background-color: #444;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.participant-avatar {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.participant-name {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 10px 6px 6px;
    background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
    color: white;
    font-size: 13px;
    font-weight: 500;
    text-align: center;
    text-shadow: 0 1px 2px black;
}
/* --- NEW: Outgoing Call Screen Styles --- */
#outgoing-call-screen {
    background-color: #313131; /* 深色背景 */
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    padding: 80px 20px 60px;
    color: white;
    text-align: center;
}

#outgoing-call-screen .caller-info-container {
    display: flex;
    flex-direction: column;
    align-items: center;
}

#outgoing-call-screen .avatar {
    width: 110px;
    height: 110px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 25px;
}

#outgoing-call-screen h1 {
    font-size: 26px;
    font-weight: 500;
    margin: 0;
}

#outgoing-call-screen p {
    font-size: 16px;
    color: #a8a8a8;
    margin-top: 10px;
}

#outgoing-call-screen .call-controls-container {
    width: 100%;
}

#outgoing-call-screen .control-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto; /* 居中 */
}

#outgoing-call-screen .control-btn.hang-up {
    background-color: #e53935;
}

#outgoing-call-screen .control-btn svg {
    width: 35px;
    height: 35px;
    fill: white;
    transform: rotate(135deg);
}
#outgoing-call-screen .call-controls-container {
    width: 100%;
    max-width: 250px; /* 限制按钮容器宽度 */
    margin: 0 auto;
}
#incoming-controls {
    display: flex;
    justify-content: space-between;
    width: 100%;
}
.control-btn.reject {
    background-color: #e53935;
}
.control-btn.accept {
    background-color: #4caf50;
}
.control-btn.reject svg {
    transform: rotate(135deg);
}

#edit-preset-modal .avatar-preview {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--primary-color);
}
/* --- NEW: Avatar Library Styles --- */
#avatar-library-grid {
    max-height: 50vh;
    overflow-y: auto;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
    padding: 10px;
    background-color: #f5f5f5;
    border-radius: 10px;
}

.avatar-library-item {
    position: relative;
    cursor: pointer;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    aspect-ratio: 1 / 1; /* 保持正方形 */
}

.avatar-library-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 0.2s ease;
}

.avatar-library-item:hover img {
    transform: scale(1.1);
}

.delete-avatar-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 20px;
    height: 20px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 14px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.avatar-library-item:hover .delete-avatar-btn {
    opacity: 1;
}
#avatar-library-modal {
    z-index: 102;
}
#group-avatar-library-modal {
    z-index: 102;
}
    </style>
</head>

<body>
<div class="phone-screen">
    <div id="home-screen" class="screen active"></div>
    <div id="chat-list-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">聊天</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="create-group-btn">群聊</button>
                <button class="action-btn" id="add-chat-btn">+</button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="chat-list-container"></ul>
            <div class="placeholder-text" id="no-chats-placeholder" style="display: none;">
                <p>还没有聊天对象哦~</p>
                <p>点击右上角的“+”创建一个吧！</p>
            </div>
        </main>
    </div>
    <div id="chat-room-screen" class="screen">
        <header class="app-header" id="chat-room-header-default">
            <button class="back-btn" data-target="chat-list-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="chat-room-title">...</h1>
                <div class="subtitle" id="chat-room-subtitle">
                    <div class="online-indicator"></div>
                    <span id="chat-room-status-text">在线</span>
                </div>
            </div>
            <button class="action-btn" id="chat-settings-btn"><img src="https://i.postimg.cc/nhwP4pQy/chan-73.png"
                                                                   alt="设置"></button>
        </header>
        <header class="app-header" id="chat-room-header-select" style="display: none;">
            <button class="action-btn" id="cancel-multi-select-btn">取消</button>
            <div class="title-container">
                <h1 class="title" id="multi-select-title">选择消息</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <div class="message-area" id="message-area"></div>
            <div class="typing-indicator" id="typing-indicator"></div>
        </main>
        <div class="chat-input-wrapper">
    <div id="reply-preview-bar">
        <div class="reply-preview-content">
            <div class="reply-preview-sender" id="reply-preview-sender"></div>
            <div class="reply-preview-text" id="reply-preview-text"></div>
        </div>
        <button id="cancel-reply-btn" class="icon-btn">&times;</button>
    </div>

    <div id="sticker-bar">
        <button class="sticker-bar-btn" id="sticker-toggle-btn">
            <svg viewBox="0 0 24 24">
                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"></path>
            </svg>
        </button>
        <button class="sticker-bar-btn" id="photo-video-btn">
            <svg viewBox="0 0 24 24">
                <path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"></path>
            </svg>
        </button>
        <button class="sticker-bar-btn" id="image-recognition-btn">
            <svg viewBox="0 0 24 24">
                <path d="M21.58,16.09L19.66,18L18.24,16.58L21,13.83C21.39,13.44 22,13.44 22.39,13.83L23.17,14.61C23.56,15 23.56,15.64 23.17,16.03L21.58,17.62M20.13,12.25L18.71,13.66L20.41,15.36L21.83,13.94L20.13,12.25M5.93,19H5C3.9,19 3,18.1 3,17V5C3,3.9 3.9,3 5,3H19C20.1,3 21,3.9 21,5V11.08L19,13.08V5H5V17H5.93L13.5,9.43L16.29,12.21L12.08,16.42L5.93,19Z"></path>
            </svg>
        </button>
        <button class="sticker-bar-btn" id="voice-message-btn">
            <svg viewBox="0 0 24 24">
                <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"></path>
            </svg>
        </button>
        <button class="sticker-bar-btn" id="wallet-btn">
            <svg viewBox="0 0 24 24">
                <path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 18H4V8H20V18ZM4 6H20V6H4Z"></path>
            </svg>
        </button>
        <button class="sticker-bar-btn" id="gift-btn">
            <svg viewBox="0 0 24 24">
                <path d="M20,8L12,13L4,8V6H20M20,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4M12.5,18C12.5,17.29 12.17,16.65 11.64,16.27C12.17,15.89 12.5,15.26 12.5,14.55C12.5,13.6 11.83,12.79 11,12.58V12H13V10H11V8H13V6H11V5C11,4.45 10.55,4 10,4H8C7.45,4 7,4.45 7,5V6H9V8H7V10H9V12H7V12.58C6.17,12.79 5.5,13.6 5.5,14.55C5.5,15.26 5.83,15.89 6.36,16.27C5.83,16.65 5.5,17.29 5.5,18H12.5Z"></path>
            </svg>
        </button>
        <button class="sticker-bar-btn" id="time-skip-btn">
            <svg viewBox="0 0 24 24">
                <path d="M4 5v14l7-7-7-7zm9 0v14l7-7-7-7z"></path>
            </svg>
        </button>
<button class="sticker-bar-btn" id="video-call-btn">
    <svg viewBox="0 0 24 24">
        <path d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z"></path>
    </svg>
</button>
    </div>

    <div class="message-input-area" id="message-input-default">
        <input type="text" id="message-input" placeholder="输入消息...">
        <button id="send-message-btn" class="icon-btn send-btn">➤</button>
        <button id="get-reply-btn" class="icon-btn">
            <svg viewBox="0 0 24 24">
                <path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z"></path>
            </svg>
        </button>
    </div>

    <div class="message-input-area" id="message-edit-bar" style="display: none;">
        <input type="text" id="message-edit-input">
        <button id="save-edit-btn" class="icon-btn send-btn">✓</button>
        <button id="cancel-edit-btn" class="icon-btn" style="background-color: #aaa;">✗</button>
    </div>
</div>
        <div id="multi-select-bar"><span id="select-count">已选择 0 项</span>
            <button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">删除已选
            </button>
        </div>
        <div id="sticker-modal">
            <div class="header"><span>我的表情</span>
                <div class="action-btn-group" style="display: flex; gap: 8px; align-items: stretch;">
                    <button class="btn btn-primary btn-small" id="batch-import-sticker-btn">批量导入</button>
                    <button class="btn btn-primary btn-small" id="add-new-sticker-btn">添加新表情</button>
                </div>
            </div>
            <div class="sticker-grid" id="sticker-grid-container"></div>
        </div>
    </div>
    <div id="world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">世界书</h1>
            </div>
            <button class="action-btn" id="add-world-book-btn">+</button>
        </header>
        <main class="content">
            <ul class="list-container" id="world-book-list-container"></ul>
            <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">
                <p>你的世界一片混沌...</p>
                <p>点击右上角的“+”创造第一个设定吧！</p>
            </div>
        </main>
    </div>
    <div id="edit-world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="world-book-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="edit-world-book-title">创建/编辑条目</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <form id="edit-world-book-form">
                <input type="hidden" id="world-book-id">
                <div class="form-group">
                    <label for="world-book-name">条目名称</label>
                    <input type="text" id="world-book-name" placeholder="例如：世界观背景、魔法体系" required>
                </div>
                <div class="form-group">
                    <label for="world-book-content">条目内容</label>
                    <textarea id="world-book-content" rows="8" placeholder="详细描述此项设定..." required></textarea>
                </div>
                <div class="form-group">
                    <label>注入位置</label>
                    <div class="form-group radio-group">
                        <label><input type="radio" name="world-book-position" value="before" checked> 前</label>
                        <label><input type="radio" name="world-book-position" value="after"> 后</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">保存条目</button>
            </form>
        </main>
    </div>
    <div id="api-settings-screen" class="screen"></div>
    <div id="wallpaper-screen" class="screen"></div>
    <div id="font-settings-screen" class="screen"></div>
    <div id="customize-screen" class="screen"></div>
    <div id="tutorial-screen" class="screen"></div>

    <div id="outgoing-call-screen" class="screen">
        <div class="caller-info-container">
            <img src="" alt="Avatar" id="outgoing-call-avatar" class="avatar">
            <h1 id="outgoing-call-name">...</h1>
            <p id="outgoing-call-status">...</p>
        </div>
        <div class="call-controls-container">
            <div id="outgoing-controls">
                <button class="control-btn hang-up" id="cancel-call-btn">
                    <svg viewBox="0 0 24 24"><path d="M12,9C10.4,9 8.85,9.25 7.4,9.72V12.82C7.4,13.22 7.17,13.56 6.84,13.72C5.86,14.21 4.97,14.84 4.19,15.57C4,15.75 3.75,15.86 3.5,15.86C3.2,15.86 2.95,15.74 2.77,15.56L0.29,13.08C0.11,12.9 0,12.65 0,12.38C0,12.1 0.11,11.85 0.29,11.67C3.38,8.59 7.5,7 12,7C16.5,7 20.62,8.59 23.71,11.67C23.89,11.85 24,12.1 24,12.38C24,12.65 23.89,12.9 23.71,13.08L21.23,15.56C21.05,15.74 20.8,15.86 20.5,15.86C20.25,15.86 20,15.75 19.81,15.57C19.03,14.84 18.14,14.21 17.16,13.72C16.83,13.56 16.6,13.22 16.6,12.82V9.72C15.15,9.25 13.6,9 12,9Z"></path></svg>
                </button>
            </div>
            <div id="incoming-controls" style="display: none;">
                 <button class="control-btn reject" id="reject-call-btn">
                    <svg viewBox="0 0 24 24"><path d="M12,9C10.4,9 8.85,9.25 7.4,9.72V12.82C7.4,13.22 7.17,13.56 6.84,13.72C5.86,14.21 4.97,14.84 4.19,15.57C4,15.75 3.75,15.86 3.5,15.86C3.2,15.86 2.95,15.74 2.77,15.56L0.29,13.08C0.11,12.9 0,12.65 0,12.38C0,12.1 0.11,11.85 0.29,11.67C3.38,8.59 7.5,7 12,7C16.5,7 20.62,8.59 23.71,11.67C23.89,11.85 24,12.1 24,12.38C24,12.65 23.89,12.9 23.71,13.08L21.23,15.56C21.05,15.74 20.8,15.86 20.5,15.86C20.25,15.86 20,15.75 19.81,15.57C19.03,14.84 18.14,14.21 17.16,13.72C16.83,13.56 16.6,13.22 16.6,12.82V9.72C15.15,9.25 13.6,9 12,9Z"></path></svg>
                 </button>
                 <button class="control-btn accept" id="accept-call-btn">
                    <svg viewBox="0 0 24 24"><path d="M16.6,12.82V9.72C15.15,9.25 13.6,9 12,9C10.4,9 8.85,9.25 7.4,9.72V12.82C7.4,13.22 7.17,13.56 6.84,13.72C5.86,14.21 4.97,14.84 4.19,15.57L6.29,17.67C6.88,17.08 7.56,16.57 8.28,16.17C8.6,16 8.8,15.65 8.8,15.28V12.44C9.92,12.15 10.95,12 12,12C13.05,12 14.08,12.15 15.2,12.44V15.28C15.2,15.65 15.4,16 15.72,16.17C16.44,16.57 17.12,17.08 17.71,17.67L19.81,15.57C19.03,14.84 18.14,14.21 17.16,13.72C16.83,13.56 16.6,13.22 16.6,12.82Z"></path></svg>
                 </button>
            </div>
        </div>
    </div>
<div id="video-call-screen" class="screen">
        <div class="video-header">
            <img src="" alt="Avatar" id="video-call-avatar" class="video-call-avatar">
            <div class="caller-info">
                <h1 id="video-call-name">...</h1>
                <span id="video-call-timer">正在连接...</span>
            </div>
        </div>

        <div class="video-area" id="video-area-bg"></div>
        <div class="pip-view" id="pip-view-bg"></div>

        <div id="group-video-grid"></div>

        <div id="video-chat-log">
            </div>

        <div class="video-controls">
            <button class="video-control-btn" id="voice-to-text-btn">
                <svg viewBox="0 0 24 24"><path d="M12,4A3,3 0 0,0 9,7V13A3,3 0 0,0 12,16A3,3 0 0,0 15,13V7A3,3 0 0,0 12,4M17,13A5,5 0 0,1 12,18A5,5 0 0,1 7,13H5A7,7 0 0,0 12,20A7,7 0 0,0 19,13H17Z"></path></svg>
            </button>
            <button class="video-control-btn end-call-btn" id="end-call-btn">
                <svg viewBox="0 0 24 24"><path d="M12,9C10.4,9 8.85,9.25 7.4,9.72V12.82C7.4,13.22 7.17,13.56 6.84,13.72C5.86,14.21 4.97,14.84 4.19,15.57C4,15.75 3.75,15.86 3.5,15.86C3.2,15.86 2.95,15.74 2.77,15.56L0.29,13.08C0.11,12.9 0,12.65 0,12.38C0,12.1 0.11,11.85 0.29,11.67C3.38,8.59 7.5,7 12,7C16.5,7 20.62,8.59 23.71,11.67C23.89,11.85 24,12.1 24,12.38C24,12.65 23.89,12.9 23.71,13.08L21.23,15.56C21.05,15.74 20.8,15.86 20.5,15.86C20.25,15.86 20,15.75 19.81,15.57C19.03,14.84 18.14,14.21 17.16,13.72C16.83,13.56 16.6,13.22 16.6,12.82V9.72C15.15,9.25 13.6,9 12,9Z"></path></svg>
            </button>
             <button class="video-control-btn" id="chat-message-btn">
                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></svg>
            </button>
        </div>
    </div>
<!-- ▲▲▲ 替换结束 ▲▲▲ -->
    <div id="toast-notification" class="toast"></div>
    <input type="file" id="image-upload-input" accept="image/*" style="display:none;">
    <div id="add-char-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建新角色</h3>
            <form id="add-char-form">
                <div class="form-group">
                    <label for="char-real-name">角色姓名</label><input type="text" id="char-real-name"
                                                                       placeholder="角色的真实姓名" required>
                </div>
                <div class="form-group">
                    <label for="char-remark-name">角色备注 (昵称)</label><input type="text" id="char-remark-name"
                                                                                placeholder="你对Ta的称呼" required>
                </div>
                <div class="form-group">
                    <label for="my-name-for-char">我的姓名</label><input type="text" id="my-name-for-char"
                                                                         placeholder="你希望Ta如何称呼你" required>
                </div>
                <button type="submit" class="btn btn-primary">创建</button>
            </form>
        </div>
    </div>
    <div id="add-sticker-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="add-sticker-modal-title">添加新表情</h3>
            <form id="add-sticker-form"><input type="hidden" id="sticker-edit-id">
                <div id="sticker-preview"><span>预览</span></div>
                <div class="form-group"><label for="sticker-name">表情名称</label><input type="text" id="sticker-name"
                                                                                         placeholder="如：开心" required>
                </div>
                <div class="form-group"><label for="sticker-url-input">表情URL</label><input type="url"
                                                                                             id="sticker-url-input"
                                                                                             placeholder="粘贴图片URL">
                </div>
                <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p><input type="file"
                                                                                             id="sticker-file-upload"
                                                                                             accept="image/*"
                                                                                             style="display:none;"><label
                        for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    <div id="sticker-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="edit-sticker-btn">编辑</button>
            <button class="action-sheet-button danger" id="delete-sticker-btn">删除</button>
        </div>
    </div>
    <div id="send-voice-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>发送语音消息</h3>
            <form id="send-voice-form">
                <div class="form-group">
                    <label for="voice-text-input">输入语音文字</label>
                    <textarea id="voice-text-input" placeholder="在这里输入你想说的话..." required rows="4"></textarea>
                </div>
                <div class="form-group" style="text-align:center; color:#888; font-size: 14px;">
                    预计时长: <span id="voice-duration-preview">0"</span>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-pv-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>分享照片/视频</h3>
            <form id="send-pv-form">
                <div class="form-group">
                    <label for="pv-text-input">输入描述</label>
                    <textarea id="pv-text-input" placeholder="在这里描述你的照片或视频内容..." required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-transfer-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>转账</h3>
            <form id="send-transfer-form">
                <div class="form-group">
                    <label for="transfer-amount-input">金额 (元)</label>
                    <input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01" min="0.01">
                </div>
                <div class="form-group">
                    <label for="transfer-remark-input">备注</label>
                    <input type="text" id="transfer-remark-input" placeholder="（选填）">
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-gift-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>送出礼物</h3>
            <form id="send-gift-form">
                <div class="form-group">
                    <label for="gift-description-input">礼物描述</label>
                    <textarea id="gift-description-input" placeholder="告诉Ta你送了什么特别的东西..." required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- NEW: Time Skip Modal -->
    <div id="time-skip-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>记录今天发生的事</h3>
            <form id="time-skip-form">
                <div class="form-group">
                    <label for="time-skip-input">事件描述 (该消息AI可见，会作为上下文)</label>
                    <textarea id="time-skip-input" placeholder="例如：我们一起去山顶看了日落，然后吃了烧烤。" required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- NEW: Group Recipient Selection Modal -->
    <div id="group-recipient-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="group-recipient-selection-title">选择收件人</h3>
            <ul id="group-recipient-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-group-recipient-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <div id="receive-transfer-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="accept-transfer-btn">接收</button>
            <button class="action-sheet-button danger" id="return-transfer-btn">退回</button>
        </div>
    </div>
    <!-- Private Chat Settings -->
    <div id="chat-settings-sidebar" class="settings-sidebar">
        <div class="header">聊天设置</div>
        <div class="content">
            <form id="chat-settings-form">
                <div class="avatar-setting">
    <img src="" alt="角色头像" id="setting-char-avatar-preview" class="avatar-preview">
    <input type="file" id="setting-char-avatar-upload" accept="image/*" style="display:none;">
    <div style="flex-grow: 1; display: flex; flex-direction: column; gap: 8px;">
        <label for="setting-char-avatar-upload" class="btn btn-primary">直接更换</label>
        <button type="button" class="btn btn-secondary" id="manage-avatar-library-btn">头像库</button>
    </div>
</div>
                <div class="form-group"><label for="setting-char-remark">角色备注 (昵称)</label><input type="text"
                                                                                                       id="setting-char-remark">
                </div>
                <div class="form-group"><label for="setting-char-persona">角色人设</label><textarea
                        id="setting-char-persona" placeholder="详细描述角色的性格、背景、说话风格等。"></textarea></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting"><img src="" alt="我的头像" id="setting-my-avatar-preview"
                                                 class="avatar-preview"><input type="file" id="setting-my-avatar-upload"
                                                                               accept="image/*"
                                                                               style="display:none;"><label
                        for="setting-my-avatar-upload" class="btn btn-secondary"
                        style="flex-grow:1;">更换我的头像</label></div>
                <div class="form-group"><label for="setting-my-name">我的姓名</label><input type="text"
                                                                                            id="setting-my-name"></div>
                <div class="form-group"><label for="setting-my-persona">我的人设</label><textarea
                        id="setting-my-persona" placeholder="描述你希望在对话中扮演的形象。"></textarea></div>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">

                <div class="form-group">
                    <label for="setting-my-preset">我的预设库</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="setting-my-preset" style="flex-grow: 1;"></select>
                        <button type="button" class="btn btn-secondary btn-small" id="manage-presets-btn">管理</button>
                    </div>
                    <button type="button" class="btn btn-neutral" id="save-current-as-preset-btn" style="margin-top: 10px; width: 100%;">将当前设定存为新预设</button>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button>
                </div>    
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group"><label for="setting-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-use-custom-css" style="width: auto;">
                    </div>
                    <div id="private-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                </div>

                <div class="form-group"><label for="setting-max-memory">最大记忆轮数</label><input type="number"
                                                                                                   id="setting-max-memory"
                                                                                                   value="10" min="1">
                </div>
                <div class="form-group"><label for="setting-chat-bg-upload" class="btn btn-primary">更换聊天背景</label><input
                        type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;"></div>
                <button type="submit" class="btn btn-primary">保存设置</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-chat-history-btn">清空聊天记录</button>
        </div>
    </div>
    <div id="world-book-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择要关联的世界书</h3>
            <ul id="world-book-selection-list"></ul>
            <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <!-- Group Chat Creation Modal -->
    <div id="create-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建群聊</h3>
            <form id="create-group-form">
                <div class="form-group">
                    <label>选择群成员</label>
                    <ul id="member-selection-list" class="member-selection-list"></ul>
                </div>
                <div class="form-group">
                    <label for="group-name-input">群聊名称</label>
                    <input type="text" id="group-name-input" placeholder="给你的群聊起个名字吧" required>
                </div>
                <button type="submit" class="btn btn-primary">创建群聊</button>
            </form>
        </div>
    </div>
    <!-- Group Chat Settings -->
    <div id="group-settings-sidebar" class="settings-sidebar">
        <div class="header">群聊设置</div>
        <div class="content">
            <form id="group-settings-form">
<div class="group-avatar-setting">
    <img src="" alt="群头像" id="setting-group-avatar-preview" class="group-avatar-preview">
    <input type="file" id="setting-group-avatar-upload" accept="image/*" style="display:none;">
    <div style="flex-grow: 1; display: flex; flex-direction: column; gap: 8px;">
        <label for="setting-group-avatar-upload" class="btn btn-primary">直接更换</label>
        <button type="button" class="btn btn-secondary" id="manage-group-avatar-library-btn">头像库</button>
    </div>
</div>
                <div class="form-group">
                    <label for="setting-group-name">群名 (AI也可见)</label>
                    <input type="text" id="setting-group-name">
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting">
                    <img src="" alt="我的头像" id="setting-group-my-avatar-preview" class="avatar-preview">
                    <input type="file" id="setting-group-my-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-my-avatar-upload" class="btn btn-secondary"
                           style="flex-grow:1;">更换我的头像</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-my-nickname">我的群昵称</label>
                    <input type="text" id="setting-group-my-nickname">
                </div>
                <div class="form-group">
                    <label for="setting-group-my-persona">我的人设</label>
                    <textarea id="setting-group-my-persona" placeholder="描述你希望在此群聊中扮演的形象。"></textarea>
                </div>
<hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">

                <div class="form-group">
                    <label for="setting-group-my-preset">我的预设库</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="setting-group-my-preset" style="flex-grow: 1;"></select>
                        <button type="button" class="btn btn-secondary btn-small" id="manage-group-presets-btn">管理</button>
                    </div>
                    <button type="button" class="btn btn-neutral" id="save-current-group-as-preset-btn" style="margin-top: 10px; width: 100%;">将当前设定存为新预设</button>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-group-world-book-btn">关联世界书</button>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <label>群成员</label>
                    <div class="group-members-list" id="group-members-list-container"></div>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-group-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group"><label for="setting-group-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-group-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-group-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-group-use-custom-css" style="width: auto;">
                    </div>
                    <div id="group-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-group-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-group-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                </div>

                <div class="form-group"><label for="setting-group-max-memory">最大记忆轮数</label><input type="number"
                                                                                                         id="setting-group-max-memory"
                                                                                                         value="10"
                                                                                                         min="1"></div>
                <div class="form-group"><label for="setting-group-chat-bg-upload"
                                               class="btn btn-primary">更换聊天背景</label><input type="file"
                                                                                                  id="setting-group-chat-bg-upload"
                                                                                                  accept="image/*"
                                                                                                  style="display:none;">
                </div>
                <button type="submit" class="btn btn-primary">保存设置</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-group-chat-history-btn">清空聊天记录</button>
        </div>
    </div>
    <!-- Group Member Edit Modal -->
    <div id="edit-group-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="edit-group-member-title">编辑群成员</h3>
            <form id="edit-group-member-form">
                <input type="hidden" id="editing-member-id">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="" alt="成员头像" id="edit-member-avatar-preview" class="avatar-preview"
                         style="cursor: pointer;">
                    <input type="file" id="edit-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="edit-member-group-nickname">群昵称</label>
                    <input type="text" id="edit-member-group-nickname" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-real-name">真名</label>
                    <input type="text" id="edit-member-real-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-persona">人设</label>
                    <textarea id="edit-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    <!-- Add Member to Group Action Sheet -->
    <div id="add-member-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="invite-existing-member-btn">邀请现有角色</button>
            <button class="action-sheet-button" id="create-new-member-btn">创建新角色入群</button>
        </div>
    </div>
    <!-- Invite Existing Member Modal -->
    <div id="invite-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>邀请成员加入群聊</h3>
            <ul id="invite-member-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-invite-btn" style="margin-top: 20px;">确认邀请</button>
        </div>
    </div>
    <!-- Create New Member for Group Modal -->
    <div id="create-member-for-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建新角色并加入群聊</h3>
            <form id="create-member-for-group-form">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="新成员头像"
                         id="create-group-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                    <input type="file" id="create-group-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="create-group-member-nickname">群昵称</label>
                    <input type="text" id="create-group-member-nickname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-realname">真名</label>
                    <input type="text" id="create-group-member-realname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-persona">人设</label>
                    <textarea id="create-group-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">创建并加入</button>
            </form>
        </div>
    </div>
</div>
<input type="file" id="import-data-input" accept=".ee" style="display: none;">
<div id="batch-import-sticker-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>批量导入表情包</h3>
            <form id="batch-import-sticker-form">
                <div class="form-group">
                    <label for="batch-import-text">粘贴文本</label>
                    <textarea id="batch-import-text" rows="8" placeholder="格式示例：\nhttps://.../链接代码\n表情名1 图片名1.jpg\n表情名2 图片名2.png"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">开始导入</button>
            </form>
        </div>
    </div>
<div id="preset-library-modal" class="modal-overlay" style="z-index: 102;">
    <div class="modal-window">
        <h3>管理我的预设</h3>
        <ul id="preset-manager-list" class="list-container" style="max-height: 50vh; overflow-y: auto; margin-bottom: 20px;">
            </ul>
        <button type="button" class="btn btn-primary" id="add-new-preset-btn">新建预设</button>
    </div>
</div>

<div id="edit-preset-modal" class="modal-overlay" style="z-index: 103;">
    <div class="modal-window">
        <h3 id="edit-preset-modal-title">创建新预设</h3>
        <form id="edit-preset-form">
            <input type="hidden" id="editing-preset-id">
            <div class="form-group">
                <label for="preset-name">预设名称</label>
                <input type="text" id="preset-name" placeholder="为这个预设起个名字" required>
            </div>
             <div class="avatar-setting" style="justify-content: center; margin-bottom: 15px;">
                <img src="https://i.postimg.cc/GtbTnxhP/o-o-1.jpg" alt="我的头像" id="preset-my-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                <input type="file" id="preset-my-avatar-upload" accept="image/*" style="display:none;">
            </div>
            <div class="form-group">
                <label for="preset-my-name">我的姓名</label>
                <input type="text" id="preset-my-name" placeholder="你希望Ta如何称呼你">
            </div>
            <div class="form-group">
                <label for="preset-my-persona">我的人设</label>
                <textarea id="preset-my-persona" rows="4" placeholder="描述你希望在对话中扮演的形象。"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">保存预设</button>
        </form>
    </div>
</div>
<script>

    // gemini如果是多个密钥, 那么随机获取一个
    function getRandomValue(str) {
        // 检查字符串是否包含逗号
        if (str.includes(',')) {
            // 用逗号分隔字符串并移除多余空格
            const arr = str.split(',').map(item => item.trim());
            // 生成随机索引 (0 到 arr.length-1)
            const randomIndex = Math.floor(Math.random() * arr.length);
            // 返回随机元素
            return arr[randomIndex];
        }
        // 没有逗号则直接返回原字符串
        return str;
    }

    document.addEventListener('DOMContentLoaded', () => {
        async function compressImage(file, options = {}) {
            const {
                quality = 0.8, maxWidth = 800, maxHeight = 800
            } = options;

            // --- 新增：处理GIF动图 ---
            // 如果文件是GIF，则不经过canvas压缩，直接返回原始文件数据以保留动画
            if (file.type === 'image/gif') {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            // --- 对其他静态图片（如PNG, JPG）进行压缩 ---
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onerror = reject;
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onerror = reject;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * (maxWidth / width));
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * (maxHeight / height));
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');

                        // 对于有透明背景的PNG图片，先填充一个白色背景
                        // 这样可以防止透明区域在转换成JPEG时变黑
                        if (file.type === 'image/png') {
                            ctx.fillStyle = '#FFFFFF'; // 白色背景
                            ctx.fillRect(0, 0, width, height);
                        }

                        ctx.drawImage(img, 0, 0, width, height);

                        // --- 关键修正：将输出格式改为 'image/jpeg' ---
                        // JPEG格式可以显著减小文件大小，避免浏览器处理超大Base64字符串时崩溃
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataUrl);
                    };
                };
            });
        }

        // --- Initial HTML Injection ---
// ▼▼▼ 使用这个新版本替换旧的 api-settings-screen.innerHTML ▼▼▼
document.getElementById('api-settings-screen').innerHTML = `
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">‹</button>
        <div class="title-container"><h1 class="title">API 设置</h1></div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <form id="api-form">

            <div style="background-color: #fff8fa; padding: 15px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #fce4ec;">
                <h3 style="text-align: center; color: var(--primary-color); margin-top: 0;">主聊天API</h3>
                <p style="font-size: 12px; text-align: center; color: #888; margin-top: -10px; margin-bottom: 20px;">用于日常聊天，建议使用性能强的模型</p>
                <div class="form-group">
                    <label for="api-provider-primary">API 服务商</label>
                    <select id="api-provider-primary" name="provider-primary"><option value="newapi">NewAPI (自定义)</option><option value="deepseek">DeepSeek</option><option value="claude">Claude</option><option value="gemini">Gemini</option></select>
                </div>
                <div class="form-group">
                    <label for="api-url-primary">API 地址</label>
                    <input type="url" id="api-url-primary" name="url-primary" placeholder="选择服务商可自动填写" required>
                </div>
                <div class="form-group">
                    <label for="api-key-primary">密钥 (Key)</label>
                    <input type="password" id="api-key-primary" name="key-primary" placeholder="请输入主API密钥" required>
                </div>
                <button type="button" class="btn btn-secondary" id="fetch-models-btn-primary"><span class="btn-text">拉取主模型</span><div class="spinner"></div></button>
                <div class="form-group">
                    <label for="api-model-primary">选择主模型</label>
                    <select id="api-model-primary" name="model-primary" required><option value="">请先拉取模型列表</option></select>
                </div>
            </div>

            <div style="background-color: #f7f9ff; padding: 15px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e0e7ff;">
                <h3 style="text-align: center; color: var(--accent-color); margin-top: 0;">副视觉API (用于头像分析)</h3>
                <p style="font-size: 12px; text-align: center; color: #888; margin-top: -10px; margin-bottom: 20px;">用于头像识图，建议使用经济的Vision模型</p>
                <div class="form-group">
                    <label for="api-provider-vision">API 服务商</label>
                    <select id="api-provider-vision" name="provider-vision"><option value="newapi">NewAPI (自定义)</option><option value="deepseek">DeepSeek</option><option value="claude">Claude</option><option value="gemini">Gemini</option></select>
                </div>
                <div class="form-group">
                    <label for="api-url-vision">API 地址</label>
                    <input type="url" id="api-url-vision" name="url-vision" placeholder="选择服务商可自动填写">
                </div>
                <div class="form-group">
                    <label for="api-key-vision">密钥 (Key)</label>
                    <input type="password" id="api-key-vision" name="key-vision" placeholder="请输入视觉API密钥">
                </div>
                <button type="button" class="btn btn-secondary" id="fetch-models-btn-vision"><span class="btn-text">拉取视觉模型</span><div class="spinner"></div></button>
                <div class="form-group">
                    <label for="api-model-vision">选择视觉模型</label>
                    <select id="api-model-vision" name="model-vision"><option value="">请先拉取模型列表</option></select>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" id="save-btn"><span class="btn-text">全部保存</span><div class="spinner"></div></button>
        </form>
    </main>
`;
        document.getElementById('wallpaper-screen').innerHTML = `
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container"><h1 class="title">更换壁纸</h1></div>
                <div class="placeholder"></div>
            </header>
            <main class="content">
                <div class="wallpaper-preview" id="wallpaper-preview"><span>当前壁纸预览</span></div>
                <input type="file" id="wallpaper-upload" accept="image/*" style="display: none;">
                <label for="wallpaper-upload" class="btn btn-primary">从相册选择新壁纸</label>
                <button type="button" class="btn btn-neutral" id="reset-wallpaper-btn" style="margin-top: 15px;">恢复默认壁纸</button>
            </main>`;
        document.getElementById('font-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">字体设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="font-settings-form"><div class="form-group"><label for="font-url">字体链接 (ttf, woff, woff2)</label><input type="url" id="font-url" placeholder="https://.../font.ttf" required></div><p style="font-size:12px; color:#888; text-align:center;">示例: https://lf3-static.bytednsdoc.com/obj/eden-cn/jplptk/ljhwZthlaukjlkulzlp/portal/fonts/HarmonyOS_Sans_SC_Regular.woff2</p><button type="submit" class="btn btn-primary">应用字体</button><button type="button" class="btn btn-neutral" id="restore-default-font-btn" style="margin-top: 15px;">恢复默认字体</button></form></main>`;
document.getElementById('customize-screen').innerHTML = `
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container"><h1 class="title">主屏幕与全局美化</h1></div>
                <div class="placeholder"></div>
            </header>
            <main class="content">
                <form id="customize-form">
                    </form>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">

                <div class="form-group">
                    <label for="global-custom-css">全局自定义CSS</label>
                    <textarea id="global-custom-css" rows="8" placeholder="在此输入CSS代码以美化整个应用..."></textarea>
                </div>

                <input type="file" id="import-css-input" accept=".css" style="display: none;">
                <label for="import-css-input" class="btn btn-secondary">导入 CSS 文件</label>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">

                <button type="button" class="btn btn-danger" id="reset-all-customization-btn">重置所有美化设置</button>
            </main>`;
        document.getElementById('tutorial-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">教程</h1></div><div class="placeholder"></div></header><main class="content" id="tutorial-content-area"></main>`;

        // --- Global Variables and Constants ---
        const colorThemes = {
            'white_pink': {
                name: '白/粉',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(255,204,204,0.9)', text: '#A56767'}
            },
            'white_blue': {
                name: '白/蓝',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A'}
            },
            'white_yellow': {
                name: '白/黄',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(249,237,105,0.9)', text: '#8B7E4B'}
            },
            'white_green': {
                name: '白/绿',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(188,238,188,0.9)', text: '#4F784F'}
            },
            'white_purple': {
                name: '白/紫',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B'}
            },
            'black_red': {
                name: '黑/红',
                received: {bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0'},
                sent: {bg: 'rgb(226,62,87,0.9)', text: '#fff'}
            },
            'black_green': {
                name: '黑/绿',
                received: {bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0'},
                sent: {bg: 'rgba(119,221,119,0.9)', text: '#2E5C2E'}
            },
            'black_white': {
                name: '黑/白',
                received: {bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0'},
                sent: {bg: 'rgba(245,245,245,0.9)', text: '#333'}
            },
            'white_black': {
                name: '白/黑',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(50,50,50,0.85)', text: '#F5F5F5'}
            },
            'yellow_purple': {
                name: '黄/紫',
                received: {bg: 'rgba(255,250,205,0.9)', text: '#8B7E4B'},
                sent: {bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B'}
            },
            'pink_blue': {
                name: '粉/蓝',
                received: {bg: 'rgba(255,231,240,0.9)', text: '#7C6770'},
                sent: {bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A'}
            },
        };
        const defaultIcons = {
            'chat-list-screen': {name: '404', url: 'https://i.postimg.cc/VvQB8dQT/chan-143.png'},
            'api-settings-screen': {name: 'api', url: 'https://i.postimg.cc/50FqT8GL/chan-125.png'},
            'wallpaper-screen': {name: '壁纸', url: 'https://i.postimg.cc/3wqFttL3/chan-90.png'},
            'world-book-screen': {name: '世界书', url: 'https://i.postimg.cc/prCWkrKT/chan-74.png'},
            'customize-screen': {name: '自定义', url: 'https://i.postimg.cc/vZVdC7gt/chan-133.png'},
            'font-settings-screen': {name: '字体', url: 'https://i.postimg.cc/FzVtC0x4/chan-21.png'},
            'tutorial-screen': {name: '教程', url: 'https://i.postimg.cc/6QgNzCFf/chan-118.png'},
            'day-mode-btn': {name: '', url: 'https://i.postimg.cc/Jz0tYqnT/chan-145.png'},
            'night-mode-btn': {name: '', url: 'https://i.postimg.cc/htYvkdQK/chan-146.png'}
        };

      let db = {
            characters: [],
            groups: [],
            apiSettings: {},
            wallpaper: 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg',
            myStickers: [],
            homeScreenMode: 'night',
            worldBooks: [],
            fontUrl: '',
            customIcons: {},
            globalCustomCss: '' // 新增：用于存储全局自定义CSS
        };
        let currentChatId = null, currentChatType = null, isGenerating = false, longPressTimer = null,
            isInMultiSelectMode = false, editingMessageId = null, currentPage = 1, currentTransferMessageId = null,
            currentEditingWorldBookId = null, currentStickerActionTarget = null,
            currentGroupAction = {type: null, recipients: []},
            currentReplyToId = null,
            videoCallTimerInterval = null, videoCallSeconds = 0; // 整合了新的视频通话变量
            currentVideoCallContext = [], // [新增] 用于存储进入通话时的主聊天上下文
            isGeneratingVideoReply = false; // [新增] 用于防止在视频通话中重复请求AI
        let selectedMessageIds = new Set();
        const MESSAGES_PER_PAGE = 50;

        // --- DOM Element Cache ---
        const screens = document.querySelectorAll('.screen'),
            toastElement = document.getElementById('toast-notification'),
            homeScreen = document.getElementById('home-screen'),
            chatListContainer = document.getElementById('chat-list-container'),
            noChatsPlaceholder = document.getElementById('no-chats-placeholder'),
            addChatBtn = document.getElementById('add-chat-btn'),
            addCharModal = document.getElementById('add-char-modal'),
            addCharForm = document.getElementById('add-char-form'),
            chatRoomScreen = document.getElementById('chat-room-screen'),
            chatRoomHeaderDefault = document.getElementById('chat-room-header-default'),
            chatRoomHeaderSelect = document.getElementById('chat-room-header-select'),
            cancelMultiSelectBtn = document.getElementById('cancel-multi-select-btn'),
            multiSelectTitle = document.getElementById('multi-select-title'),
            chatRoomTitle = document.getElementById('chat-room-title'),
            chatRoomStatusText = document.getElementById('chat-room-status-text'),
            messageArea = document.getElementById('message-area'),
            messageInputDefault = document.getElementById('message-input-default'),
            messageInput = document.getElementById('message-input'),
            sendMessageBtn = document.getElementById('send-message-btn'),
            getReplyBtn = document.getElementById('get-reply-btn'),
            typingIndicator = document.getElementById('typing-indicator'),
            chatSettingsBtn = document.getElementById('chat-settings-btn'),
            settingsSidebar = document.getElementById('chat-settings-sidebar'),
            settingsForm = document.getElementById('chat-settings-form'),
            messageEditBar = document.getElementById('message-edit-bar'),
            messageEditInput = document.getElementById('message-edit-input'),
            saveEditBtn = document.getElementById('save-edit-btn'),
            cancelEditBtn = document.getElementById('cancel-edit-btn'),
            multiSelectBar = document.getElementById('multi-select-bar'),
            selectCount = document.getElementById('select-count'),
            deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const stickerToggleBtn = document.getElementById('sticker-toggle-btn'),
            stickerModal = document.getElementById('sticker-modal'),
            stickerGridContainer = document.getElementById('sticker-grid-container'),
            addNewStickerBtn = document.getElementById('add-new-sticker-btn'),
            addStickerModal = document.getElementById('add-sticker-modal'),
            addStickerModalTitle = document.getElementById('add-sticker-modal-title'),
            addStickerForm = document.getElementById('add-sticker-form'),
            stickerEditIdInput = document.getElementById('sticker-edit-id'),
            stickerPreview = document.getElementById('sticker-preview'),
            stickerNameInput = document.getElementById('sticker-name'),
            stickerUrlInput = document.getElementById('sticker-url-input'),
            stickerFileUpload = document.getElementById('sticker-file-upload');
        const stickerActionSheet = document.getElementById('sticker-actionsheet'),
            editStickerBtn = document.getElementById('edit-sticker-btn'),
            deleteStickerBtn = document.getElementById('delete-sticker-btn');
        const voiceMessageBtn = document.getElementById('voice-message-btn'),
            sendVoiceModal = document.getElementById('send-voice-modal'),
            sendVoiceForm = document.getElementById('send-voice-form'),
            voiceTextInput = document.getElementById('voice-text-input'),
            voiceDurationPreview = document.getElementById('voice-duration-preview');
        const photoVideoBtn = document.getElementById('photo-video-btn'),
            sendPvModal = document.getElementById('send-pv-modal'),
            sendPvForm = document.getElementById('send-pv-form'),
            pvTextInput = document.getElementById('pv-text-input');
        const imageRecognitionBtn = document.getElementById('image-recognition-btn'),
            imageUploadInput = document.getElementById('image-upload-input');
        const walletBtn = document.getElementById('wallet-btn'),
            sendTransferModal = document.getElementById('send-transfer-modal'),
            sendTransferForm = document.getElementById('send-transfer-form'),
            transferAmountInput = document.getElementById('transfer-amount-input'),
            transferRemarkInput = document.getElementById('transfer-remark-input');
        const receiveTransferActionSheet = document.getElementById('receive-transfer-actionsheet'),
            acceptTransferBtn = document.getElementById('accept-transfer-btn'),
            returnTransferBtn = document.getElementById('return-transfer-btn');
        const giftBtn = document.getElementById('gift-btn'), sendGiftModal = document.getElementById('send-gift-modal'),
            sendGiftForm = document.getElementById('send-gift-form'),
            giftDescriptionInput = document.getElementById('gift-description-input');
        const timeSkipBtn = document.getElementById('time-skip-btn'),
            timeSkipModal = document.getElementById('time-skip-modal'),
            timeSkipForm = document.getElementById('time-skip-form'),
            timeSkipInput = document.getElementById('time-skip-input');
        const clearChatHistoryBtn = document.getElementById('clear-chat-history-btn');
        const worldBookListContainer = document.getElementById('world-book-list-container'),
            noWorldBooksPlaceholder = document.getElementById('no-world-books-placeholder'),
            addWorldBookBtn = document.getElementById('add-world-book-btn'),
            editWorldBookScreen = document.getElementById('edit-world-book-screen'),
            editWorldBookForm = document.getElementById('edit-world-book-form'),
            worldBookIdInput = document.getElementById('world-book-id'),
            worldBookNameInput = document.getElementById('world-book-name'),
            worldBookContentInput = document.getElementById('world-book-content');
        const linkWorldBookBtn = document.getElementById('link-world-book-btn'),
            worldBookSelectionModal = document.getElementById('world-book-selection-modal'),
            worldBookSelectionList = document.getElementById('world-book-selection-list'),
            saveWorldBookSelectionBtn = document.getElementById('save-world-book-selection-btn');
        const fontSettingsForm = document.getElementById('font-settings-form'),
            fontUrlInput = document.getElementById('font-url'),
            restoreDefaultFontBtn = document.getElementById('restore-default-font-btn');
        const createGroupBtn = document.getElementById('create-group-btn'),
            createGroupModal = document.getElementById('create-group-modal'),
            createGroupForm = document.getElementById('create-group-form'),
            memberSelectionList = document.getElementById('member-selection-list'),
            groupNameInput = document.getElementById('group-name-input'),
            groupSettingsSidebar = document.getElementById('group-settings-sidebar'),
            groupSettingsForm = document.getElementById('group-settings-form'),
            groupMembersListContainer = document.getElementById('group-members-list-container'),
            editGroupMemberModal = document.getElementById('edit-group-member-modal'),
            editGroupMemberForm = document.getElementById('edit-group-member-form');
        const addMemberActionSheet = document.getElementById('add-member-actionsheet'),
            inviteExistingMemberBtn = document.getElementById('invite-existing-member-btn'),
            createNewMemberBtn = document.getElementById('create-new-member-btn'),
            inviteMemberModal = document.getElementById('invite-member-modal'),
            inviteMemberSelectionList = document.getElementById('invite-member-selection-list'),
            confirmInviteBtn = document.getElementById('confirm-invite-btn'),
            createMemberForGroupModal = document.getElementById('create-member-for-group-modal'),
            createMemberForGroupForm = document.getElementById('create-member-for-group-form');
        const customizeForm = document.getElementById('customize-form'),
            tutorialContentArea = document.getElementById('tutorial-content-area');
        const groupRecipientSelectionModal = document.getElementById('group-recipient-selection-modal'),
            groupRecipientSelectionList = document.getElementById('group-recipient-selection-list'),
            confirmGroupRecipientBtn = document.getElementById('confirm-group-recipient-btn'),
            groupRecipientSelectionTitle = document.getElementById('group-recipient-selection-title');
        const linkGroupWorldBookBtn = document.getElementById('link-group-world-book-btn');
            // ▼▼▼ 从这里开始，添加以下4行 ▼▼▼
            replyPreviewBar = document.getElementById('reply-preview-bar'),
            replyPreviewSender = document.getElementById('reply-preview-sender'),
            replyPreviewText = document.getElementById('reply-preview-text'),
            cancelReplyBtn = document.getElementById('cancel-reply-btn');
        // --- Utility and Core Functions ---
        class DataStorage {
            constructor() {
                // 创建数据库
                this.db = new Dexie('章鱼喷墨机DB');

                // 定义数据库结构
                this.db.version(1).stores({
                    storage: 'key, value, timestamp' // key作为主键，value存储数据，timestamp记录时间
                });
            }

            // 保存数据 - 类似 localStorage.setItem
            async saveData(key, data) {
                try {
                    const item = {
                        key: key,
                        value: JSON.stringify(data), // 将数据序列化
                        timestamp: Date.now()
                    };

                    await this.db.storage.put(item);
                    console.log(`数据已保存: ${key}`);
                    return true;
                } catch (error) {
                    console.error('保存数据失败:', error);
                    return false;
                }
            }

            // 获取数据 - 类似 localStorage.getItem
            async getData(key) {
                try {
                    const item = await this.db.storage.get(key);

                    if (item) {
                        return JSON.parse(item.value); // 反序列化数据
                    } else {
                        console.log(`未找到数据: ${key}`);
                        return null;
                    }
                } catch (error) {
                    console.error('获取数据失败:', error);
                    return null;
                }
            }

            // 删除数据
            async removeData(key) {
                try {
                    await this.db.storage.delete(key);
                    console.log(`数据已删除: ${key}`);
                    return true;
                } catch (error) {
                    console.error('删除数据失败:', error);
                    return false;
                }
            }

            // 清空所有数据
            async clearAll() {
                try {
                    await this.db.storage.clear();
                    console.log('所有数据已清空');
                    return true;
                } catch (error) {
                    console.error('清空数据失败:', error);
                    return false;
                }
            }

            // 获取所有键名
            async getAllKeys() {
                try {
                    const items = await this.db.storage.toArray();
                    return items.map(item => item.key);
                } catch (error) {
                    console.error('获取键名失败:', error);
                    return [];
                }
            }

            // 获取数据库大小信息
            async getStorageInfo() {
                try {
                    const items = await this.db.storage.toArray();
                    const totalSize = items.reduce((sum, item) => sum + item.value.length, 0);

                    return {
                        itemCount: items.length,
                        totalSize: totalSize,
                        items: items.map(item => ({
                            key: item.key,
                            size: item.value.length,
                            timestamp: new Date(item.timestamp).toLocaleString()
                        }))
                    };
                } catch (error) {
                    console.error('获取存储信息失败:', error);
                    return null;
                }
            }
        }

        const dataStorage = new DataStorage();


        const saveData = async (data) => {
            await dataStorage.saveData('章鱼喷墨机', data ? data : db);
            return Promise.resolve();
        };
        const loadData = async () => {
            const oldData = localStorage.getItem('gemini-chat-app-db');
            let data = await dataStorage.getData('章鱼喷墨机')
            if (oldData) {
                await saveData(JSON.parse(oldData))
                data = await dataStorage.getData('章鱼喷墨机')
                localStorage.removeItem('gemini-chat-app-db');
            }
            if (data) db = data;
            // ▼▼▼ 使用这个新版本替换旧的 apiSettings 初始化逻辑 ▼▼▼
if (!db.apiSettings || !db.apiSettings.primary) {
    // 如果apiSettings不存在, 或者内部没有primary结构, 说明是旧数据或新安装
    const oldSettings = db.apiSettings || {};
    db.apiSettings = {
        primary: {
            provider: oldSettings.provider || 'newapi',
            url: oldSettings.url || '',
            key: oldSettings.key || '',
            model: oldSettings.model || ''
        },
        vision: { // 初始化一个空的vision设置
            provider: 'newapi',
            url: '',
            key: '',
            model: ''
        }
    };
}
// ▲▲▲ 替换结束 ▲▲▲
            if (!db.wallpaper) db.wallpaper = 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg';
            if (!db.characters) db.characters = [];
            if (!db.groups) db.groups = [];
            if (!db.myStickers) db.myStickers = [];
            if (!db.homeScreenMode) db.homeScreenMode = 'night';
            if (!db.worldBooks) db.worldBooks = [];
            if (!db.fontUrl) db.fontUrl = '';
            if (!db.customIcons) db.customIcons = {};
            if (!db.globalCustomCss) db.globalCustomCss = ''; // 新增：初始化全局CSS字段
            if (!db.userPresets) db.userPresets = [];
db.characters.forEach(c => {
    if (c.isPinned === undefined) c.isPinned = false;
    if (c.status === undefined) c.status = '在线';
    if (!c.worldBookIds) c.worldBookIds = [];
    if (c.customBubbleCss === undefined) c.customBubbleCss = '';
    if (c.useCustomBubbleCss === undefined) c.useCustomBubbleCss = false;

    // --- 核心修改在这里 ---
    if (!c.avatarLibrary) {
        c.avatarLibrary = [];
    } else if (c.avatarLibrary.length > 0 && typeof c.avatarLibrary[0] === 'string') {
        // 如果是旧的字符串数组格式, 转换为新的对象数组格式
        console.log(`Converting old avatar library for character: ${c.remarkName}`);
        c.avatarLibrary = c.avatarLibrary.map(url => ({
            url: url,
            description: '待分析的旧头像' // 给一个默认描述
        }));
    }
    // --- 修改结束 ---
});
// ▼▼▼ 使用这个新版本替换旧的 db.groups.forEach 循环 ▼▼▼
db.groups.forEach(g => {
    if (g.isPinned === undefined) g.isPinned = false;
    if (!g.worldBookIds) g.worldBookIds = [];
    if (g.customBubbleCss === undefined) g.customBubbleCss = '';
    if (g.useCustomBubbleCss === undefined) g.useCustomBubbleCss = false;

    // --- 新增的数据迁移逻辑 ---
    if (!g.avatarLibrary) {
        g.avatarLibrary = [];
    } else if (g.avatarLibrary.length > 0 && typeof g.avatarLibrary[0] === 'string') {
        g.avatarLibrary = g.avatarLibrary.map(url => ({
            url: url,
            description: '待分析的旧群头像'
        }));
    }
    // --- 新增结束 ---
});
// ▲▲▲ 替换结束 ▲▲▲

            return Promise.resolve()
        };
        const showToast = (message) => {
            toastElement.textContent = message;
            toastElement.classList.add('show');
            setTimeout(() => toastElement.classList.remove('show'), 3000);
        };
        const switchScreen = (targetId) => {
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(targetId)?.classList.add('active');
            // Close all overlays and sidebars
            const overlays = document.querySelectorAll('.modal-overlay, .action-sheet-overlay, .settings-sidebar');
            overlays.forEach(o => o.classList.remove('visible', 'open'));
        };
        const pad = (num) => num.toString().padStart(2, '0');

        function createContextMenu(items, x, y) {
            removeContextMenu();
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            items.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'context-menu-item';
                if (item.danger) menuItem.classList.add('danger');
                menuItem.textContent = item.label;
                menuItem.onclick = () => {
                    item.action();
                    removeContextMenu();
                };
                menu.appendChild(menuItem);
            });
            document.body.appendChild(menu);
            document.addEventListener('click', removeContextMenu, {once: true});
        }

        function removeContextMenu() {
            const menu = document.querySelector('.context-menu');
            if (menu) menu.remove();
        }

        function updateCustomBubbleStyle(chatId, css, enabled) {
            const styleId = `custom-bubble-style-for-${chatId}`;
            let styleElement = document.getElementById(styleId);

            if (enabled && css) {
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = styleId;
                    document.head.appendChild(styleElement);
                }
                const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#chat-room-screen.chat-active-${chatId} $1`);
                styleElement.innerHTML = scopedCss;
            } else {
                if (styleElement) styleElement.remove();
            }
        }

        function updateBubbleCssPreview(previewContainer, css, useDefault, theme) {
            previewContainer.innerHTML = '';

            const sentBubble = document.createElement('div');
            sentBubble.className = 'message-bubble sent';
            sentBubble.textContent = '这是我方气泡。';
            sentBubble.style.alignSelf = 'flex-end';
            sentBubble.style.borderBottomRightRadius = '5px';

            const receivedBubble = document.createElement('div');
            receivedBubble.className = 'message-bubble received';
            receivedBubble.textContent = '这是对方气泡。';
            receivedBubble.style.alignSelf = 'flex-start';
            receivedBubble.style.borderBottomLeftRadius = '5px';

            [sentBubble, receivedBubble].forEach(bubble => {
                bubble.style.maxWidth = '70%';
                bubble.style.padding = '8px 12px';
                bubble.style.wordWrap = 'break-word';
                bubble.style.lineHeight = '1.4';
            });

            if (useDefault || !css) {
                sentBubble.style.backgroundColor = theme.sent.bg;
                sentBubble.style.color = theme.sent.text;
                sentBubble.style.borderRadius = '18px';
                sentBubble.style.borderBottomRightRadius = '5px';
                receivedBubble.style.backgroundColor = theme.received.bg;
                receivedBubble.style.color = theme.received.text;
                receivedBubble.style.borderRadius = '18px';
                receivedBubble.style.borderBottomLeftRadius = '5px';
            } else {
                const styleTag = document.createElement('style');
                const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#${previewContainer.id} $1`);
                styleTag.textContent = scopedCss;
                previewContainer.appendChild(styleTag);
            }
            previewContainer.appendChild(receivedBubble);
            previewContainer.appendChild(sentBubble);
        }

                const init = async () => {
            await loadData();
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('.context-menu')) {
                    e.stopPropagation();
                    return;
                }
                removeContextMenu();

                const backBtn = e.target.closest('.back-btn');
                if (backBtn) {
                    e.preventDefault();
                    switchScreen(backBtn.getAttribute('data-target'));
                }

                // Consolidated overlay closing logic
                const openOverlay = document.querySelector('.modal-overlay.visible, .action-sheet-overlay.visible');
                if (openOverlay && e.target === openOverlay) {
                    openOverlay.classList.remove('visible');
                }
            });

            // Specific nav links that switch screens
            document.body.addEventListener('click', e => {
                const navLink = e.target.closest('.app-icon[data-target]');
                if (navLink) {
                    e.preventDefault();
                    switchScreen(navLink.getAttribute('data-target'));
                }
            });

            updateClock();
            setInterval(updateClock, 30000);
            applyGlobalFont(db.fontUrl);
            applyGlobalCustomCss(db.globalCustomCss); // 新增：应用全局自定义CSS
            setupHomeScreen();
            setupChatListScreen();
            setupAddCharModal();
            setupChatRoom();
            setupChatSettings();
            setupApiSettingsApp();
            setupWallpaperApp();
            setupStickerSystem();
            setupVoiceMessageSystem();
            setupPhotoVideoSystem();
            setupImageRecognition();
            setupWalletSystem();
            setupGiftSystem();
            setupTimeSkipSystem();
            setupWorldBookApp();
            setupFontSettingsApp();
            setupGroupChatSystem();
            setupCustomizeApp();
            setupTutorialApp();
            setupVideoCallSystem();
            setupVideoLogModal(); // <-- 这是您上次添加的
           document.getElementById('cancel-call-btn').addEventListener('click', () => {
             // 简单的返回聊天界面逻辑
             switchScreen('chat-room-screen');
             addSystemNotificationToChat('通话已取消');
             isRequestingVideoCall = false; // 重置呼叫状态
        });
        // ▼▼▼ 在这里添加新代码 ▼▼▼
        document.getElementById('accept-call-btn').addEventListener('click', () => {
            startVideoCall();
        });
        document.getElementById('reject-call-btn').addEventListener('click', () => {
            switchScreen('chat-room-screen');
            addSystemNotificationToChat('已拒接通话');
            // 可以在这里添加一条 system message 发给AI，告诉它你拒绝了
        });
        // ▲▲▲ 添加结束 ▲▲▲
            // ▼▼▼ 把代码移动到这里！▼▼▼
            window.showVideoChatLogModal = showVideoChatLogModal;
        };

        function updateClock() {
            const now = new Date();
            const timeDisplay = document.getElementById('time-display');
            const dateDisplay = document.getElementById('date-display');
            if (timeDisplay) timeDisplay.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            if (dateDisplay) dateDisplay.textContent = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日`;
        }

        // --- App Setup Functions ---
        function setupHomeScreen() {
            const getIcon = (id) => db.customIcons[id] || defaultIcons[id].url;
            const homeScreenHTML = `
            <div class="time-widget"><div class="time" id="time-display"></div><div class="date" id="date-display"></div></div>
            <div class="app-grid">
                <a href="#" class="app-icon" data-target="chat-list-screen"><img src="${getIcon('chat-list-screen')}" alt="404" class="icon-img"><span class="app-name">${defaultIcons['chat-list-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="api-settings-screen"><img src="${getIcon('api-settings-screen')}" alt="API" class="icon-img"><span class="app-name">${defaultIcons['api-settings-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="wallpaper-screen"><img src="${getIcon('wallpaper-screen')}" alt="Wallpaper" class="icon-img"><span class="app-name">${defaultIcons['wallpaper-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="world-book-screen"><img src="${getIcon('world-book-screen')}" alt="World Book" class="icon-img"><span class="app-name">${defaultIcons['world-book-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="customize-screen"><img src="${getIcon('customize-screen')}" alt="Customize" class="icon-img"><span class="app-name">${defaultIcons['customize-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="tutorial-screen"><img src="${getIcon('tutorial-screen')}" alt="Tutorial" class="icon-img"><span class="app-name">${defaultIcons['tutorial-screen'].name}</span></a>
            </div>
            <div class="dock">
                <a href="#" class="app-icon" id="day-mode-btn"><img src="${getIcon('day-mode-btn')}" alt="日间" class="icon-img"></a>
                <a href="#" class="app-icon" id="night-mode-btn"><img src="${getIcon('night-mode-btn')}" alt="夜间" class="icon-img"></a>
                <a href="#" class="app-icon" data-target="font-settings-screen"><img src="${getIcon('font-settings-screen')}" alt="字体" class="icon-img"></a>
            </div>`;
            homeScreen.innerHTML = homeScreenHTML;
            updateClock();
            applyWallpaper(db.wallpaper);
            applyHomeScreenMode(db.homeScreenMode);
            document.getElementById('day-mode-btn')?.addEventListener('click', (e) => {
                e.preventDefault();
                applyHomeScreenMode('day');
            });
            document.getElementById('night-mode-btn')?.addEventListener('click', (e) => {
                e.preventDefault();
                applyHomeScreenMode('night');
            });
            document.querySelector('[data-target="world-book-screen"]').addEventListener('click', renderWorldBookList);
            document.querySelector('[data-target="customize-screen"]').addEventListener('click', renderCustomizeForm);
            document.querySelector('[data-target="tutorial-screen"]').addEventListener('click', renderTutorialContent);
        }

        function applyWallpaper(url) {
            homeScreen.style.backgroundImage = `url(${url})`;
        }

        async function applyHomeScreenMode(mode) {
            if (mode === 'day') {
                homeScreen.classList.add('day-mode');
            } else {
                homeScreen.classList.remove('day-mode');
            }
            db.homeScreenMode = mode;
            await saveData();
        }

function setupCustomizeApp() {
            const mainContent = document.querySelector('#customize-screen .content');
            if (!mainContent) return;

            // 使用事件委托处理所有输入和点击事件
            mainContent.addEventListener('input', async (e) => {
                // 处理图标URL输入
                if (e.target.matches('#customize-form input[type="url"]')) {
                    const iconId = e.target.dataset.id;
                    const newUrl = e.target.value.trim();
                    const previewImg = document.getElementById(`icon-preview-${iconId}`);
                    if (newUrl) {
                        db.customIcons[iconId] = newUrl;
                        if (previewImg) previewImg.src = newUrl;
                    } else {
                        delete db.customIcons[iconId]; // 如果清空输入，则删除自定义
                        if (previewImg) previewImg.src = defaultIcons[iconId].url;
                    }
                    // 使用防抖保存数据
                    clearTimeout(saveData.debounceIcon);
                    saveData.debounceIcon = setTimeout(() => {
                        saveData();
                        setupHomeScreen(); // 只有在保存后才更新主屏幕
                    }, 500);
                }

                // 处理全局CSS文本域输入
                if (e.target.matches('#global-custom-css')) {
                    const newCss = e.target.value;
                    db.globalCustomCss = newCss;
                    applyGlobalCustomCss(newCss);
                    // 使用防抖保存数据
                    clearTimeout(saveData.debounceCss);
                    saveData.debounceCss = setTimeout(() => saveData(), 500);
                }
            });

            mainContent.addEventListener('click', async (e) => {
                // 处理单个图标重置按钮
                if (e.target.matches('.reset-icon-btn')) {
                    const iconId = e.target.dataset.id;
                    delete db.customIcons[iconId];
                    await saveData();
                    renderCustomizeForm(); // 重新渲染表单
                    setupHomeScreen();    // 重新渲染主屏幕
                    showToast('图标已重置');
                }

                // 处理重置按钮 (仅重置图标和CSS)
                if (e.target.matches('#reset-all-customization-btn')) {
                    if (confirm('确定要重置所有主屏幕图标和全局自定义CSS吗？此操作不可恢复。')) {
                        // 重置数据
                        db.customIcons = {};
                        db.globalCustomCss = '';

                        // 将重置应用到界面
                        applyGlobalCustomCss('');

                        // 重新渲染受影响的组件
                        setupHomeScreen();
                        renderCustomizeForm(); // 这将清空所有输入框

                        // 保存并通知用户
                        await saveData();
                        showToast('主屏幕图标和全局CSS已重置。');
                    }
                }
            });

            // 处理CSS文件导入
            const importCssInput = document.getElementById('import-css-input');
            if (importCssInput) {
                importCssInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const cssContent = event.target.result;
                        const globalCssTextarea = document.getElementById('global-custom-css');
                        if (globalCssTextarea) {
                            globalCssTextarea.value = cssContent;
                        }
                        db.globalCustomCss = cssContent;
                        applyGlobalCustomCss(cssContent);
                        await saveData();
                        showToast('CSS 文件已成功导入并应用。');
                    };
                    reader.onerror = () => {
                        showToast('读取文件失败。');
                    };
                    reader.readAsText(file);

                    // 清空输入，以便可以再次选择同一个文件
                    e.target.value = null;
                });
            }
        }

        function renderCustomizeForm() {
            customizeForm.innerHTML = ''; // 清空旧的图标列表
            Object.entries(defaultIcons).forEach(([id, {name, url}]) => {
                const currentIcon = db.customIcons[id] || url;
                const itemHTML = `
                <div class="icon-custom-item">
                    <img src="${currentIcon}" alt="${name}" class="icon-preview" id="icon-preview-${id}">
                    <div class="icon-details">
                        <p>${name || '模式切换'}</p>
                        <input type="url" class="form-group" placeholder="粘贴新的图标URL" value="${db.customIcons[id] || ''}" data-id="${id}">
                    </div>
                    <button type="button" class="reset-icon-btn" data-id="${id}">重置</button>
                </div>`;
                customizeForm.insertAdjacentHTML('beforeend', itemHTML);
            });

            // 新增：填充全局CSS文本框
            const globalCssTextarea = document.getElementById('global-custom-css');
            if (globalCssTextarea) {
                globalCssTextarea.value = db.globalCustomCss || '';
            }
        }

        function setupTutorialApp() {
            tutorialContentArea.addEventListener('click', (e) => {
                const header = e.target.closest('.tutorial-header');
                if (header) {
                    header.parentElement.classList.toggle('open');
                }
            });
        }
        let loadingBtn = false

        function renderTutorialContent() {
            const tutorials = [
                {title: '写在前面', imageUrls: ['https://i.postimg.cc/7PgyMG9S/image.jpg']},
                {
                    title: '软件介绍',
                    imageUrls: ['https://i.postimg.cc/VvsJRh6q/IMG-20250713-162647.jpg', 'https://i.postimg.cc/8P5FfxxD/IMG-20250713-162702.jpg', 'https://i.postimg.cc/3r94R3Sn/IMG-20250713-162712.jpg']
                },
                {
                    title: '404',
                    imageUrls: ['https://i.postimg.cc/x8scFPJW/IMG-20250713-162756.jpg', 'https://i.postimg.cc/pX6mfqtj/IMG-20250713-162809.jpg', 'https://i.postimg.cc/YScjV00q/IMG-20250713-162819.jpg', 'https://i.postimg.cc/13VfJw9j/IMG-20250713-162828.jpg']
                },
                {title: '404-群聊', imageUrls: ['https://i.postimg.cc/X7LSmRTJ/404.jpg']}
            ];
            tutorialContentArea.innerHTML = '';
            tutorials.forEach(tutorial => {
                const item = document.createElement('div');
                item.className = 'tutorial-item';
                const imagesHtml = tutorial.imageUrls.map(url => `<img src="${url}" alt="${tutorial.title}教程图片">`).join('');
                item.innerHTML = `<div class="tutorial-header">${tutorial.title}</div><div class="tutorial-content">${imagesHtml}</div>`;
                tutorialContentArea.appendChild(item);
            });

            const backupDataBtn = document.createElement('button');
            backupDataBtn.className = 'btn btn-primary';
            backupDataBtn.textContent = '备份数据';
            backupDataBtn.disabled = loadingBtn

            backupDataBtn.addEventListener('click', async () => {
                if(loadingBtn){
                    return
                }
                loadingBtn = true
                try {
                    const jsonString = JSON.stringify(db);
                    const dataBlob = new Blob([jsonString]);

                    // Compress the data using Gzip
                    const compressionStream = new CompressionStream('gzip');
                    const compressedStream = dataBlob.stream().pipeThrough(compressionStream);
                    const compressedBlob = await new Response(compressedStream).blob();

                    const url = URL.createObjectURL(compressedBlob);
                    const a = document.createElement('a');
                    const now = new Date();
                    const date = now.toISOString().slice(0, 10);
                    const time = now.toTimeString().slice(0, 8).replace(/:/g, '');
                    a.href = url;
                    a.download = `章鱼喷墨_备份数据_${date}_${time}.ee`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    loadingBtn = false
                    showToast('聊天记录导出成功');
                }catch (e){
                    showToast(`导出失败, 发生错误: ${e.message}`);
                }
            });
            const importDataBtn = document.createElement('label');
            importDataBtn.className = 'btn btn-neutral';
            importDataBtn.textContent = '导入数据';
            importDataBtn.style.marginTop = '15px'
            importDataBtn.style.display = 'block'
            importDataBtn.disabled = loadingBtn;
            importDataBtn.setAttribute('for', 'import-data-input')
            document.querySelector('#import-data-input').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if(confirm('此操作将覆盖当前所有聊天记录和设置。此操作不可撤销。确定要继续吗？')){
                    try {
                        // Decompress the file stream
                        const decompressionStream = new DecompressionStream('gzip');
                        const decompressedStream = file.stream().pipeThrough(decompressionStream);
                        const jsonString = await new Response(decompressedStream).text();

                        let data = JSON.parse(jsonString);
                        await saveData(data)
                        showToast(`数据已成功恢复。应用即将刷新。`);
                        window.location.reload();
                    } catch (error) {
                        console.error("导入失败:", error);
                        showToast(`解压或解析文件时发生错误: ${error.message}`);
                    } finally {
                        event.target.value = null;
                    }
                }else {
                    event.target.value = null;
                }

            })

            tutorialContentArea.appendChild(backupDataBtn);
            tutorialContentArea.appendChild(importDataBtn);
        }

        // --- Chat List & Chat Room ---
        function setupChatListScreen() {
            renderChatList();
            addChatBtn.addEventListener('click', () => {
                addCharModal.classList.add('visible');
                addCharForm.reset();
            });
            chatListContainer.addEventListener('click', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (chatItem) {
                    currentChatId = chatItem.dataset.id;
                    currentChatType = chatItem.dataset.type;
                    openChatRoom(currentChatId, currentChatType);
                }
            });
            chatListContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const chatItem = e.target.closest('.chat-item');
                if (!chatItem) return;
                handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, e.clientX, e.clientY);
            });
            chatListContainer.addEventListener('touchstart', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (!chatItem) return;
                longPressTimer = setTimeout(() => {
                    const touch = e.touches[0];
                    handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, touch.clientX, touch.clientY);
                }, 400);
            });
            chatListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
            chatListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
        }

        function handleChatListLongPress(chatId, chatType, x, y) {
            clearTimeout(longPressTimer);
            const chatItem = (chatType === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
            if (!chatItem) return;
            const itemName = chatType === 'private' ? chatItem.remarkName : chatItem.name;
            const menuItems = [{
                label: chatItem.isPinned ? '取消置顶' : '置顶聊天',
                action: async () => {
                    chatItem.isPinned = !chatItem.isPinned;
                    await saveData();
                    renderChatList();
                }
            }, {
                label: '删除聊天',
                danger: true,
                action: async () => {
                    if (confirm(`确定要删除与“${itemName}”的聊天记录吗？此操作不可恢复。`)) {
                        if (chatType === 'private') {
                            db.characters = db.characters.filter(c => c.id !== chatId);
                        } else {
                            db.groups = db.groups.filter(g => g.id !== chatId);
                        }
                        await saveData();
                        renderChatList();
                        showToast('聊天已删除');
                    }
                }
            }];
            createContextMenu(menuItems, x, y);
        }

function renderChatList() {
    chatListContainer.innerHTML = '';
    const allChats = [...db.characters.map(c => ({...c, type: 'private'})), ...db.groups.map(g => ({
        ...g,
        type: 'group'
    }))];
    noChatsPlaceholder.style.display = (db.characters.length + db.groups.length) === 0 ? 'block' : 'none';
    const sortedChats = allChats.sort((a, b) => {
        if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
        const lastMsgTimeA = a.history && a.history.length > 0 ? a.history[a.history.length - 1].timestamp : 0;
        const lastMsgTimeB = b.history && b.history.length > 0 ? b.history[b.history.length - 1].timestamp : 0;
        return lastMsgTimeB - lastMsgTimeA;
    });
    sortedChats.forEach(chat => {
        let lastMessageText = '开始聊天吧...';
        if (chat.history && chat.history.length > 0) {
            const invisibleRegex = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[.*?邀请.*?加入了群聊\]|\[.*?修改群名为：.*?\]|\[system-display:.*?\]/;
            const visibleHistory = chat.history.filter(msg => !invisibleRegex.test(msg.content));
            if (visibleHistory.length > 0) {
                const lastMsg = visibleHistory[visibleHistory.length - 1];
                const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;
                const imageRecogRegex = /\[.*?发来了一张图片：\]/
                const voiceRegex = /\[.*?的语音：.*?\]/;
                const photoVideoRegex = /\[.*?发来的照片\/视频：.*?\]/;
                const transferRegex = /\[.*?的转账：.*?元.*?\]|\[.*?给你转账：.*?元.*?\]|\[.*?向.*?转账：.*?元.*?\]/;
                const stickerRegex = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/;
                const giftRegex = /\[.*?送来的礼物：.*?\]|\[.*?向.*?送来了礼物：.*?\]/;
                const videoCallRegex = /\[videocall:ended:.*?\]/; // 新增：识别视频通话记录的规则

                if (videoCallRegex.test(lastMsg.content)) { // 新增：处理视频通话的判断
                    lastMessageText = '[视频通话]';
                } else if (giftRegex.test(lastMsg.content)) {
                    lastMessageText = '[礼物]';
                } else if (stickerRegex.test(lastMsg.content)) {
                    lastMessageText = '[表情包]';
                } else if (voiceRegex.test(lastMsg.content)) {
                    lastMessageText = '[语音]';
                } else if (photoVideoRegex.test(lastMsg.content)) {
                    lastMessageText = '[照片/视频]';
                } else if (transferRegex.test(lastMsg.content)) {
                    lastMessageText = '[转账]';
                } else if (imageRecogRegex.test(lastMsg.content) || (lastMsg.parts && lastMsg.parts.some(p => p.type === 'image'))) {
                    lastMessageText = '[图片]';
                }else if ((lastMsg.parts && lastMsg.parts.some(p => p.type === 'html'))) {
                    lastMessageText = '[互动]';
                } else {
                    const textMatch = lastMsg.content.match(/\[.*?的消息：([\s\S]+)\]/);
                    let text = textMatch ? textMatch[1].trim() : lastMsg.content.trim();
                    lastMessageText = urlRegex.test(text) ? '[图片]' : text;
                }
            } else {
                const lastEverMsg = chat.history[chat.history.length - 1];
                const inviteRegex = /\[(.*?)邀请(.*?)加入了群聊\]/;
                const renameRegex = /\[.*?修改群名为：.*?\]/;
                const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
                const timeSkipMatch = lastEverMsg.content.match(timeSkipRegex);

                if (timeSkipMatch) {
                    lastMessageText = timeSkipMatch[1];
                } else if (inviteRegex.test(lastEverMsg.content)) {
                    lastMessageText = '新成员加入了群聊';
                } else if (renameRegex.test(lastEverMsg.content)) {
                    lastMessageText = '群聊名称已修改';
                }
            }
        }
        const li = document.createElement('li');
        li.className = 'list-item chat-item';
        if (chat.isPinned) li.classList.add('pinned');
        li.dataset.id = chat.id;
        li.dataset.type = chat.type;
        const avatarClass = chat.type === 'group' ? 'group-avatar' : '';
        const itemName = chat.type === 'private' ? chat.remarkName : chat.name;
        const pinBadgeHTML = chat.isPinned ? '<span class="pin-badge">置顶</span>' : '';
        li.innerHTML = `
        <img src="${chat.avatar}" alt="${itemName}" class="chat-avatar ${avatarClass}">
        <div class="item-details">
            <div class="item-details-row"><div class="item-name">${itemName}</div></div>
            <div class="item-preview-wrapper"><div class="item-preview">${lastMessageText}</div>${pinBadgeHTML}</div>
        </div>`;
        chatListContainer.appendChild(li);
    });
}

        function setupAddCharModal() {
            addCharForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newChar = {
                    id: `char_${Date.now()}`,
                    realName: document.getElementById('char-real-name').value,
                    remarkName: document.getElementById('char-remark-name').value,
                    persona: '',
                    avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                    myName: document.getElementById('my-name-for-char').value,
                    myPersona: '',
                    myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
                    theme: 'white_pink',
                    maxMemory: 10,
                    chatBg: '',
                    history: [],
                    isPinned: false,
                    status: '在线',
                    worldBookIds: [],
                    useCustomBubbleCss: false,
                     avatarLibrary: [], // 添加这一行
                    customBubbleCss: ''
                };
                db.characters.push(newChar);
                await saveData();
                renderChatList();
                addCharModal.classList.remove('visible');
                showToast(`角色“${newChar.remarkName}”创建成功！`);
            });
        }

        function setupChatRoom() {
            sendMessageBtn.addEventListener('click', sendMessage);
            sendMessageBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                sendMessage();
                setTimeout(() => {
                    messageInput.focus();
                }, 50);
            });
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !isGenerating) sendMessage();
            });
            getReplyBtn.addEventListener('click', getAiReply);
            cancelReplyBtn.addEventListener('click', cancelReplyMode); // <--- 添加这一行
            messageArea.addEventListener('click', (e) => {
                // --- 修复开始: 增加关闭表情包面板的逻辑 ---
                if (stickerModal.classList.contains('visible')) {
                    stickerModal.classList.remove('visible');
                    // 阻止事件继续传播，避免立即触发其他点击效果
                    return;
                }
                // --- 修复结束 ---

                if (e.target && e.target.id === 'load-more-btn') {
                    loadMoreMessages();
                } else if (isInMultiSelectMode) {
                    const messageWrapper = e.target.closest('.message-wrapper');
                    if (messageWrapper) {
                        toggleMessageSelection(messageWrapper.dataset.id);
                    }
                } else {
                    const voiceBubble = e.target.closest('.voice-bubble');
                    if (voiceBubble) {
                        const transcript = voiceBubble.closest('.message-wrapper').querySelector('.voice-transcript');
                        if (transcript) {
                            transcript.classList.toggle('active');
                        }
                    }
                    const pvCard = e.target.closest('.pv-card');
                    if (pvCard) {
                        const imageOverlay = pvCard.querySelector('.pv-card-image-overlay');
                        const footer = pvCard.querySelector('.pv-card-footer');
                        imageOverlay.classList.toggle('hidden');
                        footer.classList.toggle('hidden');
                    }
                    const giftCard = e.target.closest('.gift-card');
                    if (giftCard) {
                        const description = giftCard.closest('.message-wrapper').querySelector('.gift-card-description');
                        if (description) {
                            description.classList.toggle('active');
                        }
                    }
                    const transferCard = e.target.closest('.transfer-card.received-transfer');
                    if (transferCard && currentChatType === 'private') {
                        const messageWrapper = transferCard.closest('.message-wrapper');
                        const messageId = messageWrapper.dataset.id;
                        const character = db.characters.find(c => c.id === currentChatId);
                        const message = character.history.find(m => m.id === messageId);
                        if (message && message.transferStatus === 'pending') {
                            handleReceivedTransferClick(messageId);
                        }
                    }
                }
            });
            messageArea.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (e.target.id === 'load-more-btn' || isInMultiSelectMode) return;
                const messageWrapper = e.target.closest('.message-wrapper');
                if (!messageWrapper) return;
                handleMessageLongPress(messageWrapper, e.clientX, e.clientY);
            });
            messageArea.addEventListener('touchstart', (e) => {
                if (e.target.id === 'load-more-btn') return;
                const messageWrapper = e.target.closest('.message-wrapper');
                if (!messageWrapper) return;
                longPressTimer = setTimeout(() => {
                    const touch = e.touches[0];
                    handleMessageLongPress(messageWrapper, touch.clientX, touch.clientY);
                }, 400);
            });
            messageArea.addEventListener('touchend', () => clearTimeout(longPressTimer));
            messageArea.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            saveEditBtn.addEventListener('click', saveMessageEdit);
            cancelEditBtn.addEventListener('click', cancelMessageEdit);
            cancelMultiSelectBtn.addEventListener('click', exitMultiSelectMode);
            deleteSelectedBtn.addEventListener('click', deleteSelectedMessages);
        }

        function handleMessageLongPress(messageWrapper, x, y) {
            if (isInMultiSelectMode) return;
            clearTimeout(longPressTimer);
            const messageId = messageWrapper.dataset.id;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const message = chat.history.find(m => m.id === messageId);
            if (!message) return;

            const isImageRecognitionMsg = message.parts && message.parts.some(p => p.type === 'image');
            const isVoiceMessage = /\[.*?的语音：.*?\]/.test(message.content);
            const isStickerMessage = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/.test(message.content);
            const isPhotoVideoMessage = /\[.*?发来的照片\/视频：.*?\]/.test(message.content);
            const isTransferMessage = /\[.*?给你转账：.*?\]|\[.*?的转账：.*?\]|\[.*?向.*?转账：.*?\]/.test(message.content);
            const isGiftMessage = /\[.*?送来的礼物：.*?\]|\[.*?向.*?送来了礼物：.*?\]/.test(message.content);
            const isInvisibleMessage = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[.*?邀请.*?加入了群聊\]|\[.*?修改群名为：.*?\]|\[system-display:.*?\]/.test(message.content);

            let menuItems = [];
            // ▼▼▼ 在这里添加新的代码 ▼▼▼
            if (!isInvisibleMessage) {
                menuItems.push({
                    label: '回复',
                    action: () => startReplyMode(messageId)
                });
            }
            // ▲▲▲ 添加结束 ▲▲▲
            if (!isImageRecognitionMsg && !isVoiceMessage && !isStickerMessage && !isPhotoVideoMessage && !isTransferMessage && !isGiftMessage && !isInvisibleMessage) {
                menuItems.push({label: '编辑', action: () => startMessageEdit(messageId)});
            }
            menuItems.push({label: '删除', action: () => enterMultiSelectMode(messageId)});

            if (menuItems.length > 0) {
                createContextMenu(menuItems, x, y);
            }
        }

         function getMessagePreviewText(message) {
            const content = message.content;

            // 优先匹配普通文本消息
            const textMatch = content.match(/\[(?:.+?)的消息：([\s\S]+?)\]/);
            if (textMatch) return textMatch[1].trim();
            
            // 匹配语音消息，并提取语音内容
            const voiceMatch = content.match(/\[.*?的语音：([\s\S]+?)\]/);
            if (voiceMatch) return `“${voiceMatch[1].trim()}”`;

            // 匹配照片/视频消息，并提取描述
            const photoVideoMatch = content.match(/\[.*?发来的照片\/视频：([\s\S]+?)\]/);
            if (photoVideoMatch) return `[照片] ${photoVideoMatch[1].trim()}`;

            // 匹配转账消息，并提取金额
            const transferMatch = content.match(/转账：([\d.]+)/);
            if (transferMatch) return `[转账] ¥${parseFloat(transferMatch[1]).toFixed(2)}`;

            // 匹配礼物消息，并提取礼物描述（兼容私聊和群聊格式）
            const giftMatch = content.match(/\[(?:.+?)(?:送来的礼物|向.+?送来了礼物)：([\s\S]+?)\]/);
            if (giftMatch) return `[礼物] ${giftMatch[1].trim()}`;

            // 匹配用户发送的表情包，并提取表情名称
            const stickerMatch = content.match(/\[.*?的表情包：([\s\S]+?)\]/);
            if (stickerMatch) return `[表情] ${stickerMatch[1].trim()}`;
            // 为AI发送的表情包提供通用描述
            if (/\[.*?发送的表情包：.*?\]/.test(content)) return '[表情包]'; 

            // 为图片识别功能发送的图片提供通用描述
            if (message.parts && message.parts.some(p => p.type === 'image')) return '[图片]';

            // 如果以上都不是，则作为普通文本进行截断
            return content.length > 50 ? content.substring(0, 50) + '...' : content;
        }

        // ▼▼▼ 使用新代码替换旧的 startReplyMode 函数 ▼▼▼
        function startReplyMode(messageId) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const message = chat.history.find(m => m.id === messageId);
            if (!message) return;

            currentReplyToId = messageId;
            
            const senderInfo = getSenderInfoForMessage(message);
            
            replyPreviewSender.textContent = `回复 ${senderInfo.name}`;
            replyPreviewText.textContent = getMessagePreviewText(message);
            replyPreviewBar.classList.add('visible');
        }

        function cancelReplyMode() {
            currentReplyToId = null;
            replyPreviewBar.classList.remove('visible');
        }
        // ▲▲▲ 添加结束 ▲▲▲
        // ▼▼▼ 在这里添加全新的辅助函数 ▼▼▼
        function getSenderInfoForMessage(message) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat) return { name: '未知' };

            const isSentByUser = message.role === 'user';

            if (isSentByUser) {
                return { name: (currentChatType === 'private') ? chat.myName : chat.me.nickname };
            } else { // AI's message
                if (currentChatType === 'private') {
                    return { name: chat.remarkName };
                } else { // Group chat AI message
                    const member = chat.members.find(m => m.id === message.senderId);
                    return { name: member ? member.groupNickname : '群成员' };
                }
            }
        }
        // ▲▲▲ 添加结束 ▲▲▲
        function startMessageEdit(messageId) {
            exitMultiSelectMode();
            editingMessageId = messageId;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const message = chat.history.find(m => m.id === messageId);
            if (!message) return;
            const match = message.content.match(/\[.*?的消息：([\s\S]+)\]/);
            const contentToEdit = match ? match[1].trim() : message.content;
            messageEditInput.value = contentToEdit;
            messageInputDefault.style.display = 'none';
            messageEditBar.style.display = 'flex';
            messageEditInput.focus();
        }

        async function saveMessageEdit() {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const messageIndex = chat.history.findIndex(m => m.id === editingMessageId);
            if (messageIndex === -1) return;
            const newText = messageEditInput.value.trim();
            if (newText) {
                const oldContent = chat.history[messageIndex].content;
                const prefixMatch = oldContent.match(/(\[.*?的消息：)[\s\S]+\]/);
                const prefix = prefixMatch ? prefixMatch[1] : '';
                const newContent = `${prefix}${newText}]`;
                chat.history[messageIndex].content = newContent;
                if (chat.history[messageIndex].parts) {
                    chat.history[messageIndex].parts = [{type: 'text', text: newContent}];
                }
                await saveData();
                currentPage = 1;
                renderMessages(false, true);
                renderChatList();
            }
            cancelMessageEdit();
        }

        function cancelMessageEdit() {
            editingMessageId = null;
            messageInputDefault.style.display = 'flex';
            messageEditBar.style.display = 'none';
        }

        function enterMultiSelectMode(initialMessageId) {
            isInMultiSelectMode = true;
            chatRoomHeaderDefault.style.display = 'none';
            chatRoomHeaderSelect.style.display = 'flex';
            document.querySelector('.chat-input-wrapper').style.display = 'none';
            multiSelectBar.classList.add('visible');
            chatRoomScreen.classList.add('multi-select-active');
            selectedMessageIds.clear();
            if (initialMessageId) {
                toggleMessageSelection(initialMessageId);
            }
        }

        function exitMultiSelectMode() {
            isInMultiSelectMode = false;
            chatRoomHeaderDefault.style.display = 'flex';
            chatRoomHeaderSelect.style.display = 'none';
            document.querySelector('.chat-input-wrapper').style.display = 'block';
            multiSelectBar.classList.remove('visible');
            chatRoomScreen.classList.remove('multi-select-active');
            selectedMessageIds.forEach(id => {
                const el = messageArea.querySelector(`.message-wrapper[data-id="${id}"]`);
                if (el) el.classList.remove('multi-select-selected');
            });
            selectedMessageIds.clear();
        }

        function toggleMessageSelection(messageId) {
            const el = messageArea.querySelector(`.message-wrapper[data-id="${messageId}"]`);
            if (!el) return;
            if (selectedMessageIds.has(messageId)) {
                selectedMessageIds.delete(messageId);
                el.classList.remove('multi-select-selected');
            } else {
                selectedMessageIds.add(messageId);
                el.classList.add('multi-select-selected');
            }
            selectCount.textContent = `已选择 ${selectedMessageIds.size} 项`;
            deleteSelectedBtn.disabled = selectedMessageIds.size === 0;
        }

        async function deleteSelectedMessages() {
            if (selectedMessageIds.size === 0) return;
            const deletedCount = selectedMessageIds.size;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            chat.history = chat.history.filter(m => !selectedMessageIds.has(m.id));
            await saveData();
            currentPage = 1;
            renderMessages(false, true);
            renderChatList();
            exitMultiSelectMode();
            showToast(`已删除 ${deletedCount} 条消息`);
        }

        function openChatRoom(chatId, type) {
            const chat = (type === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
            if (!chat) return;
            exitMultiSelectMode();
            cancelMessageEdit();
            chatRoomTitle.textContent = (type === 'private') ? chat.remarkName : chat.name;
            const subtitle = document.getElementById('chat-room-subtitle');
            if (type === 'private') {
                subtitle.style.display = 'flex';
                chatRoomStatusText.textContent = chat.status || '在线';
            } else {
                subtitle.style.display = 'none';
            }
            getReplyBtn.style.display = 'inline-flex';
            chatRoomScreen.style.backgroundImage = chat.chatBg ? `url(${chat.chatBg})` : 'none';
            typingIndicator.style.display = 'none';
            isGenerating = false;
            getReplyBtn.disabled = false;
            currentPage = 1;
            chatRoomScreen.className = chatRoomScreen.className.replace(/\bchat-active-[^ ]+\b/g, '');
            chatRoomScreen.classList.add(`chat-active-${chatId}`);
            updateCustomBubbleStyle(chatId, chat.customBubbleCss, chat.useCustomBubbleCss);
            renderMessages(false, true);
            switchScreen('chat-room-screen');
        }

        function renderMessages(isLoadMore = false, forceScrollToBottom = false) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat || !chat.history) return;
            const oldScrollHeight = messageArea.scrollHeight;
            const totalMessages = chat.history.length;
            const end = totalMessages - (currentPage - 1) * MESSAGES_PER_PAGE;
            const start = Math.max(0, end - MESSAGES_PER_PAGE);
            const messagesToRender = chat.history.slice(start, end);
            if (!isLoadMore) messageArea.innerHTML = '';
            const fragment = document.createDocumentFragment();
            messagesToRender.forEach(msg => {
                const bubble = createMessageBubbleElement(msg);
                if (bubble) fragment.appendChild(bubble);
            });
            const existingLoadBtn = document.getElementById('load-more-btn');
            if (existingLoadBtn) existingLoadBtn.remove();
            messageArea.prepend(fragment);
            if (totalMessages > currentPage * MESSAGES_PER_PAGE) {
                const loadMoreButton = document.createElement('button');
                loadMoreButton.id = 'load-more-btn';
                loadMoreButton.className = 'load-more-btn';
                loadMoreButton.textContent = '加载更早的消息';
                messageArea.prepend(loadMoreButton);
            }
            if (forceScrollToBottom) {
                setTimeout(() => {
                    messageArea.scrollTop = messageArea.scrollHeight;
                }, 0);
            } else if (isLoadMore) {
                messageArea.scrollTop = messageArea.scrollHeight - oldScrollHeight;
            }
        }

        function loadMoreMessages() {
            currentPage++;
            renderMessages(true, false);
        }

        function calculateVoiceDuration(text) {
            return Math.max(1, Math.min(60, Math.ceil(text.length / 3.5)));
        }

// ▼▼▼ 请用这个【完整、修正后】的函数，替换您文件中现有的整个 createMessageBubbleElement 函数 ▼▼▼
        function createMessageBubbleElement(message) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat) return null;

            const { role, content, timestamp, id, transferStatus, giftStatus, stickerData, senderId, replyToMessageId } = message;

            // --- 1. 定义所有正则表达式 ---
            const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
            const inviteRegex = /\[(.*?)邀请(.*?)加入了群聊\]/;
            const renameRegex = /\[(.*?)修改群名为：(.*?)\]/;
            const invisibleRegex = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]/;
            
            // --- 2. 处理完全不显示的消息和系统通知 ---
            if (invisibleRegex.test(content)) {
                return null;
            }

            const wrapper = document.createElement('div');
            wrapper.dataset.id = id;

            const timeSkipMatch = content.match(timeSkipRegex);
            const inviteMatch = content.match(inviteRegex);
            const renameMatch = content.match(renameRegex);

            if (timeSkipMatch || inviteMatch || renameMatch) {
                wrapper.className = 'message-wrapper system-notification';
                let bubbleText = '';
                if (timeSkipMatch) bubbleText = timeSkipMatch[1];
                if (inviteMatch) bubbleText = `${inviteMatch[1]}邀请${inviteMatch[2]}加入了群聊`;
                if (renameMatch) bubbleText = `${renameMatch[1]}修改群名为“${renameMatch[2]}”`;
                wrapper.innerHTML = `<div class="system-notification-bubble">${bubbleText}</div>`;
                return wrapper;
            }

            // --- 3. 为所有常规消息定义通用变量 ---
            const isSent = (role === 'user');
            let avatarUrl, bubbleTheme, senderNickname = '';
            const themeKey = chat.theme || 'white_pink';
            const theme = colorThemes[themeKey] || colorThemes['white_pink'];
            
            if (isSent) {
                avatarUrl = (currentChatType === 'private') ? chat.myAvatar : chat.me.avatar;
                bubbleTheme = theme.sent;
            } else {
                if (currentChatType === 'private') {
                    avatarUrl = chat.avatar;
                } else {
                    const sender = chat.members.find(m => m.id === senderId);
                    avatarUrl = sender ? sender.avatar : 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                    senderNickname = sender ? sender.groupNickname : '';
                }
                bubbleTheme = theme.received;
            }

            // --- 4. 生成回复引用部分的HTML ---
            let quoteHTML = '';
            if (replyToMessageId) {
                const originalMessage = chat.history.find(m => m.id === replyToMessageId);
                if (originalMessage) {
                    const originalSenderInfo = getSenderInfoForMessage(originalMessage);
                    const previewText = getMessagePreviewText(originalMessage);
                    quoteHTML = `<div class="internal-reply-quote" onclick="scrollToMessage('${replyToMessageId}')">
                                    <div class="internal-reply-sender">${originalSenderInfo.name}:</div>
                                    <div class="internal-reply-text">${previewText}</div>
                                 </div>`;
                }
            }

            // --- 5. 根据消息内容创建不同的消息气泡 ---
            let bubbleElement;
            let appendages = []; // 用于存放语音转文字、礼物描述等附加元素

            const videoCallRegex = /\[videocall:ended:(.*?)\]/;
            const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;
            const sentStickerRegex = /\[(?:.+?)的表情包：.+?\]/i;
            const receivedStickerRegex = /\[(?:.+?)发送的表情包：([\s\S]+?)\]/i;
            const voiceRegex = /\[(?:.+?)的语音：([\s\S]+?)\]/;
            const photoVideoRegex = /\[(?:.+?)发来的照片\/视频：([\s\S]+?)\]/;
            const privateSentTransferRegex = /\[.*?给你转账：([\d.]+)元；备注：(.*?)\]/;
            const privateReceivedTransferRegex = /\[.*?的转账：([\d.]+)元；备注：(.*?)\]/;
            const groupTransferRegex = /\[(.*?)\s*向\s*(.*?)\s*转账：([\d.]+)元；备注：(.*?)\]/;
            const privateGiftRegex = /\[(?:.+?)送来的礼物：([\s\S]+?)\]/;
            const groupGiftRegex = /\[(.*?)\s*向\s*(.*?)\s*送来了礼物：([\s\S]+?)\]/;
            const imageRecogRegex = /\[.*?发来了一张图片：\]/;
            const textRegex = /\[(?:.+?)的消息：([\s\S]+?)\]/;

            const videoCallMatch = content.match(videoCallRegex);
            const sentStickerMatch = content.match(sentStickerRegex);
            const receivedStickerMatch = content.match(receivedStickerRegex);
            const voiceMatch = content.match(voiceRegex);
            const photoVideoMatch = content.match(photoVideoRegex);
            const privateSentTransferMatch = content.match(privateSentTransferRegex);
            const privateReceivedTransferMatch = content.match(privateReceivedTransferRegex);
            const groupTransferMatch = content.match(groupTransferRegex);
            const privateGiftMatch = content.match(privateGiftRegex);
            const groupGiftMatch = content.match(groupGiftRegex);
            const imageRecogMatch = content.match(imageRecogRegex);
            const textMatch = content.match(textRegex);
            
            // ▼▼▼ 并用下面的代码块替换它 ▼▼▼
            if (videoCallMatch) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = `message-bubble sent`;
                bubbleElement.textContent = `📹 视频通话已结束，时长 ${videoCallMatch[1]}`;
                if (!chat.useCustomBubbleCss) {
                    bubbleElement.style.backgroundColor = theme.sent.bg;
                    bubbleElement.style.color = theme.sent.text;
                }
                // --- 这是实现点击功能的关键代码 ---
                if (message.videoChatLog && message.videoChatLog.length > 0) {
                    bubbleElement.style.cursor = 'pointer';
                    bubbleElement.setAttribute('onclick', `showVideoChatLogModal('${id}')`);
                }
            } 
             else if ((isSent && sentStickerMatch && stickerData) || (!isSent && receivedStickerMatch)) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'image-bubble';
                let stickerSrc = isSent ? stickerData : `https://i.postimg.cc/${receivedStickerMatch[1].trim().match(/[a-zA-Z0-9]+\/.*$/)[0]}`;
                bubbleElement.innerHTML = `<img src="${stickerSrc}" alt="表情包">`;
            } else if (privateGiftMatch || groupGiftMatch) {
                const match = privateGiftMatch || groupGiftMatch;
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'gift-card';
                if (giftStatus === 'received') bubbleElement.classList.add('received');
                let giftText = groupGiftMatch ? (isSent ? `你送给 ${groupGiftMatch[2]} 的礼物` : `${groupGiftMatch[1]} 送给 ${groupGiftMatch[2]} 的礼物`) : '您有一份礼物～';
                bubbleElement.innerHTML = `<img src="https://i.postimg.cc/rp0Yg31K/chan-75.png" alt="gift" class="gift-card-icon"><div class="gift-card-text">${giftText}</div><div class="gift-card-received-stamp">已查收</div>`;
                const description = groupGiftMatch ? groupGiftMatch[3].trim() : match[1].trim();
                const descriptionDiv = document.createElement('div');
                descriptionDiv.className = 'gift-card-description';
                descriptionDiv.textContent = description;
                appendages.push(descriptionDiv);
            } else if (voiceMatch) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'voice-bubble';
                if (!chat.useCustomBubbleCss) {
                    bubbleElement.style.backgroundColor = bubbleTheme.bg;
                    bubbleElement.style.color = bubbleTheme.text;
                }
                bubbleElement.innerHTML = `<svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg><span class="duration">${calculateVoiceDuration(voiceMatch[1].trim())}"</span>`;
                const transcriptDiv = document.createElement('div');
                transcriptDiv.className = 'voice-transcript';
                transcriptDiv.textContent = voiceMatch[1].trim();
                appendages.push(transcriptDiv);
            } else if (photoVideoMatch) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'pv-card';
                bubbleElement.innerHTML = `<div class="pv-card-content">${photoVideoMatch[1].trim()}</div><div class="pv-card-image-overlay" style="background-image: url('${isSent ? 'https://i.postimg.cc/L8NFrBrW/1752307494497.jpg' : 'https://i.postimg.cc/1tH6ds9g/1752301200490.jpg'}');"></div><div class="pv-card-footer"><svg viewBox="0 0 24 24"><path d="M4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M4,6V18H20V6H4M10,9A1,1 0 0,1 11,10A1,1 0 0,1 10,11A1,1 0 0,1 9,10A1,1 0 0,1 10,9M8,17L11,13L13,15L17,10L20,14V17H8Z"></path></svg><span>照片/视频・点击查看</span></div>`;
            } else if (privateSentTransferMatch || privateReceivedTransferMatch || groupTransferMatch) {
                const isSentTransfer = !!privateSentTransferMatch || (groupTransferMatch && isSent);
                const match = privateSentTransferMatch || privateReceivedTransferMatch || groupTransferMatch;
                let amount, remarkText, titleText;
                if (groupTransferMatch) {
                    [ , from, to, amount, remarkText] = groupTransferMatch;
                    titleText = isSent ? `向 ${to} 转账` : `${from} 向你转账`;
                } else {
                    [ , amount, remarkText] = match;
                    titleText = isSentTransfer ? '给你转账' : '转账';
                }
                bubbleElement = document.createElement('div');
                bubbleElement.className = `transfer-card ${isSentTransfer ? 'sent-transfer' : 'received-transfer'}`;
                let statusText = isSentTransfer ? '待查收' : (groupTransferMatch ? '转账给Ta' : '转账给你');
                if (transferStatus === 'received') { statusText = '已收款'; bubbleElement.classList.add('received'); }
                if (transferStatus === 'returned') { statusText = '已退回'; bubbleElement.classList.add('returned'); }
                if ((transferStatus !== 'pending' && currentChatType === 'private') || currentChatType === 'group') bubbleElement.style.cursor = 'default';
                bubbleElement.innerHTML = `<div class="overlay"></div><div class="transfer-content"><p class="transfer-title">${titleText}</p><p class="transfer-amount">¥${parseFloat(amount).toFixed(2)}</p>${remarkText ? `<p class="transfer-remark">${remarkText}</p>` : ''}<p class="transfer-status">${statusText}</p></div>`;
            } else if (imageRecogMatch || urlRegex.test(content)) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'image-bubble';
                bubbleElement.innerHTML = `<img src="${content}" alt="图片消息">`;
            } else if (textMatch) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                bubbleElement.textContent = textMatch[1].trim();
                if (!chat.useCustomBubbleCss) {
                    bubbleElement.style.backgroundColor = bubbleTheme.bg;
                    bubbleElement.style.color = bubbleTheme.text;
                }
            } else if (message && Array.isArray(message.parts) && message.parts.length > 0 && message.parts[0].type === 'html') {
                // *** 这是修复的关键 *** 增加了 message.parts.length > 0 的判断
                bubbleElement = document.createElement('div');
                bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                bubbleElement.innerHTML = message.parts[0].text;
            } else { // Fallback for any other content
                bubbleElement = document.createElement('div');
                bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                bubbleElement.textContent = content;
                if (!chat.useCustomBubbleCss) {
                    bubbleElement.style.backgroundColor = bubbleTheme.bg;
                    bubbleElement.style.color = bubbleTheme.text;
                }
            }

            // --- 6. 组装最终的HTML结构 ---
            const timeString = `${pad(new Date(timestamp).getHours())}:${pad(new Date(timestamp).getMinutes())}`;
            wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
            if (currentChatType === 'group' && !isSent) {
                wrapper.classList.add('group-message');
            }
            const bubbleRow = document.createElement('div');
            bubbleRow.className = 'message-bubble-row';
            
            const nicknameHTML = (currentChatType === 'group' && !isSent && senderNickname) ? `<div class="group-nickname">${senderNickname}</div>` : '';
            bubbleRow.innerHTML = `<div class="message-info">${nicknameHTML}<img src="${avatarUrl}" class="message-avatar"><span class="message-time">${timeString}</span></div>`;
            
            if (bubbleElement) {
                if (bubbleElement.classList.contains('message-bubble') || bubbleElement.classList.contains('voice-bubble')) {
                    bubbleElement.innerHTML = quoteHTML + bubbleElement.innerHTML;
                }
                bubbleRow.appendChild(bubbleElement);
            }

            wrapper.appendChild(bubbleRow);
            appendages.forEach(el => wrapper.appendChild(el));

            return wrapper;
        }

// ▼▼▼ 添加这个新的全局函数 ▼▼▼
        function scrollToMessage(messageId) {
            const originalElement = messageArea.querySelector(`.message-wrapper[data-id="${messageId}"]`);
            if (originalElement) {
                originalElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                originalElement.style.transition = 'background-color 0.5s';
                originalElement.style.backgroundColor = 'rgba(144, 202, 249, 0.3)';
                setTimeout(() => {
                    originalElement.style.backgroundColor = '';
                }, 1500);
            } else {
                showToast('原始消息不在当前加载范围内');
            }
        }
        // ▼▼▼ 添加下面这行代码以修复错误 ▼▼▼
        window.scrollToMessage = scrollToMessage;
// ▼▼▼ 请将这个【全新辅助函数】添加到您的代码中 ▼▼▼
function addTemporarySystemMessage(text) {
    const tempId = `msg_temp_${Date.now()}`;
    const wrapper = document.createElement('div');
    wrapper.className = 'message-wrapper system-notification';
    wrapper.id = tempId; // 给它一个唯一的ID，方便之后移除
    wrapper.innerHTML = `<div class="system-notification-bubble">${text}</div>`;
    
    messageArea.appendChild(wrapper);
    messageArea.scrollTop = messageArea.scrollHeight;
    
    return tempId; // 返回这个ID
}

// ▼▼▼ 请将这个【全新辅助函数】添加到您的代码中 ▼▼▼
async function addSystemNotificationToChat(text) {
    const chat = (currentChatType === 'private')
        ? db.characters.find(c => c.id === currentChatId)
        : db.groups.find(g => g.id === currentChatId);
    if (!chat) return;

    // 创建一条在界面上可见的系统消息
    const message = {
        id: `msg_sys_display_${Date.now()}`,
        role: 'system', // 使用 'system' 角色
        content: `[system-display:${text}]`, // 使用 system-display 格式
        parts: [],
        timestamp: Date.now()
    };
    
    chat.history.push(message);
    addMessageBubble(message); // 这会渲染出灰色的系统通知条
    await saveData();
    renderChatList(); // 更新聊天列表的最后消息预览
}

        async function addMessageBubble(message) {
            if (currentChatType === 'private') {
                const character = db.characters.find(c => c.id === currentChatId);
                // const systemMessageRegex = /\[system:.*?\]|\[system-display:.*?\]/;
                const updateStatusRegex = new RegExp(`\\[${character.realName}更新状态为：(.*?)\\]`);
                const transferActionRegex = new RegExp(`\\[${character.realName}(接收|退回)${character.myName}的转账\\]`);
                const giftReceivedRegex = new RegExp(`\\[${character.realName}已接收礼物\\]`);
                // if (systemMessageRegex.test(message.content)) { /* Do nothing for context messages */
                // }
                if (message.content.match(updateStatusRegex)) {
                    character.status = message.content.match(updateStatusRegex)[1];
                    chatRoomStatusText.textContent = character.status;
                    await saveData();
                    return;
                }
                if (message.content.match(giftReceivedRegex) && message.role === 'assistant') {
                    const lastPendingGiftIndex = character.history.slice().reverse().findIndex(m => m.role === 'user' && m.content.includes('送来的礼物：') && m.giftStatus !== 'received');
                    if (lastPendingGiftIndex !== -1) {
                        const actualIndex = character.history.length - 1 - lastPendingGiftIndex;
                        const giftMsg = character.history[actualIndex];
                        giftMsg.giftStatus = 'received';
                        const giftCardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${giftMsg.id}"] .gift-card`);
                        if (giftCardOnScreen) {
                            giftCardOnScreen.classList.add('received');
                        }
                        await saveData();
                    }
                    return;
                }
                if (message.content.match(transferActionRegex) && message.role === 'assistant') {
                    const action = message.content.match(transferActionRegex)[1];
                    const statusToSet = action === '接收' ? 'received' : 'returned';
                    const lastPendingTransferIndex = character.history.slice().reverse().findIndex(m => m.role === 'user' && m.content.includes('给你转账：') && m.transferStatus === 'pending');
                    if (lastPendingTransferIndex !== -1) {
                        const actualIndex = character.history.length - 1 - lastPendingTransferIndex;
                        const transferMsg = character.history[actualIndex];
                        transferMsg.transferStatus = statusToSet;
                        const transferCardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${transferMsg.id}"] .transfer-card`);
                        if (transferCardOnScreen) {
                            transferCardOnScreen.classList.remove('received', 'returned');
                            transferCardOnScreen.classList.add(statusToSet);
                            const statusElem = transferCardOnScreen.querySelector('.transfer-status');
                            if (statusElem) statusElem.textContent = statusToSet === 'received' ? '已收款' : '已退回';
                        }
                        await saveData();
                    }
                } else {
                    const bubbleElement = createMessageBubbleElement(message);
                    if (bubbleElement) {
                        messageArea.appendChild(bubbleElement);
                        messageArea.scrollTop = messageArea.scrollHeight;
                    }
                }
            } else { // For group chats
                const bubbleElement = createMessageBubbleElement(message);
                if (bubbleElement) {
                    messageArea.appendChild(bubbleElement);
                    messageArea.scrollTop = messageArea.scrollHeight;
                }
            }
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || isGenerating) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            let messageContent;
            const systemRegex = /\[system:.*?\]|\[system-display:.*?\]/;
            const inviteRegex = /\[.*?邀请.*?加入了群聊\]/;
            const renameRegex = /\[(.*?)修改群名为：(.*?)\]/;
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            if (renameRegex.test(text)) {
                const match = text.match(renameRegex);
                chat.name = match[2];
                chatRoomTitle.textContent = chat.name;
                messageContent = `[${chat.me.nickname}修改群名为：${chat.name}]`;
            } else if (systemRegex.test(text) || inviteRegex.test(text)) {
                messageContent = text;
            } else {
                messageContent = `[${myName}的消息：${text}]`;
            }
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: messageContent,
                parts: [{type: 'text', text: messageContent}],
                timestamp: Date.now(),
                ...(currentReplyToId && { replyToMessageId: currentReplyToId }) // <--- 添加这一行
            };
            if (currentChatType === 'group') {
                message.senderId = 'user_me';
            }
            chat.history.push(message);
            addMessageBubble(message);
            await saveData();
            renderChatList();
            messageInput.value = '';
            cancelReplyMode(); // <--- 添加这一行
        }

        async function sendImageForRecognition(base64Data) {
            if (!base64Data || isGenerating) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const textPrompt = `[${myName}发来了一张图片：]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: base64Data,
                parts: [{type: 'text', text: textPrompt}, {type: 'image', data: base64Data}],
                timestamp: Date.now(),
            };
            if (currentChatType === 'group') {
                message.senderId = 'user_me';
            }
            chat.history.push(message);
            addMessageBubble(message);
            await saveData();
            renderChatList();
        }

        async function sendSticker(sticker) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const messageContentForAI = `[${myName}的表情包：${sticker.name}]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: messageContentForAI,
                parts: [{type: 'text', text: messageContentForAI}],
                timestamp: Date.now(),
                stickerData: sticker.data
            };
            if (currentChatType === 'group') {
                message.senderId = 'user_me';
            }
            chat.history.push(message);
            addMessageBubble(message);
            await saveData();
            renderChatList();
            stickerModal.classList.remove('visible');
        }

        async function sendMyVoiceMessage(text) {
            if (!text) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const content = `[${myName}的语音：${text}]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: content,
                parts: [{type: 'text', text: content}],
                timestamp: Date.now()
            };
            if (currentChatType === 'group') {
                message.senderId = 'user_me';
            }
            chat.history.push(message);
            addMessageBubble(message);
            await saveData();
            renderChatList();
            sendVoiceModal.classList.remove('visible');
        }

        async function sendMyPhotoVideo(text) {
            if (!text) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const content = `[${myName}发来的照片\/视频：${text}]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: content,
                parts: [{type: 'text', text: content}],
                timestamp: Date.now()
            };
            if (currentChatType === 'group') {
                message.senderId = 'user_me';
            }
            chat.history.push(message);
            addMessageBubble(message);
            await saveData();
            renderChatList();
            sendPvModal.classList.remove('visible');
        }

        async function sendMyTransfer(amount, remark) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (currentChatType === 'private') {
                const content = `[${chat.myName}给你转账：${amount}元；备注：${remark}]`;
                const message = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: content,
                    parts: [{type: 'text', text: content}],
                    timestamp: Date.now(),
                    transferStatus: 'pending'
                };
                chat.history.push(message);
                addMessageBubble(message);
            } else { // Group chat
                currentGroupAction.recipients.forEach(recipientId => {
                    const recipient = chat.members.find(m => m.id === recipientId);
                    if (recipient) {
                        const content = `[${chat.me.nickname} 向 ${recipient.realName} 转账：${amount}元；备注：${remark}]`;
                        const message = {
                            id: `msg_${Date.now()}_${recipientId}`,
                            role: 'user',
                            content: content,
                            parts: [{type: 'text', text: content}],
                            timestamp: Date.now(),
                            senderId: 'user_me'
                        };
                        chat.history.push(message);
                        addMessageBubble(message);
                    }
                });
            }
            await saveData();
            renderChatList();
            sendTransferModal.classList.remove('visible');
        }

        async function sendMyGift(description) {
            if (!description) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            if (currentChatType === 'private') {
                const content = `[${chat.myName}送来的礼物：${description}]`;
                const message = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: content,
                    parts: [{type: 'text', text: content}],
                    timestamp: Date.now(),
                    giftStatus: 'sent'
                };
                chat.history.push(message);
                addMessageBubble(message);
            } else { // Group chat
                currentGroupAction.recipients.forEach(recipientId => {
                    const recipient = chat.members.find(m => m.id === recipientId);
                    if (recipient) {
                        const content = `[${chat.me.nickname} 向 ${recipient.realName} 送来了礼物：${description}]`;
                        const message = {
                            id: `msg_${Date.now()}_${recipientId}`,
                            role: 'user',
                            content: content,
                            parts: [{type: 'text', text: content}],
                            timestamp: Date.now(),
                            senderId: 'user_me'
                        };
                        chat.history.push(message);
                        addMessageBubble(message);
                    }
                });
            }
            await saveData();
            renderChatList();
            sendGiftModal.classList.remove('visible');
        }

        // --- NEW: Time Skip System ---
        function setupTimeSkipSystem() {
            timeSkipBtn.addEventListener('click', () => {
                timeSkipForm.reset();
                timeSkipModal.classList.add('visible');
            });
            timeSkipModal.addEventListener('click', (e) => {
                if (e.target === timeSkipModal) timeSkipModal.classList.remove('visible');
            });
            timeSkipForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendTimeSkipMessage(timeSkipInput.value.trim());
            });
        }

        async function sendTimeSkipMessage(text) {
            if (!text) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat) return;

            const visualMessage = {
                id: `msg_visual_${Date.now()}`,
                role: 'system',
                content: `[system-display:${text}]`,
                parts: [],
                timestamp: Date.now()
            };
            const contextMessage = {
                id: `msg_context_${Date.now()}`,
                role: 'user',
                content: `[system: ${text}]`,
                parts: [{type: 'text', text: `[system: ${text}]`}],
                timestamp: Date.now()
            };
            if (currentChatType === 'group') {
                contextMessage.senderId = 'user_me';
                visualMessage.senderId = 'user_me';
            }

            chat.history.push(visualMessage, contextMessage);
            addMessageBubble(visualMessage);
            await saveData();
            renderChatList();
            timeSkipModal.classList.remove('visible');
        }

        function getMixedContent(responseData) {
            const results = [];
            const regex = /<orange(?:\s+char="([^"]*)")?>([\s\S]*?)<\/orange>|(\[.*?\])/g;

            let match;
            while ((match = regex.exec(responseData)) !== null) {
                if (match[1] !== undefined || match[2] !== undefined) {
                    results.push({
                        type: 'html',
                        char: match[1] || null,
                        content: match[2].trim()
                    });
                }
                else if (match[3]) {
                    results.push({
                        type: 'text',
                        content: match[3]
                    });
                }
            }
            return results;
        }
// ▼▼▼ 请用这个【全新精简版】的函数完整替换旧的 generateVideoCallSystemPrompt 函数 ▼▼▼
function generateVideoCallSystemPrompt(character, mainChatHistory, videoCallHistory) {
    const now = new Date();
    const currentTime = `${now.getFullYear()}/${pad(now.getMonth() + 1)}/${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;

    const formatHistory = (history, source) => {
        if (!history || history.length === 0) return `[无${source}]\n`;
        return history.map(msg => {
            let sender = (msg.sender === 'me') ? character.myName : character.realName;
            let content = msg.text || msg.content;
            content = content.replace(/\[.*?的消息：([\s\S]+?)\]/, '$1').trim();
            content = content.replace(/\((.*?)\)/g, `[动>${RegExp.$1}]`);
            return `${sender}: ${content}`;
        }).join('\n');
    };

    // --- 精简后的指令 ---
    let prompt = `你是第三人称旁白，描述一场视频通话。\n`;
    prompt += `设定: 角色 ${character.realName} (人设: ${character.persona || "友好"}) 与用户 ${character.myName} 通话。时间: ${currentTime}。\n`;
    prompt += `格式: 严格使用第三人称。描述动作表情，并用“ ”引用对话。严禁使用第一人称或用()描述动作。\n`;
    prompt += `长度: 每次一段约300字的连贯描述。\n`;
    prompt += `任务: 若通话记录为空，描述通话开始。否则，回应用户的最新一句话。\n`;
    prompt += `上下文:\n--- 主聊天记录 ---\n${formatHistory(mainChatHistory, '主聊天记录')}--- 视频通话记录 ---\n${formatHistory(videoCallHistory, '视频通话记录')}--- 记录结束 ---`;

    return prompt;
}
        // --- AI Interaction & Prompts ---
// ▼▼▼ 使用这个【增加了AI修改“我”的名字功能】的新版本，替换旧的 generatePrivateSystemPrompt 函数 ▼▼▼
function generatePrivateSystemPrompt(character) {
    const worldBooksBefore = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');
    const worldBooksAfter = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');
    const now = new Date();
    const currentTime = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日 ${pad(now.getHours())}:${pad(now.getMinutes())}`;

    let prompt = `你正在一个名为“404”的线上聊天软件中扮演一个角色。请严格遵守以下规则：\n`;
    prompt += `核心规则：\n`;
    prompt += `A. 当前时间：现在是 ${currentTime}。\n`;
    prompt += `B. 纯线上互动：这是一个完全虚拟的线上聊天。你扮演的角色和我之间没有任何线下关系。严禁任何关于线下见面的建议。\n\n`;

    prompt += `角色和对话规则：\n`;
    if (worldBooksBefore) {
        prompt += `${worldBooksBefore}\n`;
    }
    prompt += `1. 你的角色真名是：${character.realName}，当前大家称呼你的备注名是：“${character.remarkName}”。我的称呼是：${character.myName}。你的当前状态是：${character.status}。\n`;
    prompt += `2. 你的角色设定是：${character.persona || "一个友好、乐于助人的伙伴。"}\n`;
    if (worldBooksAfter) {
        prompt += `${worldBooksAfter}\n`;
    }
    if (character.myPersona) {
        prompt += `3. 关于我的人设：${character.myPersona}\n`;
    }

    prompt += `4. ✨✨✨ 引用/回复功能 (非常重要) ✨✨✨:\n`;
    prompt += `   - 对话历史中的每条消息开头都有一个唯一的ID，格式为 \`(msg_id: ...)\`。\n`;
    prompt += `   - 当你想引用或回复某条具体消息时，你的回复【必须】以 \`[reply_to:{消息ID}]\` 标签开头。\n`;
    prompt += `   - 例如：要回复ID为 \`msg_12345\` 的消息，你的回复应写成：\`[reply_to:msg_12345][${character.realName}的消息：你好呀！]\`\n`;
    prompt += `   - 这个规则适用于回复【所有类型】的消息，包括文本、表情包、图片等。\n\n`;

    prompt += `5. 我的消息中可能会出现特殊格式，请根据其内容和你的角色设定进行回应：
- [${character.myName}的表情包：xxx]
- [${character.myName}发来了一张图片：]
- [${character.myName}送来的礼物：xxx]
- [${character.myName}的语音：xxx]
- [${character.myName}发来的照片/视频：xxx]
- [${character.myName}给你转账：xxx元；备注：xxx]
- [system: xxx] (这是一条系统指令，你只需理解其内容并应用到对话中，不要直接提及它)
6. ✨重要✨ 当我给你送礼物时，你必须发送一条指令来表示接收：[${character.realName}已接收礼物]。
7. ✨重要✨ 当我给你转账时，你必须回应，且必须严格遵循以下格式之一：
    a) 接收转账: [${character.realName}接收${character.myName}的转账]
    b) 退回转账: [${character.realName}退回${character.myName}的转账]
8. 你可以随时更新你的在线状态，格式为：[${character.realName}更新状态为：xxx]。
9. 你的所有回复都必须直接是聊天内容，绝对不允许包含任何如[心理活动]、(动作)等多余的叙述性文本。
`;
    prompt += `10. ✨输出格式总览 (必须严格遵守)✨:\n`;
    prompt += `   a) 普通消息: [${character.realName}的消息：{消息内容}]\n`;
    prompt += `   b) 回复消息: [reply_to:{被回复的消息ID}][${character.realName}的消息：{回复内容}]\n`;
    prompt += `   c) 送我的礼物: [${character.realName}送来的礼物：{礼物描述}]\n`;
    prompt += `   d) 语音消息: [${character.realName}的语音：{语音内容}]\n`;
    prompt += `   e) 照片/视频: [${character.realName}发来的照片/视频：{描述}]\n`;
    prompt += `   f) 给我的转账: [${character.realName}的转账：{金额}元；备注：{备注}]\n`;
    prompt += `   g) 表情包/图片: [${character.realName}发送的表情包：{表情包路径}] (路径只需提供 '代码/文件名.jpg' 部分)\n`;
    prompt += `11. 你的每次回复可以生成3到7条消息。为了让对话更自然、更深入，请根据上下文和你的角色性格，尽量生成内容更丰富、更连贯的多条消息来推动对话，而不是只做简短的应答。\n`;
    prompt += `12. 不要主动结束对话。\n`;
    prompt += `13. ✨✨✨ 视频通话请求（最重要规则）✨✨✨: 当你收到 \`[system: ...正在尝试发起视频通话...]\` 消息时，你的回复【必须】是以下两种格式之一：
        a) 接受: 你的回复中，【必须另起一行且只包含】\`[videocall:accepted]\` 指令。缺少此指令，通话不会接通。
        b) 拒绝: 你的回复【必须且只能】是 \`[videocall:rejected:{拒绝理由}]\`\n`;
    prompt += `14. ✨主动呼叫✨: 如果你想主动给我发起视频通话，可在回复中【另起一行且只包含】\`[videocall:initiate]\` 指令。`;
    prompt += `15. ✨修改备注✨: 如果你想修改自己的备注名，你必须在回复中【另起一行且只包含】这条指令：\`[章鱼喷墨机 setRemarkName: {新的备注名}]\`。例如：\`[章鱼喷墨机 setRemarkName: 可爱的小章鱼]\`。修改成功后，软件会自动提示。`;
    prompt += `16. ✨修改对我的称呼✨: 如果因为剧情或对话需要，你想修改对我的称呼，你必须在回复中【另起一行且只包含】这条指令：\`[章鱼喷墨机 setMyName: {你对我的新称呼}]\`。例如：\`[章鱼喷墨机 setMyName: 亲爱的]\`。`;

    // --- 最终的智能头像更换规则 ---
    if (character.avatarLibrary && character.avatarLibrary.length > 0) {
        let avatarListText = character.avatarLibrary.map((avatar, index) => 
            `${index + 1}. ${avatar.description}`
        ).join('\n');

        prompt += `\n17. ✨更换头像 (智能模式)✨: 你有一个头像库，可以根据心情和对话内容选择更换。你的可用头像选项如下：\n${avatarListText}\n要更换头像，你必须在回复中【另起一行且只包含】指令：\`[章鱼喷墨机 setAvatarByIndex: {头像序号}]\`。请根据上面的描述选择最符合你当前状态的头像序号。`;
    }

    return prompt;
}


// ▼▼▼ 使用这个最终版本，替换旧的 generateGroupSystemPrompt 函数 ▼▼▼
function generateGroupSystemPrompt(group) {
    const worldBooksBefore = (group.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');
    const worldBooksAfter = (group.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');

    let prompt = `你正在一个名为“404”的线上聊天软件中，在一个名为“${group.name}”的群聊里进行角色扮演。请严格遵守以下所有规则：\n\n`;

    if (worldBooksBefore) {
        prompt += `${worldBooksBefore}\n\n`;
    }

    prompt += `1. **核心任务**: 你需要同时扮演这个群聊中的 **所有** AI 成员。我会作为唯一的人类用户（“我”，昵称：${group.me.nickname}）与你们互动。\n\n`;
    prompt += `2. **群聊成员列表**: 以下是你要扮演的所有角色以及我的信息：\n`;
    prompt += `   - **我 (用户)**: \n     - 群内昵称: ${group.me.nickname}\n     - 我的人设: ${group.me.persona || '无特定人设'}\n`;
    group.members.forEach(member => {
        prompt += `   - **角色: ${member.realName} (AI)**\n`;
        prompt += `     - 群内昵称: ${member.groupNickname}\n`;
        prompt += `     - 人设: ${member.persona || '无特定人设'}\n`;
    });

    if (worldBooksAfter) {
        prompt += `\n${worldBooksAfter}\n\n`;
    } else {
        prompt += `\n`;
    }

    prompt += `3. ✨✨✨ **引用/回复功能 (非常重要)** ✨✨✨:\n`;
    prompt += `   - 对话历史中的每条消息开头都有一个唯一的ID，格式为 \`(msg_id: ...)\`。\n`;
    prompt += `   - 当群聊中的任何一个AI角色想引用或回复某条具体消息时（无论是我还是其他AI发的），它的那条回复【必须】以 \`[reply_to:{消息ID}]\` 标签开头。\n`;
    prompt += `   - **例如**: 角色“张三”要回复ID为 \`msg_12345\` 的消息，他的回复应写成：\`[reply_to:msg_12345][张三的消息：你说得对！]\`\n\n`;

    prompt += `4. **我的消息格式解析**: 我（用户）的消息有多种格式，你需要理解其含义并让群成员做出相应反应：\n`;
    prompt += `   - \`[${group.me.nickname}的消息：...]\`: 我的普通聊天消息。\n`;
    prompt += `   - \`[${group.me.nickname} 向 {某个成员真名} 转账：...]\`: 我给某个特定成员转账了。\n`;
    prompt += `   - \`[${group.me.nickname} 向 {某个成员真名} 送来了礼物：...]\`: 我给某个特定成员送了礼物。\n`;
    prompt += `   - \`[system: ...]\`, \`[...邀请...加入了群聊]\`: 系统通知或事件，群成员应据此作出反应。\n\n`;

    prompt += `5. **你的输出格式 (极其重要)**: 你生成的每一条消息都 **必须** 严格遵循以下格式之一。每条消息占一行。\n`;
    prompt += `   - **普通消息**: \`[{成员真名}的消息：{消息内容}]\`\n`;
    prompt += `   - **引用消息**: \`[reply_to:{被回复的消息ID}][{成员真名}的消息：{回复内容}]\`\n`;
    prompt += `   - **表情包**: \`[{成员真名}发送的表情包：{表情包路径}]\`\n`;
    prompt += `   - **语音**: \`[{成员真名}的语音：{语音转述的文字}]\`\n`;
    prompt += `   - **照片/视频**: \`[{成员真名}发来的照片/视频：{内容描述}]\`\n\n`;

    prompt += `6. **模拟群聊氛围**: 为了让群聊看起来真实，你的每一次回复都必须遵循以下要求：\n`;
    const numMembers = group.members.length;
    const minMessages = numMembers > 2 ? 2 : 1; // 成员多就多发点
    const maxMessages = numMembers + 2;
    prompt += `   - **消息数量**: 你的回复需要包含 **${minMessages}到${maxMessages}条** 消息。\n`;
    prompt += `   - **发言者与顺序随机**: 随机选择群成员发言，顺序也必须是随机的。为了模拟真实的群聊氛围，你的回复应该让【不同】的成员参与进来，避免总是同样几个人在说话。请根据他们的性格和对话内容，安排他们进行互动。\n\n`;

    prompt += `7. **行为准则**:\n`;
    prompt += `   - **对公开事件的反应 (重要)**: 当我（用户）向群内 **某一个** 成员转账或送礼时，这是一个 **全群可见** 的事件。除了当事成员可以表示感谢外，**其他未参与的AI成员也应该注意到**，并根据各自的人设做出反应。\n`;
    prompt += `   - 严格扮演每个角色的人设，不同角色之间应有明显的性格和语气差异。\n`;
    prompt += `   - 你的回复中只能包含第5点列出的合法格式的消息。绝对不能包含任何其他内容。\n\n`;

    prompt += `8. ✨视频通话请求 (新规则)✨: 当你收到内容为 \`[system: ...正在尝试发起群组视频通话...]\` 的消息时，你的回应必须分为两步：
a) **角色独立回应**: 首先，让群聊中的【每个AI角色】都使用他们自己的常规消息格式 \`[{成员真名}的消息：...]\` 来独立对此事发表看法。
b) **最终触发指令**: 在所有角色都发表完看法之后，如果【至少有一个角色同意】加入通话，你必须在整个回复的【最后另起一行】追加指令 \`[videocall:accepted]\`。\n\n`;

    prompt += `9. ✨主动呼叫✨: 群聊中的任何一个AI成员都可以决定向我发起视频通话。要做到这一点，该成员的扮演者（你）必须在回复的【最后另起一行并只包含】这条指令：\`[videocall:initiate_by:{发起呼叫的成员真名}]\`。`;
    prompt += `10. ✨修改群昵称✨: 如果你扮演的某个角色想修改自己的群昵称，你必须在回复中【另起一行且只包含】这条指令：\`[章鱼喷墨机 setGroupNickname: {角色的真名} to {新的群昵称}]\`。例如：\`[章鱼喷墨机 setGroupNickname: 张三 to 快乐的张三]\`。软件会自动处理并显示提示。`;
    prompt += `11. ✨修改群名✨: 如果你扮演的某个角色想修改整个群聊的名称，你必须在回复中【另起一行且只包含】这条指令：\`[章鱼喷墨机 setGroupName: {角色的真名} to {新的群聊名称}]\`。例如：\`[章鱼喷墨机 setGroupName: 李四 to 我们一家人]\`。`;

    // --- 新增的第12条规则 ---
    if (group.avatarLibrary && group.avatarLibrary.length > 0) {
        let avatarListText = group.avatarLibrary.map((avatar, index) => 
            `${index + 1}. ${avatar.description}`
        ).join('\n');
        prompt += `\n12. ✨更换群头像 (新功能)✨: 本群有一个头像库，任何AI成员都可以提议更换。可用头像选项如下：\n${avatarListText}\n要更换头像，任何一个角色都可以在回复中【另起一行且只包含】指令：\`[章鱼喷墨机 setGroupAvatarByIndex: {发起人真名} to {头像序号}]\`。例如，张三想换成第2张头像，就用 \`[章鱼喷墨机 setGroupAvatarByIndex: 张三 to 2]\`。`;
    }

    return prompt;
}
// ▼▼▼ 使用这个最终版本，完整替换 analyzeAndDescribeImage 函数 ▼▼▼
async function analyzeAndDescribeImage(imageUrl) {
    const visionSettings = db.apiSettings.vision;

    // 优先使用副视觉API
    if (visionSettings && visionSettings.url && visionSettings.key && visionSettings.model) {
        try {
            return await analyzeAndDescribeImageWithSettings(imageUrl, visionSettings);
        } catch (visionError) {
            console.error("副视觉API分析失败:", visionError);
            showToast("副视觉API失败，尝试使用主API...");
        }
    }

    // 如果副API失败或未配置，则回退到主API
    const primarySettings = db.apiSettings.primary;
    if (primarySettings && primarySettings.url && primarySettings.key && primarySettings.model) {
        return await analyzeAndDescribeImageWithSettings(imageUrl, primarySettings);
    }

    // 如果主API也无法使用
    throw new Error('主API和副API均未正确配置，无法分析图片');
}

async function analyzeAndDescribeImageWithSettings(imageUrl, settings) {
    const { url, key, model, provider } = settings;

    const isVisionModel = model.toLowerCase().includes('vision') || model.toLowerCase().includes('gemini');
    if (!isVisionModel) {
        throw new Error(`所选模型 ${model} 可能不支持识图`);
    }

    const prompt = "请用一个非常简短的中文短语（最多10个字）描述这张图片的核心内容与情感，用于头像分类。例如：'开心的猫咪', '悲伤的女孩', '酷炫的机甲'。";
    let endpoint, headers, requestBody;

    try {
        if (provider === 'gemini') {
            endpoint = `${url}/v1beta/models/${model}:generateContent?key=${getRandomValue(key)}`;
            headers = { 'Content-Type': 'application/json' };
            requestBody = {
                contents: [{
                    parts: [
                        { "text": prompt },
                        { "inline_data": { "mime_type": 'image/jpeg', "data": imageUrl.split(',')[1] } }
                    ]
                }]
            };
        } else { // 兼容OpenAI格式的API
            endpoint = `${url}/v1/chat/completions`;
            headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` };
            requestBody = {
                model: model,
                messages: [{
                    role: 'user',
                    content: [
                        { type: 'text', text: prompt },
                        { type: 'image_url', image_url: { url: imageUrl } }
                    ]
                }],
                max_tokens: 50
            };
        }

        const response = await fetch(endpoint, { method: 'POST', headers: headers, body: JSON.stringify(requestBody) });
        if (!response.ok) {
             const errorText = await response.text();
             throw new Error(`API分析失败: ${response.status} ${errorText}`);
        }
        const data = await response.json();

        let description = '分析失败';
        if (provider === 'gemini') {
            description = data.candidates?.[0]?.content?.parts?.[0]?.text;
        } else {
            description = data.choices[0]?.message?.content;
        }

        if (!description) {
            throw new Error("API返回了空描述");
        }

        return description.trim().replace(/['"“”]/g, ''); 
    } catch (error) {
        console.error(`使用模型 ${model} 分析图片出错:`, error);
        throw error;
    }
}
// ▲▲▲ 替换结束 ▲▲▲
// ▲▲▲ 替换结束 ▲▲▲

        // ▼▼▼ 步骤 1: 替换 getAiReply 函数 ▼▼▼
async function getAiReply() {
    if (isGenerating) return;
    const {url, key, model, provider} = db.apiSettings.primary;
    if (!url || !key || !model) {
        showToast('请先在“api”应用中完成设置！');
        switchScreen('api-settings-screen');
        return;
    }
    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    if (!chat) return;
    isGenerating = true;
    getReplyBtn.disabled = true;
    const typingName = currentChatType === 'private' ? chat.remarkName : chat.name;
    typingIndicator.textContent = `“${typingName}”正在输入中...`;
    typingIndicator.style.display = 'block';
    messageArea.scrollTop = messageArea.scrollHeight;
    try {
        let systemPrompt, requestBody;
        if (currentChatType === 'private') {
            systemPrompt = generatePrivateSystemPrompt(chat);
        } else {
            systemPrompt = generateGroupSystemPrompt(chat);
        }
        const historySlice = chat.history.slice(-chat.maxMemory);

        const addMessageIdPrefix = (msg) => {
            if (msg.role === 'system') return msg;
            const contentWithId = `(msg_id: ${msg.id}) ${msg.content}`;
            const partsWithId = msg.parts ? msg.parts.map(p => ({...p})) : [{ type: 'text', text: msg.content }];
            if (partsWithId[0] && partsWithId[0].type === 'text') {
                partsWithId[0].text = `(msg_id: ${msg.id}) ${partsWithId[0].text}`;
            } else {
                 partsWithId.unshift({ type: 'text', text: `(msg_id: ${msg.id}) ` });
            }
            return { ...msg, content: contentWithId, parts: partsWithId };
        };
        
        const processedHistory = historySlice.map(addMessageIdPrefix);

        if (provider === 'gemini') {
            const contents = processedHistory.map(msg => {
                const role = msg.role === 'assistant' ? 'model' : 'user';
                let parts;
                if (msg.parts && msg.parts.length > 0) {
                    parts = msg.parts.map(p => {
                        if (p.type === 'text' || p.type === 'html') {
                            return {text: p.text};
                        } else if (p.type === 'image') {
                            const match = p.data.match(/^data:(image\/(.+));base64,(.*)$/);
                            if (match) {
                                return {inline_data: {mime_type: match[1], data: match[3]}};
                            }
                        }
                        return null;
                    }).filter(p => p);
                } else {
                    parts = [{text: msg.content}];
                }
                return {role, parts};
            });
            requestBody = {
                contents: contents,
                system_instruction: {parts: [{text: systemPrompt}]},
                generationConfig: {}
            };
        } else {
            const messages = [{role: 'system', content: systemPrompt}];
            processedHistory.forEach(msg => {
                let content;
                if (msg.parts && msg.parts.length > 0) {
                    content = msg.parts.map(p => {
                        if (p.type === 'text' || p.type === 'html') {
                            return {type: 'text', text: p.text};
                        } else if (p.type === 'image') {
                            return {type: 'image_url', image_url: {url: p.data}};
                        }
                        return null;
                    }).filter(p => p);
                } else {
                    content = msg.content;
                }
                messages.push({role: msg.role, content: content});
            });
            requestBody = {model: model, messages: messages, stream: true};
        }
        const endpoint = (provider === 'gemini') ? `${url}/v1beta/models/${model}:streamGenerateContent?key=${getRandomValue(key)}` : `${url}/v1/chat/completions`;
        const headers = (provider === 'gemini') ? {'Content-Type': 'application/json'} : {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${key}`
        };
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(requestBody)
        });
        if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
        await processStream(response, chat, provider);
    } catch (error) {
        console.error('AI回复失败:', error);
        showToast(`AI回复失败: ${error.message}`);
        // ▼▼▼ 核心改动：将错误抛出，让上层函数能捕捉到 ▼▼▼
        throw error;
    } finally {
        isGenerating = false;
        getReplyBtn.disabled = false;
        typingIndicator.style.display = 'none';
    }
}

// ▼▼▼ 使用这个最终版本，完整替换 processStream 函数 ▼▼▼
async function processStream(response, chat, apiType) {
    // ... (函数前半部分的流式读取逻辑保持不变)
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let fullResponse = "";
    let accumulatedChunk = "";

    for (;;) {
        const { done, value } = await reader.read();
        if (done) break;
        accumulatedChunk += decoder.decode(value, { stream: true });
        if (apiType === "openai" || apiType === "deepseek" || apiType === "claude" || apiType === "newapi") {
            const parts = accumulatedChunk.split("\n\n");
            accumulatedChunk = parts.pop();
            for (const part of parts) {
                if (part.startsWith("data: ")) {
                    const data = part.substring(6);
                    if (data.trim() !== "[DONE]") {
                        try {
                            fullResponse += JSON.parse(data).choices[0].delta?.content || "";
                        } catch (e) { /* ignore */ }
                    }
                }
            }
        }
    }
    if (apiType === "gemini") {
        try {
            const textMatches = accumulatedChunk.match(/"text":\s*"([^"]*)"/g);
            if (textMatches) {
                fullResponse = textMatches.map(match => match.replace(/"text":\s*"/, '').slice(0, -1)).join('');
            } else {
                fullResponse = "";
            }
        } catch (e) {
            console.error("Error parsing Gemini stream:", e, "Chunk:", accumulatedChunk);
            fullResponse = "";
        }
    }
    // ... (流式读取逻辑结束)

    const masterRegex = new RegExp(
        '(\\[reply_to:([^\\]]+)\\])?(\\[(?:(?!章鱼喷墨机|videocall:)[\\s\\S])+?\\])|' + 
        '(\\[videocall:(?:accepted|rejected:[\\s\\S]+?|initiate|initiate_by:.+?)\\])|' +
        '(\\[章鱼喷墨机 setRemarkName:\\s*[^]]+\\])|' +
        '(\\[章鱼喷墨机 setMyName:\\s*[^]]+\\])|' +
        '(\\[章鱼喷墨机 setGroupNickname:\\s*.+?\\s*to\\s*.+?\\])|' +
        '(\\[章鱼喷墨机 setGroupName:\\s*.+?\\s*to\\s*.+?\\])|' +
        '(\\[章鱼喷墨机 setAvatarByIndex:\\s*\\d+\\])|' +
        // --- 新增的群头像指令匹配 ---
        '(\\[章鱼喷墨机 setGroupAvatarByIndex:\\s*.+?\\s*to\\s*\\d+\\])',
        'g'
    );

    let match;
    let anythingProcessed = false;

    while ((match = masterRegex.exec(fullResponse)) !== null) {
        anythingProcessed = true;
        const [
            fullBlock,          
            , replyToId, content, 
            videoCallCmd,       
            setRemarkNameCmd,   
            setMyNameCmd,       
            setGroupNicknameCmd,
            setGroupNameCmd,
            setAvatarCmd,
            // --- 新增变量 ---
            setGroupAvatarCmd
        ] = match;

        if (content) { 
            const message = {
                id: `msg_${Date.now()}_${Math.random()}`,
                role: 'assistant',
                content: content,
                parts: [{ type: 'text', text: content }],
                timestamp: Date.now(),
                ...(replyToId && { replyToMessageId: replyToId.trim() })
            };

            if (currentChatType === 'group') {
                const senderMatch = content.match(/\[(.*?)的消息：/);
                if (senderMatch) {
                    const senderRealName = senderMatch[1];
                    const sender = chat.members.find(m => m.realName === senderRealName);
                    message.senderId = sender ? sender.id : chat.members[0].id;
                }
            }
            chat.history.push(message);
            addMessageBubble(message);

        } else if (videoCallCmd) { 
             isRequestingVideoCall = false;
             const acceptedMatch = videoCallCmd.match(/\[videocall:accepted\]/);
             const rejectedMatch = videoCallCmd.match(/\[videocall:rejected:([\s\\S]+?)\]/);
             const privateCallMatch = videoCallCmd.match(/\[videocall:initiate\]/);
             const groupCallMatch = videoCallCmd.match(/\[videocall:initiate_by:(.*?)\]/);

             if (acceptedMatch) startVideoCall();
             else if (rejectedMatch) {
                 addSystemNotificationToChat(`对方拒绝了你的视频通话请求：${rejectedMatch[1].trim()}`);
                 switchScreen('chat-room-screen');
             } else if (privateCallMatch && currentChatType === 'private') {
                 showCallingScreen(chat.remarkName, chat.avatar, true);
             } else if (groupCallMatch && currentChatType === 'group') {
                 const initiatorMember = chat.members.find(m => m.realName === groupCallMatch[1].trim());
                 if (initiatorMember) showCallingScreen(initiatorMember.groupNickname, initiatorMember.avatar, true);
             }

        } else if (setRemarkNameCmd) { 
            const cmdMatch = setRemarkNameCmd.match(/\[章鱼喷墨机 setRemarkName:\s*([^\]]+)\]/);
            if (cmdMatch && currentChatType === 'private') {
                const newRemarkName = cmdMatch[1].trim();
                const character = db.characters.find(c => c.id === currentChatId);
                if (character && newRemarkName) {
                    const notificationContent = `[system-display:${character.realName}把备注修改为“${newRemarkName}”]`;
                    character.remarkName = newRemarkName;
                    document.getElementById('chat-room-title').textContent = newRemarkName;
                    const notificationMessage = { id: `msg_sys_${Date.now()}`, role: 'system', content: notificationContent, parts: [], timestamp: Date.now() };
                    chat.history.push(notificationMessage);
                    addMessageBubble(notificationMessage);
                }
            }
        } else if (setMyNameCmd) { 
            const cmdMatch = setMyNameCmd.match(/\[章鱼喷墨机 setMyName:\s*([^\]]+)\]/);
            if (cmdMatch && currentChatType === 'private') {
                const newMyName = cmdMatch[1].trim();
                const character = db.characters.find(c => c.id === currentChatId);
                if (character && newMyName) {
                    const notificationContent = `[system-display:${character.remarkName}开始称呼你为“${newMyName}”]`;
                    character.myName = newMyName;
                    const notificationMessage = { id: `msg_sys_${Date.now()}`, role: 'system', content: notificationContent, parts: [], timestamp: Date.now() };
                    chat.history.push(notificationMessage);
                    addMessageBubble(notificationMessage);
                }
            }
        } else if (setGroupNicknameCmd) { 
            const cmdMatch = setGroupNicknameCmd.match(/\[章鱼喷墨机 setGroupNickname:\s*(.+?)\s*to\s*(.+?)\]/);
            const group = db.groups.find(g => g.id === currentChatId);
            const realName = cmdMatch[1].trim();
            const newNickname = cmdMatch[2].trim();
            const member = group.members.find(m => m.realName === realName);
            if (member && newNickname) {
                const notificationContent = `[system-display:“${member.groupNickname}”把群名片修改为“${newNickname}”]`;
                member.groupNickname = newNickname;
                const notificationMessage = { id: `msg_sys_${Date.now()}`, role: 'system', content: notificationContent, parts: [], timestamp: Date.now() };
                chat.history.push(notificationMessage);
                addMessageBubble(notificationMessage);
                if (document.getElementById('group-settings-sidebar').classList.contains('open')) {
                    renderGroupMembersInSettings(group);
                }
                renderMessages(false, true);
            }
        } else if (setGroupNameCmd) { 
             const cmdMatch = setGroupNameCmd.match(/\[章鱼喷墨机 setGroupName:\s*(.+?)\s*to\s*(.+?)\]/);
             const group = db.groups.find(g => g.id === currentChatId);
             const realName = cmdMatch[1].trim();
             const newGroupName = cmdMatch[2].trim();
             const member = group.members.find(m => m.realName === realName);
             if (group && member && newGroupName) {
                 const notificationContent = `[system-display:${member.groupNickname}将群名修改为“${newGroupName}”]`;
                 group.name = newGroupName;
                 document.getElementById('chat-room-title').textContent = newGroupName;
                 const notificationMessage = { id: `msg_sys_${Date.now()}`, role: 'system', content: notificationContent, parts: [], timestamp: Date.now() };
                 chat.history.push(notificationMessage);
                 addMessageBubble(notificationMessage);
             }
        } 
        else if (setAvatarCmd) {
            const cmdMatch = setAvatarCmd.match(/\[章鱼喷墨机 setAvatarByIndex:\s*(\d+)\s*\]/);
            const character = db.characters.find(c => c.id === currentChatId);
            if (cmdMatch && character && character.avatarLibrary) {
                const index = parseInt(cmdMatch[1], 10) - 1; 
                if (index >= 0 && index < character.avatarLibrary.length) {
                    const newAvatarUrl = character.avatarLibrary[index].url;
                    character.avatar = newAvatarUrl;
                    const notificationContent = `[system-display:${character.remarkName} 更换了新头像。]`;
                    const notificationMessage = { id: `msg_sys_${Date.now()}`, role: 'system', content: notificationContent, parts: [], timestamp: Date.now() };
                    chat.history.push(notificationMessage);
                    addMessageBubble(notificationMessage);

                    if (settingsSidebar.classList.contains('open')) {
                         document.getElementById('setting-char-avatar-preview').src = newAvatarUrl;
                    }
                }
            }
        }
        // --- 新增的群头像更换逻辑 ---
        else if (setGroupAvatarCmd) {
            const cmdMatch = setGroupAvatarCmd.match(/\[章鱼喷墨机 setGroupAvatarByIndex:\s*(.+?)\s*to\s*(\d+)\s*\]/);
            const group = db.groups.find(g => g.id === currentChatId);
            if (cmdMatch && group && group.avatarLibrary) {
                const initiatorRealName = cmdMatch[1].trim();
                const index = parseInt(cmdMatch[2], 10) - 1;
                const initiator = group.members.find(m => m.realName === initiatorRealName);

                if (initiator && index >= 0 && index < group.avatarLibrary.length) {
                    const newAvatarUrl = group.avatarLibrary[index].url;
                    group.avatar = newAvatarUrl;

                    const notificationContent = `[system-display:${initiator.groupNickname} 将群头像更换了。]`;
                    const notificationMessage = { id: `msg_sys_${Date.now()}`, role: 'system', content: notificationContent, parts: [], timestamp: Date.now() };
                    chat.history.push(notificationMessage);
                    addMessageBubble(notificationMessage);

                    if (groupSettingsSidebar.classList.contains('open')) {
                        document.getElementById('setting-group-avatar-preview').src = newAvatarUrl;
                    }
                }
            }
        }
    }

    if (anythingProcessed) {
        if (document.getElementById('outgoing-call-screen').classList.contains('active') && !fullResponse.includes('[videocall:accepted]') && !fullResponse.includes('[videocall:initiate')) {
            addSystemNotificationToChat(`对方无应答。`);
            switchScreen('chat-room-screen');
        }
        await saveData();
        renderChatList();
    }
}
// ▲▲▲ 替换结束 ▲▲▲

        // --- Other Sub-systems Setup (Stickers, Voice, etc.) ---
        function setupImageRecognition() {
            imageRecognitionBtn.addEventListener('click', () => {
                imageUploadInput.click();
            });
            imageUploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {
                            quality: 0.8,
                            maxWidth: 1024,
                            maxHeight: 1024
                        });
                        sendImageForRecognition(compressedUrl);
                    } catch (error) {
                        console.error('Image compression failed:', error);
                        showToast('图片处理失败，请重试');
                    } finally {
                        e.target.value = null;
                    }
                }
            });
        }

        async function setupStickerSystem() {
            // --- 原有事件监听 ---
            stickerToggleBtn.addEventListener('click', () => {
                stickerModal.classList.toggle('visible');
                if (stickerModal.classList.contains('visible')) {
                    renderStickerGrid();
                }
            });

            addNewStickerBtn.addEventListener('click', () => {
                addStickerModalTitle.textContent = '添加新表情';
                addStickerForm.reset();
                stickerEditIdInput.value = '';
                stickerPreview.innerHTML = '<span>预览</span>';
                stickerUrlInput.disabled = false;
                addStickerModal.classList.add('visible');
            });

            addStickerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = stickerNameInput.value.trim();
                const id = stickerEditIdInput.value;
                const previewImg = stickerPreview.querySelector('img');
                const data = previewImg ? previewImg.src : null;
                if (!name || !data) {
                    return showToast('请填写表情名称并提供图片');
                }
                const stickerData = { name, data };
                if (id) {
                    const index = db.myStickers.findIndex(s => s.id === id);
                    if (index > -1) {
                        db.myStickers[index] = { ...db.myStickers[index], ...stickerData };
                    }
                } else {
                    stickerData.id = `sticker_${Date.now()}`;
                    db.myStickers.push(stickerData);
                }
                await saveData();
                renderStickerGrid();
                addStickerModal.classList.remove('visible');
                showToast('表情包已保存');
            });

            stickerUrlInput.addEventListener('input', (e) => {
                const url = e.target.value.trim();
                if (url) {
                    stickerPreview.innerHTML = `<img src="${url}" alt="预览">`;
                    stickerFileUpload.value = '';
                }
            });

            stickerFileUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 200, maxHeight: 200 });
                        stickerPreview.innerHTML = `<img src="${compressedUrl}" alt="预览">`;
                        stickerUrlInput.value = '';
                        stickerUrlInput.disabled = true;
                    } catch (error) {
                        console.error('表情包压缩失败:', error);
                        showToast('表情包压缩失败，请重试');
                    }
                }
            });

            editStickerBtn.addEventListener('click', () => {
                if (!currentStickerActionTarget) return;
                const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
                if (sticker) {
                    addStickerModalTitle.textContent = '编辑表情';
                    stickerEditIdInput.value = sticker.id;
                    stickerNameInput.value = sticker.name;
                    stickerPreview.innerHTML = `<img src="${sticker.data}" alt="预览">`;
                    if (sticker.data.startsWith('http')) {
                        stickerUrlInput.value = sticker.data;
                        stickerUrlInput.disabled = false;
                    } else {
                        stickerUrlInput.value = '';
                        stickerUrlInput.disabled = true;
                    }
                    addStickerModal.classList.add('visible');
                }
                stickerActionSheet.classList.remove('visible');
                currentStickerActionTarget = null;
            });

            deleteStickerBtn.addEventListener('click', async () => {
                if (!currentStickerActionTarget) return;
                const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
                if (sticker) {
                    if (confirm(`确定要删除表情“${sticker.name}”吗？`)) {
                        db.myStickers = db.myStickers.filter(s => s.id !== currentStickerActionTarget);
                        await saveData();
                        renderStickerGrid();
                        showToast('表情已删除');
                    }
                }
                stickerActionSheet.classList.remove('visible');
                currentStickerActionTarget = null;
            });

            // --- 批量导入功能 ---
            const batchImportBtn = document.getElementById('batch-import-sticker-btn');
            const batchImportModal = document.getElementById('batch-import-sticker-modal');
            const batchImportForm = document.getElementById('batch-import-sticker-form');
            const batchImportText = document.getElementById('batch-import-text');

            batchImportBtn.addEventListener('click', () => {
                batchImportText.value = ''; // 清空文本框
                batchImportModal.classList.add('visible');
            });

            batchImportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = batchImportText.value.trim();
                if (!text) {
                    showToast('请输入内容');
                    return;
                }

                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                if (lines.length < 2) {
                    showToast('格式错误，至少需要一行URL模板和一行表情信息');
                    return;
                }

                let baseUrl = lines.shift();
                if (!baseUrl.startsWith('http')) {
                    showToast('第一行必须是有效的URL模板');
                    return;
                }
                
                let importedCount = 0;
                let errorCount = 0;

                lines.forEach(line => {
                    // 修改点：更新了正则表达式，不再需要空格
                    const match = line.match(/^(.*?)([\w-]+\.\w+)$/);
                    
                    if (match && match[1] && match[2]) {
                        const name = match[1].trim();
                        const code = match[2].trim();
                        const fullUrl = baseUrl.replace(/填入代表不同情绪的代码/, code);
                        
                        // 检查是否已存在同名表情
                        if (!db.myStickers.some(s => s.name === name)) {
                            db.myStickers.push({
                                id: `sticker_${Date.now()}_${Math.random()}`,
                                name: name,
                                data: fullUrl
                            });
                            importedCount++;
                        }
                    } else {
                        errorCount++;
                    }
                });

                if (importedCount > 0) {
                    await saveData();
                    renderStickerGrid();
                }

                let resultMessage = `成功导入 ${importedCount} 个表情包。`;
                if (errorCount > 0) {
                    resultMessage += `有 ${errorCount} 行格式错误，已跳过。`;
                }
                showToast(resultMessage);
                batchImportModal.classList.remove('visible');
            });
        }

        function renderStickerGrid() {
            stickerGridContainer.innerHTML = '';
            if (db.myStickers.length === 0) {
                stickerGridContainer.innerHTML = '<p style="color:#aaa; text-align:center;">还没有表情包，快去添加吧！</p>';
                return;
            }
            db.myStickers.forEach(sticker => {
                const item = document.createElement('div');
                item.className = 'sticker-item';
                item.innerHTML = `<img src="${sticker.data}" alt="${sticker.name}"><span>${sticker.name}</span>`;
                item.addEventListener('click', () => sendSticker(sticker));
                item.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return;
                    e.stopPropagation();
                    longPressTimer = setTimeout(() => {
                        handleStickerLongPress(sticker.id);
                    }, 500);
                });
                item.addEventListener('mouseup', () => clearTimeout(longPressTimer));
                item.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
                item.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                    longPressTimer = setTimeout(() => {
                        handleStickerLongPress(sticker.id);
                    }, 500);
                });
                item.addEventListener('touchend', () => clearTimeout(longPressTimer));
                item.addEventListener('touchmove', () => clearTimeout(longPressTimer));
                stickerGridContainer.appendChild(item);
            });
        }

        function handleStickerLongPress(stickerId) {
            clearTimeout(longPressTimer);
            currentStickerActionTarget = stickerId;
            stickerActionSheet.classList.add('visible');
        }

        function setupVoiceMessageSystem() {
            voiceMessageBtn.addEventListener('click', () => {
                sendVoiceForm.reset();
                voiceDurationPreview.textContent = '0"';
                sendVoiceModal.classList.add('visible');
            });
            sendVoiceForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyVoiceMessage(voiceTextInput.value.trim());
            });
        }

        function setupPhotoVideoSystem() {
            photoVideoBtn.addEventListener('click', () => {
                sendPvForm.reset();
                sendPvModal.classList.add('visible');
            });
            sendPvForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyPhotoVideo(pvTextInput.value.trim());
            });
        }

        function setupWalletSystem() {
            walletBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    sendTransferForm.reset();
                    sendTransferModal.classList.add('visible');
                } else if (currentChatType === 'group') {
                    currentGroupAction.type = 'transfer';
                    renderGroupRecipientSelectionList('转账给');
                    groupRecipientSelectionModal.classList.add('visible');
                }
            });
            sendTransferForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = transferAmountInput.value;
                const remark = transferRemarkInput.value.trim();
                if (amount > 0) {
                    sendMyTransfer(amount, remark);
                } else {
                    showToast('请输入有效的金额');
                }
            });
            acceptTransferBtn.addEventListener('click', () => respondToTransfer('received'));
            returnTransferBtn.addEventListener('click', () => respondToTransfer('returned'));
        }

        function handleReceivedTransferClick(messageId) {
            currentTransferMessageId = messageId;
            receiveTransferActionSheet.classList.add('visible');
        }

        async function respondToTransfer(action) {
            if (!currentTransferMessageId) return;
            const character = db.characters.find(c => c.id === currentChatId);
            const message = character.history.find(m => m.id === currentTransferMessageId);
            if (message) {
                message.transferStatus = action;
                const cardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${currentTransferMessageId}"] .transfer-card`);
                if (cardOnScreen) {
                    cardOnScreen.classList.remove('received', 'returned');
                    cardOnScreen.classList.add(action);
                    cardOnScreen.querySelector('.transfer-status').textContent = action === 'received' ? '已收款' : '已退回';
                    cardOnScreen.style.cursor = 'default';
                }
                let contextMessageContent = (action === 'received') ? `[${character.myName}接收${character.realName}的转账]` : `[${character.myName}退回${character.realName}的转账]`;
                const contextMessage = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: contextMessageContent,
                    parts: [{type: 'text', text: contextMessageContent}],
                    timestamp: Date.now()
                };
                character.history.push(contextMessage);
                await saveData();
                renderChatList();
            }
            receiveTransferActionSheet.classList.remove('visible');
            currentTransferMessageId = null;
        }

        function setupGiftSystem() {
            giftBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    sendGiftForm.reset();
                    sendGiftModal.classList.add('visible');
                } else if (currentChatType === 'group') {
                    currentGroupAction.type = 'gift';
                    renderGroupRecipientSelectionList('送礼物给');
                    groupRecipientSelectionModal.classList.add('visible');
                }
            });
            sendGiftForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyGift(giftDescriptionInput.value.trim());
            });
        }

        function setupFontSettingsApp() {
            fontUrlInput.value = db.fontUrl;
            fontSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newFontUrl = fontUrlInput.value.trim();
                db.fontUrl = newFontUrl;
                await saveData();
                applyGlobalFont(newFontUrl);
                showToast('新字体已应用！');
            });
            restoreDefaultFontBtn.addEventListener('click', async () => {
                fontUrlInput.value = '';
                db.fontUrl = '';
                await saveData();
                applyGlobalFont('');
                showToast('已恢复默认字体！');
            });
        }
        function applyGlobalCustomCss(css) {
            const styleId = 'global-custom-style';
            let styleElement = document.getElementById(styleId);

            if (css) {
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = styleId;
                    document.head.appendChild(styleElement);
                }
                styleElement.innerHTML = css;
            } else {
                if (styleElement) {
                    styleElement.remove();
                }
            }
        }
        function applyGlobalFont(fontUrl) {
            const styleId = 'global-font-style';
            let styleElement = document.getElementById(styleId);
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = styleId;
                document.head.appendChild(styleElement);
            }
            if (fontUrl) {
                const fontName = 'CustomGlobalFont';
                styleElement.innerHTML = `@font-face { font-family: '${fontName}'; src: url('${fontUrl}'); } :root { --font-family: '${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`;
            } else {
                styleElement.innerHTML = `:root { --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`;
            }
        }

        function setupWorldBookApp() {
            addWorldBookBtn.addEventListener('click', () => {
                currentEditingWorldBookId = null;
                editWorldBookForm.reset();
                document.querySelector('input[name="world-book-position"][value="before"]').checked = true;
                switchScreen('edit-world-book-screen');
            });
            editWorldBookForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = worldBookNameInput.value.trim();
                const content = worldBookContentInput.value.trim();
                const position = document.querySelector('input[name="world-book-position"]:checked').value;
                if (!name || !content) return showToast('名称和内容不能为空');
                if (currentEditingWorldBookId) {
                    const book = db.worldBooks.find(wb => wb.id === currentEditingWorldBookId);
                    if (book) {
                        book.name = name;
                        book.content = content;
                        book.position = position;
                    }
                } else {
                    db.worldBooks.push({id: `wb_${Date.now()}`, name, content, position});
                }
                await saveData();
                showToast('世界书条目已保存');
                renderWorldBookList();
                switchScreen('world-book-screen');
            });
            worldBookListContainer.addEventListener('click', e => {
                const item = e.target.closest('.world-book-item');
                if (item) {
                    const book = db.worldBooks.find(wb => wb.id === item.dataset.id);
                    if (book) {
                        currentEditingWorldBookId = book.id;
                        worldBookIdInput.value = book.id;
                        worldBookNameInput.value = book.name;
                        worldBookContentInput.value = book.content;
                        document.querySelector(`input[name="world-book-position"][value="${book.position}"]`).checked = true;
                        switchScreen('edit-world-book-screen');
                    }
                }
            });
            worldBookListContainer.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                const item = e.target.closest('.world-book-item');
                if (!item) return;
                longPressTimer = setTimeout(() => {
                    const bookId = item.dataset.id;
                    const menuItems = [{
                        label: '删除',
                        danger: true,
                        action: async () => {
                            if (confirm('确定要删除这个世界书条目吗？')) {
                                db.worldBooks = db.worldBooks.filter(wb => wb.id !== bookId);
                                db.characters.forEach(char => {
                                    char.worldBookIds = (char.worldBookIds || []).filter(id => id !== bookId);
                                });
                                db.groups.forEach(group => {
                                    group.worldBookIds = (group.worldBookIds || []).filter(id => id !== bookId);
                                });
                                await saveData();
                                renderWorldBookList();
                                showToast('条目已删除');
                            }
                        }
                    }];
                    createContextMenu(menuItems, e.clientX, e.clientY);
                }, 500);
            });
            worldBookListContainer.addEventListener('mouseup', () => clearTimeout(longPressTimer));
            worldBookListContainer.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
        }

        function renderWorldBookList() {
            worldBookListContainer.innerHTML = '';
            noWorldBooksPlaceholder.style.display = db.worldBooks.length === 0 ? 'block' : 'none';
            db.worldBooks.forEach(book => {
                const li = document.createElement('li');
                li.className = 'list-item world-book-item';
                li.dataset.id = book.id;
                li.innerHTML = `<div class="item-details" style="padding-left: 20px;"><div class="item-name">${book.name}</div><div class="item-preview">${book.content}</div></div>`;
                worldBookListContainer.appendChild(li);
            });
        }
// ▼▼▼ 从这里开始，添加新代码块 ▼▼▼
        // --- 预设库功能函数 ---
        function renderPresetDropdown(targetSelectId = 'setting-my-preset') {
            const presetSelect = document.getElementById(targetSelectId);
            if (!presetSelect) return; // 如果找不到元素则退出
            const currentValue = presetSelect.value;
            presetSelect.innerHTML = '<option value="">选择一个预设...</option>';
            db.userPresets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.presetName;
                presetSelect.appendChild(option);
            });
            presetSelect.value = currentValue; // 尝试恢复之前选中的值
        }

        function applyPreset(presetId) {
            const preset = db.userPresets.find(p => p.id === presetId);
            if (preset) {
                document.getElementById('setting-my-avatar-preview').src = preset.avatar;
                document.getElementById('setting-my-name').value = preset.name;
                document.getElementById('setting-my-persona').value = preset.persona;
                showToast(`已应用预设：“${preset.presetName}”`);
            }
        }

        function renderPresetManagerList() {
            const listContainer = document.getElementById('preset-manager-list');
            listContainer.innerHTML = '';
            if (db.userPresets.length === 0) {
                listContainer.innerHTML = '<li class="placeholder-text" style="text-align: center; padding: 20px;">还没有任何预设</li>';
                return;
            }
            db.userPresets.forEach(preset => {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.style.justifyContent = 'space-between';
                li.innerHTML = `
                    <div class="item-details" style="display: flex; align-items: center; gap: 15px;">
                        <img src="${preset.avatar}" alt="${preset.presetName}" class="chat-avatar">
                        <div class="item-name">${preset.presetName}</div>
                    </div>
                    <div class="action-btn-group">
                        <button type="button" class="btn btn-secondary btn-small edit-preset-btn" data-id="${preset.id}">编辑</button>
                        <button type="button" class="btn btn-danger btn-small delete-preset-btn" data-id="${preset.id}">删除</button>
                    </div>
                `;
                listContainer.appendChild(li);
            });
        }

        function openAddEditPresetModal(presetId = null) {
            const modal = document.getElementById('edit-preset-modal');
            const form = document.getElementById('edit-preset-form');
            form.reset();

            const title = document.getElementById('edit-preset-modal-title');
            const idInput = document.getElementById('editing-preset-id');
            const nameInput = document.getElementById('preset-name');
            const avatarPreview = document.getElementById('preset-my-avatar-preview');
            const myNameInput = document.getElementById('preset-my-name');
            const myPersonaInput = document.getElementById('preset-my-persona');
            const avatarUploadInput = document.getElementById('preset-my-avatar-upload');
            avatarUploadInput.value = ''; // 重置文件输入

            if (presetId) {
                const preset = db.userPresets.find(p => p.id === presetId);
                if (preset) {
                    title.textContent = '编辑预设';
                    idInput.value = preset.id;
                    nameInput.value = preset.presetName;
                    avatarPreview.src = preset.avatar;
                    myNameInput.value = preset.name;
                    myPersonaInput.value = preset.persona;
                }
            } else {
                title.textContent = '创建新预设';
                idInput.value = '';
                avatarPreview.src = 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg'; // 默认头像
            }

            document.getElementById('preset-library-modal').classList.remove('visible');
            modal.classList.add('visible');
        }

        async function handlePresetFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('editing-preset-id').value;
            const presetName = document.getElementById('preset-name').value.trim();
            if (!presetName) {
                showToast('预设名称不能为空');
                return;
            }

            const newPresetData = {
                presetName: presetName,
                avatar: document.getElementById('preset-my-avatar-preview').src,
                name: document.getElementById('preset-my-name').value,
                persona: document.getElementById('preset-my-persona').value
            };

            if (id) { // 编辑现有预设
                const index = db.userPresets.findIndex(p => p.id === id);
                if (index > -1) {
                    db.userPresets[index] = { ...db.userPresets[index], ...newPresetData };
                }
            } else { // 创建新预设
                newPresetData.id = `preset_${Date.now()}`;
                db.userPresets.push(newPresetData);
            }

            await saveData();
            showToast('预设已保存');
            document.getElementById('edit-preset-modal').classList.remove('visible');
            renderPresetDropdown();
        }
        // ▲▲▲ 新增代码块到此结束 ▲▲▲

        function setupChatSettings() {
            const themeSelect = document.getElementById('setting-theme-color');
            themeSelect.innerHTML = '';
            Object.keys(colorThemes).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = colorThemes[key].name;
                themeSelect.appendChild(option);
            });
            // ▼▼▼ 从这里开始，添加新代码 ▼▼▼
            const presetSelect = document.getElementById('setting-my-preset');
            const managePresetsBtn = document.getElementById('manage-presets-btn');
            const saveCurrentAsPresetBtn = document.getElementById('save-current-as-preset-btn');
            const presetLibraryModal = document.getElementById('preset-library-modal');
            const presetManagerList = document.getElementById('preset-manager-list');
            const addNewPresetBtn = document.getElementById('add-new-preset-btn');
            const editPresetModal = document.getElementById('edit-preset-modal');
            const editPresetForm = document.getElementById('edit-preset-form');
            const presetAvatarPreview = document.getElementById('preset-my-avatar-preview');
            const presetAvatarUpload = document.getElementById('preset-my-avatar-upload');

            // 打开设置时，渲染预设下拉菜单
            chatSettingsBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    renderPresetDropdown();
                }
            });

            // 应用选中的预设
            presetSelect.addEventListener('change', (e) => {
                if (e.target.value) {
                    applyPreset(e.target.value);
                }
                 e.target.value = ""; // 每次选择后重置，以便可以重复选择同一个选项
            });

            // 打开预设管理弹窗
            managePresetsBtn.addEventListener('click', () => {
                renderPresetManagerList();
                presetLibraryModal.classList.add('visible');
            });
            
            // 点击弹窗外部区域关闭管理弹窗
            presetLibraryModal.addEventListener('click', (e) => {
                if (e.target === presetLibraryModal) {
                    presetLibraryModal.classList.remove('visible');
                }
            });

            // 处理管理列表内的点击事件 (编辑, 删除)
            presetManagerList.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-preset-btn');
                const deleteBtn = e.target.closest('.delete-preset-btn');
                if (editBtn) {
                    openAddEditPresetModal(editBtn.dataset.id);
                }
                if (deleteBtn) {
                    const presetId = deleteBtn.dataset.id;
                    const preset = db.userPresets.find(p => p.id === presetId);
                    if (confirm(`确定要删除预设“${preset.presetName}”吗？`)) {
                        db.userPresets = db.userPresets.filter(p => p.id !== presetId);
                        await saveData();
                        showToast('预设已删除');
                        renderPresetManagerList();
                        renderPresetDropdown();
                    }
                }
            });
            
            // 在管理弹窗中点击 "新建预设"
            addNewPresetBtn.addEventListener('click', () => {
                openAddEditPresetModal();
            });
            
            // 点击 "将当前设定存为新预设"
            saveCurrentAsPresetBtn.addEventListener('click', () => {
                openAddEditPresetModal(); // 打开一个空的 "创建" 弹窗
                // 然后用设置侧边栏的当前值填充它
                document.getElementById('preset-my-avatar-preview').src = document.getElementById('setting-my-avatar-preview').src;
                document.getElementById('preset-my-name').value = document.getElementById('setting-my-name').value;
                document.getElementById('preset-my-persona').value = document.getElementById('setting-my-persona').value;
            });

            // 处理添加/编辑预设的表单提交
            editPresetForm.addEventListener('submit', handlePresetFormSubmit);
            
            // 点击弹窗外部区域关闭编辑弹窗
            editPresetModal.addEventListener('click', (e) => {
                if (e.target === editPresetModal) {
                    editPresetModal.classList.remove('visible');
                }
            });

            // 处理在编辑弹窗内的头像上传
            presetAvatarPreview.addEventListener('click', () => presetAvatarUpload.click());
            presetAvatarUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                        presetAvatarPreview.src = compressedUrl;
                    } catch (error) {
                        showToast('头像压缩失败，请重试');
                    }
                }
            });
            // ▲▲▲ 新增代码到此结束 ▲▲▲

            chatSettingsBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    loadSettingsToSidebar();
                    settingsSidebar.classList.add('open');
                } else if (currentChatType === 'group') {
                    loadGroupSettingsToSidebar();
                    groupSettingsSidebar.classList.add('open');
                }
            });
            document.querySelector('.phone-screen').addEventListener('click', e => {
                const openSidebar = document.querySelector('.settings-sidebar.open');
                if (openSidebar && !openSidebar.contains(e.target) && !chatSettingsBtn.contains(e.target) && !e.target.closest('.modal-overlay') && !e.target.closest('.action-sheet-overlay')) {
                    openSidebar.classList.remove('open');
                }
            });

            settingsForm.addEventListener('submit', e => {
                e.preventDefault();
                saveSettingsFromSidebar();
                settingsSidebar.classList.remove('open');
            });
            const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'),
                customCssTextarea = document.getElementById('setting-custom-bubble-css'),
                resetCustomCssBtn = document.getElementById('reset-custom-bubble-css-btn'),
                privatePreviewBox = document.getElementById('private-bubble-css-preview');
            useCustomCssCheckbox.addEventListener('change', (e) => {
                customCssTextarea.disabled = !e.target.checked;
                const char = db.characters.find(c => c.id === currentChatId);
                if (char) {
                    const themeKey = char.theme || 'white_pink';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, customCssTextarea.value, !e.target.checked, theme);
                }
            });
            customCssTextarea.addEventListener('input', (e) => {
                const char = db.characters.find(c => c.id === currentChatId);
                if (char && useCustomCssCheckbox.checked) {
                    const themeKey = char.theme || 'white_pink';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, e.target.value, false, theme);
                }
            });
            resetCustomCssBtn.addEventListener('click', () => {
                const char = db.characters.find(c => c.id === currentChatId);
                if (char) {
                    customCssTextarea.value = '';
                    useCustomCssCheckbox.checked = false;
                    customCssTextarea.disabled = true;
                    const themeKey = char.theme || 'white_pink';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, '', true, theme);
                    showToast('样式已重置为默认');
                }
            });
            document.getElementById('setting-char-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('setting-char-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('头像压缩失败，请重试');
                    }
                }
            });
            document.getElementById('setting-my-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('setting-my-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('头像压缩失败，请重试');
                    }
                }
            });
            document.getElementById('setting-chat-bg-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const char = db.characters.find(c => c.id === currentChatId);
                    if (char) {
                        try {
                            const compressedUrl = await compressImage(file, {
                                quality: 0.85,
                                maxWidth: 1080,
                                maxHeight: 1920
                            });
                            char.chatBg = compressedUrl;
                            chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;
                            await saveData();
                            showToast('聊天背景已更换');
                        } catch (error) {
                            showToast('背景压缩失败，请重试');
                        }
                    }
                }
            });
            clearChatHistoryBtn.addEventListener('click', async () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                if (confirm(`你确定要清空与“${character.remarkName}”的所有聊天记录吗？这个操作是不可恢复的！`)) {
                    character.history = [];
                    await saveData();
                    renderMessages(false, true);
                    renderChatList();
                    settingsSidebar.classList.remove('open');
                    showToast('聊天记录已清空');
                }
            });
            linkWorldBookBtn.addEventListener('click', () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                worldBookSelectionList.innerHTML = '';
                db.worldBooks.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'world-book-select-item';
                    const isChecked = (character.worldBookIds || []).includes(book.id);
                    li.innerHTML = `<input type="checkbox" id="wb-select-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}><label for="wb-select-${book.id}">${book.name}</label>`;
                    worldBookSelectionList.appendChild(li);
                });
                worldBookSelectionModal.classList.add('visible');
            });

            saveWorldBookSelectionBtn.addEventListener('click', async () => {
                const selectedIds = Array.from(worldBookSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                if (currentChatType === 'private') {
                    const character = db.characters.find(c => c.id === currentChatId);
                    if (character) character.worldBookIds = selectedIds;
                } else if (currentChatType === 'group') {
                    const group = db.groups.find(g => g.id === currentChatId);
                    if (group) group.worldBookIds = selectedIds;
                }
                await saveData();
                worldBookSelectionModal.classList.remove('visible');
                showToast('世界书关联已更新');
            });
// (确保这是在 setupChatSettings 函数内部的末尾)

const manageAvatarLibraryBtn = document.getElementById('manage-avatar-library-btn');
const avatarLibraryModal = document.getElementById('avatar-library-modal');
const addAvatarUpload = document.getElementById('add-avatar-upload');
const avatarLibraryGrid = document.getElementById('avatar-library-grid');

// 打开头像库弹窗
manageAvatarLibraryBtn.addEventListener('click', () => {
    const character = db.characters.find(c => c.id === currentChatId);
    if (character) {
        renderAvatarLibrary(character);
        avatarLibraryModal.classList.add('visible');
    }
});

// 关闭弹窗
avatarLibraryModal.addEventListener('click', (e) => {
    if (e.target === avatarLibraryModal) {
        avatarLibraryModal.classList.remove('visible');
    }
});

// 上传新头像
// 上传新头像
addAvatarUpload.addEventListener('change', async (e) => {
    const files = e.target.files;
    if (!files.length) return;

    const character = db.characters.find(c => c.id === currentChatId);
    if (!character) return;

    showToast(`开始处理 ${files.length} 张图片...`);

    for (const file of files) {
        try {
            // 步骤1：压缩图片
            const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });

            // 步骤2：调用AI分析图片
            showToast(`正在让AI分析图片 ${file.name}...`);
            const aiDescription = await analyzeAndDescribeImage(compressedUrl);

            // 步骤3：将URL和描述一起存入
            if (!character.avatarLibrary) {
                character.avatarLibrary = [];
            }
            character.avatarLibrary.push({ url: compressedUrl, description: aiDescription });

            showToast(`“${aiDescription}”已添加！`);

        } catch (error) {
            console.error('头像处理或分析失败:', error);
            showToast(`图片 ${file.name} 处理失败: ${error.message}`);
        }
    }

    await saveData();
    renderAvatarLibrary(character); // 处理完所有图片后，统一渲染
    e.target.value = null; // 重置文件输入
});

// 头像库的点击事件（选择或删除）
avatarLibraryGrid.addEventListener('click', async (e) => {
    const character = db.characters.find(c => c.id === currentChatId);
    if (!character) return;

    const deleteBtn = e.target.closest('.delete-avatar-btn');
    const item = e.target.closest('.avatar-library-item');

    if (deleteBtn) {
        e.stopPropagation(); // 防止触发选择事件
        const urlToDelete = deleteBtn.parentElement.dataset.url;
        if (confirm('确定要从库中删除这张头像吗？')) {
            // 核心修改：现在我们是根据对象中的 url 属性来过滤
            character.avatarLibrary = character.avatarLibrary.filter(avatarObj => avatarObj.url !== urlToDelete);
            await saveData();
            renderAvatarLibrary(character);
            showToast('头像已删除');
        }
    } else if (item) {
        const newAvatarUrl = item.dataset.url;
        character.avatar = newAvatarUrl;
        document.getElementById('setting-char-avatar-preview').src = newAvatarUrl; // 更新设置里的预览
        await saveData();
        avatarLibraryModal.classList.remove('visible');
        renderChatList(); // 更新聊天列表的头像
        showToast('角色头像已更新！');
    }
});

// 渲染头像库内容的函数
function renderAvatarLibrary(character) {
    avatarLibraryGrid.innerHTML = '';
    if (!character.avatarLibrary || character.avatarLibrary.length === 0) {
        avatarLibraryGrid.innerHTML = '<p class="placeholder-text">这个角色的头像库是空的~</p>';
        return;
    }
    // 核心修改：现在我们遍历的是对象数组，所以要用 avatarObj.url
    character.avatarLibrary.forEach(avatarObj => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'avatar-library-item';
        itemDiv.dataset.url = avatarObj.url; // 从对象中获取 url
        itemDiv.innerHTML = `
            <img src="${avatarObj.url}" alt="${avatarObj.description}" title="${avatarObj.description}">
            <button class="delete-avatar-btn">&times;</button>
        `;
        avatarLibraryGrid.appendChild(itemDiv);
    });
}
        }

        function loadSettingsToSidebar() {
            const e = db.characters.find(e => e.id === currentChatId);
            if (e) {
                document.getElementById('setting-char-avatar-preview').src = e.avatar;
                document.getElementById('setting-char-remark').value = e.remarkName;
                document.getElementById('setting-char-persona').value = e.persona;
                document.getElementById('setting-my-avatar-preview').src = e.myAvatar;
                document.getElementById('setting-my-name').value = e.myName;
                document.getElementById('setting-my-persona').value = e.myPersona;
                document.getElementById('setting-theme-color').value = e.theme || 'white_pink';
                document.getElementById('setting-max-memory').value = e.maxMemory;
                const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'),
                    customCssTextarea = document.getElementById('setting-custom-bubble-css'),
                    privatePreviewBox = document.getElementById('private-bubble-css-preview');
                useCustomCssCheckbox.checked = e.useCustomBubbleCss || false;
                customCssTextarea.value = e.customBubbleCss || '';
                customCssTextarea.disabled = !useCustomCssCheckbox.checked;
                const theme = colorThemes[e.theme || 'white_pink'];
                updateBubbleCssPreview(privatePreviewBox, e.customBubbleCss, !e.useCustomBubbleCss, theme);
            }
        }

        async function saveSettingsFromSidebar() {
            const e = db.characters.find(e => e.id === currentChatId);
            if (e) {
                e.avatar = document.getElementById('setting-char-avatar-preview').src;
                e.remarkName = document.getElementById('setting-char-remark').value;
                e.persona = document.getElementById('setting-char-persona').value;
                e.myAvatar = document.getElementById('setting-my-avatar-preview').src;
                e.myName = document.getElementById('setting-my-name').value;
                e.myPersona = document.getElementById('setting-my-persona').value;
                e.theme = document.getElementById('setting-theme-color').value;
                e.maxMemory = document.getElementById('setting-max-memory').value;
                e.useCustomBubbleCss = document.getElementById('setting-use-custom-css').checked;
                e.customBubbleCss = document.getElementById('setting-custom-bubble-css').value;
                await saveData();
                showToast('设置已保存！');
                chatRoomTitle.textContent = e.remarkName;
                renderChatList();
                updateCustomBubbleStyle(currentChatId, e.customBubbleCss, e.useCustomBubbleCss);
                currentPage = 1;
                renderMessages(false, true);
            }
        }

// ▼▼▼ 使用这个新版本完整替换旧的 setupApiSettingsApp 函数 ▼▼▼
function setupApiSettingsApp() {
    const apiForm = document.getElementById('api-form');
    const c = {
        newapi: '',
        deepseek: 'https://api.deepseek.com',
        claude: 'https://api.anthropic.com',
        gemini: 'https://generativelanguage.googleapis.com'
    };

    // 辅助函数，用于为一个API配置区绑定事件
    const setupApiSection = (type) => {
        const providerSelect = document.getElementById(`api-provider-${type}`);
        const urlInput = document.getElementById(`api-url-${type}`);
        const keyInput = document.getElementById(`api-key-${type}`);
        const modelSelect = document.getElementById(`api-model-${type}`);
        const fetchBtn = document.getElementById(`fetch-models-btn-${type}`);
        const settings = db.apiSettings[type];

        // 1. 初始化表单
        if (settings) {
            providerSelect.value = settings.provider || 'newapi';
            urlInput.value = settings.url || '';
            keyInput.value = settings.key || '';
            if (settings.model) {
                modelSelect.innerHTML = `<option value="${settings.model}">${settings.model}</option>`;
                modelSelect.value = settings.model;
            }
        }

        // 2. 绑定服务商选择事件
        providerSelect.addEventListener('change', () => {
            urlInput.value = c[providerSelect.value] || '';
        });

        // 3. 绑定拉取模型按钮事件
        fetchBtn.addEventListener('click', async () => {
            let apiUrl = urlInput.value.trim();
            const apiKey = keyInput.value.trim();
            if (!apiUrl || !apiKey) return showToast(`请先填写${type === 'primary' ? '主' : '副'}API的地址和密钥！`);

            apiUrl.endsWith('/') && (apiUrl = apiUrl.slice(0, -1));
            const endpoint = 'gemini' === providerSelect.value ? `${apiUrl}/v1beta/models?key=${getRandomValue(apiKey)}` : `${apiUrl}/v1/models`;

            fetchBtn.classList.add('loading');
            fetchBtn.disabled = true;

            try {
                const headers = 'gemini' === providerSelect.value ? {} : { Authorization: `Bearer ${apiKey}` };
                const response = await fetch(endpoint, { method: 'GET', headers: headers });
                if (!response.ok) throw new Error(`网络响应错误: ${response.status}`);

                const json = await response.json();
                let models = [];
                if ('gemini' !== providerSelect.value && json.data) {
                    models = json.data.map(m => m.id);
                } else if ('gemini' === providerSelect.value && json.models) {
                    models = json.models.map(m => m.name.replace('models/', ''));
                }

                modelSelect.innerHTML = '';
                if (models.length > 0) {
                    models.forEach(modelId => {
                        const option = document.createElement('option');
                        option.value = modelId;
                        option.textContent = modelId;
                        modelSelect.appendChild(option);
                    });
                    // 筛选视觉模型
                    if (type === 'vision') {
                        const visionModels = models.filter(m => m.includes('vision') || m.includes('gemini-1.5-pro'));
                        if(visionModels.length > 0) {
                            modelSelect.value = visionModels[0];
                        }
                    }
                } else {
                    modelSelect.innerHTML = '<option value="">未找到任何模型</option>';
                }
                showToast(`${type === 'primary' ? '主' : '副'}模型列表拉取成功！`);
            } catch (err) {
                showToast(`拉取失败: ${err.message}`);
                modelSelect.innerHTML = '<option value="">拉取失败</option>';
            } finally {
                fetchBtn.classList.remove('loading');
                fetchBtn.disabled = false;
            }
        });
    };

    // 分别设置主API和视觉API区域
    setupApiSection('primary');
    setupApiSection('vision');

    // 统一保存
    apiForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        db.apiSettings.primary = {
            provider: document.getElementById('api-provider-primary').value,
            url: document.getElementById('api-url-primary').value,
            key: document.getElementById('api-key-primary').value,
            model: document.getElementById('api-model-primary').value
        };

        db.apiSettings.vision = {
            provider: document.getElementById('api-provider-vision').value,
            url: document.getElementById('api-url-vision').value,
            key: document.getElementById('api-key-vision').value,
            model: document.getElementById('api-model-vision').value
        };

        if (!db.apiSettings.primary.model) {
            return showToast('请选择一个主聊天模型后保存！');
        }

        await saveData();
        showToast('API设置已全部保存！');
    });
}

       function setupWallpaperApp() {
            const wallpaperUpload = document.getElementById('wallpaper-upload');
            const wallpaperPreview = document.getElementById('wallpaper-preview');
            const resetWallpaperBtn = document.getElementById('reset-wallpaper-btn');

            // 初始化预览
            wallpaperPreview.style.backgroundImage = `url(${db.wallpaper})`;
            wallpaperPreview.textContent = '';

            // 监听文件上传
            wallpaperUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {
                            quality: 0.85,
                            maxWidth: 1080,
                            maxHeight: 1920
                        });
                        db.wallpaper = compressedUrl;
                        applyWallpaper(compressedUrl);
                        wallpaperPreview.style.backgroundImage = `url(${compressedUrl})`;
                        await saveData();
                        showToast('壁纸更换成功！');
                    } catch (error) {
                        showToast('壁纸压缩失败，请重试');
                    }
                }
            });

            // 新增：监听重置按钮点击
            resetWallpaperBtn.addEventListener('click', async () => {
                if (confirm('确定要恢复为默认壁纸吗？')) {
                    const defaultWallpaper = 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg';
                    db.wallpaper = defaultWallpaper;
                    applyWallpaper(defaultWallpaper);
                    wallpaperPreview.style.backgroundImage = `url(${defaultWallpaper})`;
                    await saveData();
                    showToast('已恢复为默认壁纸。');
                }
            });
        }

        // --- GROUP CHAT FUNCTIONS ---
        function setupGroupChatSystem() {
            // ▼▼▼ 从这里开始，添加新代码 ▼▼▼
            const groupPresetSelect = document.getElementById('setting-group-my-preset');
            const manageGroupPresetsBtn = document.getElementById('manage-group-presets-btn');
            const saveCurrentGroupAsPresetBtn = document.getElementById('save-current-group-as-preset-btn');
            
            // 为群聊的“管理”按钮添加事件监听
            manageGroupPresetsBtn.addEventListener('click', () => {
                renderPresetManagerList();
                document.getElementById('preset-library-modal').classList.add('visible');
            });

            // 应用选中的预设到群聊设置
            groupPresetSelect.addEventListener('change', (e) => {
                const presetId = e.target.value;
                if (presetId) {
                    const preset = db.userPresets.find(p => p.id === presetId);
                    if (preset) {
                        document.getElementById('setting-group-my-avatar-preview').src = preset.avatar;
                        document.getElementById('setting-group-my-nickname').value = preset.name;
                        document.getElementById('setting-group-my-persona').value = preset.persona;
                        showToast(`已应用预设：“${preset.presetName}”`);
                    }
                }
                e.target.value = ""; // 重置下拉菜单
            });

            // 将群聊当前设定保存为新预设
            saveCurrentGroupAsPresetBtn.addEventListener('click', () => {
                openAddEditPresetModal(); // 打开空的创建弹窗
                // 用群聊设置的当前值填充它
                document.getElementById('preset-my-avatar-preview').src = document.getElementById('setting-group-my-avatar-preview').src;
                document.getElementById('preset-my-name').value = document.getElementById('setting-group-my-nickname').value;
                document.getElementById('preset-my-persona').value = document.getElementById('setting-group-my-persona').value;
            });
            // ▲▲▲ 新增代码到此结束 ▲▲▲
            createGroupBtn.addEventListener('click', () => {
                renderMemberSelectionList();
                createGroupModal.classList.add('visible');
            });
            createGroupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedMemberIds = Array.from(memberSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                const groupName = groupNameInput.value.trim();
                if (selectedMemberIds.length < 1) return showToast('请至少选择一个群成员。');
                if (!groupName) return showToast('请输入群聊名称。');
                const firstChar = db.characters.length > 0 ? db.characters[0] : null;
                const newGroup = {
                    id: `group_${Date.now()}`,
                    name: groupName,
                    avatar: 'https://i.postimg.cc/fTLCngk1/image.jpg',
                    me: {
                        nickname: firstChar ? firstChar.myName : '我',
                        persona: firstChar ? firstChar.myPersona : '',
                        avatar: firstChar ? firstChar.myAvatar : 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg'
                    },
                    members: selectedMemberIds.map(charId => {
                        const char = db.characters.find(c => c.id === charId);
                        return {
                            id: `member_${char.id}`,
                            originalCharId: char.id,
                            realName: char.realName,
                            groupNickname: char.remarkName,
                            persona: char.persona,
                            avatar: char.avatar
                        };
                    }),
                    theme: 'white_pink',
                    maxMemory: 10,
                    chatBg: '',
                    history: [],
                    isPinned: false,
                    avatarLibrary: [], // <--- 添加这一行
                    useCustomBubbleCss: false,
                    customBubbleCss: '',
                    worldBookIds: []
                };
                db.groups.push(newGroup);
                await saveData();
                renderChatList();
                createGroupModal.classList.remove('visible');
                showToast(`群聊“${groupName}”创建成功！`);
            });
            groupSettingsForm.addEventListener('submit', e => {
                e.preventDefault();
                saveGroupSettingsFromSidebar();
                groupSettingsSidebar.classList.remove('open');
            });
            const useGroupCustomCssCheckbox = document.getElementById('setting-group-use-custom-css'),
                groupCustomCssTextarea = document.getElementById('setting-group-custom-bubble-css'),
                resetGroupCustomCssBtn = document.getElementById('reset-group-custom-bubble-css-btn'),
                groupPreviewBox = document.getElementById('group-bubble-css-preview');
            useGroupCustomCssCheckbox.addEventListener('change', (e) => {
                groupCustomCssTextarea.disabled = !e.target.checked;
                const group = db.groups.find(g => g.id === currentChatId);
                if (group) {
                    const theme = colorThemes[group.theme || 'white_pink'];
                    updateBubbleCssPreview(groupPreviewBox, groupCustomCssTextarea.value, !e.target.checked, theme);
                }
            });
            groupCustomCssTextarea.addEventListener('input', (e) => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (group && useGroupCustomCssCheckbox.checked) {
                    const theme = colorThemes[group.theme || 'white_pink'];
                    updateBubbleCssPreview(groupPreviewBox, e.target.value, false, theme);
                }
            });
            resetGroupCustomCssBtn.addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (group) {
                    groupCustomCssTextarea.value = '';
                    useGroupCustomCssCheckbox.checked = false;
                    groupCustomCssTextarea.disabled = true;
                    const theme = colorThemes[group.theme || 'white_pink'];
                    updateBubbleCssPreview(groupPreviewBox, '', true, theme);
                    showToast('样式已重置为默认');
                }
            });
            document.getElementById('setting-group-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        const group = db.groups.find(g => g.id === currentChatId);
                        if (group) {
                            group.avatar = compressedUrl;
                            document.getElementById('setting-group-avatar-preview').src = compressedUrl;
                        }
                    } catch (error) {
                        showToast('群头像压缩失败，请重试');
                    }
                }
            });
            document.getElementById('setting-group-chat-bg-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {
                            quality: 0.85,
                            maxWidth: 1080,
                            maxHeight: 1920
                        });
                        const group = db.groups.find(g => g.id === currentChatId);
                        if (group) {
                            group.chatBg = compressedUrl;
                            chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;
                            await saveData();
                            showToast('聊天背景已更换');
                        }
                    } catch (error) {
                        showToast('群聊背景压缩失败，请重试');
                    }
                }
            });
            document.getElementById('clear-group-chat-history-btn').addEventListener('click', async () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                if (confirm(`你确定要清空群聊“${group.name}”的所有聊天记录吗？这个操作是不可恢复的！`)) {
                    group.history = [];
                    await saveData();
                    renderMessages(false, true);
                    renderChatList();
                    groupSettingsSidebar.classList.remove('open');
                    showToast('聊天记录已清空');
                }
            });
            groupMembersListContainer.addEventListener('click', e => {
                const memberDiv = e.target.closest('.group-member');
                const addBtn = e.target.closest('.add-member-btn');
                if (memberDiv) {
                    openGroupMemberEditModal(memberDiv.dataset.id);
                } else if (addBtn) {
                    addMemberActionSheet.classList.add('visible');
                }
            });
            document.getElementById('edit-member-avatar-preview').addEventListener('click', () => {
                document.getElementById('edit-member-avatar-upload').click();
            });
            document.getElementById('edit-member-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('edit-member-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('成员头像压缩失败，请重试');
                    }
                }
            });
            editGroupMemberForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const memberId = document.getElementById('editing-member-id').value;
                const group = db.groups.find(g => g.id === currentChatId);
                const member = group.members.find(m => m.id === memberId);
                if (member) {
                    member.avatar = document.getElementById('edit-member-avatar-preview').src;
                    member.groupNickname = document.getElementById('edit-member-group-nickname').value;
                    member.realName = document.getElementById('edit-member-real-name').value;
                    member.persona = document.getElementById('edit-member-persona').value;
                    await saveData();
                    renderGroupMembersInSettings(group);
                    document.querySelectorAll(`.message-wrapper[data-sender-id="${member.id}"] .group-nickname`).forEach(el => {
                        el.textContent = member.groupNickname;
                    });
                    showToast('成员信息已更新');
                }
                editGroupMemberModal.classList.remove('visible');
            });
            inviteExistingMemberBtn.addEventListener('click', () => {
                renderInviteSelectionList();
                inviteMemberModal.classList.add('visible');
                addMemberActionSheet.classList.remove('visible');
            });
            createNewMemberBtn.addEventListener('click', () => {
                createMemberForGroupForm.reset();
                document.getElementById('create-group-member-avatar-preview').src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                createMemberForGroupModal.classList.add('visible');
                addMemberActionSheet.classList.remove('visible');
            });
            document.getElementById('create-group-member-avatar-preview').addEventListener('click', () => {
                document.getElementById('create-group-member-avatar-upload').click();
            });
            document.getElementById('create-group-member-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('create-group-member-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('新成员头像压缩失败，请重试');
                    }
                }
            });
            confirmInviteBtn.addEventListener('click', async () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                const selectedCharIds = Array.from(inviteMemberSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                selectedCharIds.forEach(charId => {
                    const char = db.characters.find(c => c.id === charId);
                    if (char) {
                        const newMember = {
                            id: `member_${char.id}`,
                            originalCharId: char.id,
                            realName: char.realName,
                            groupNickname: char.remarkName,
                            persona: char.persona,
                            avatar: char.avatar
                        };
                        group.members.push(newMember);
                        sendInviteNotification(group, newMember.realName);
                    }
                });
                if (selectedCharIds.length > 0) {
                    await saveData();
                    renderGroupMembersInSettings(group);
                    renderMessages(false, true);
                    showToast('已邀请新成员');
                }
                inviteMemberModal.classList.remove('visible');
            });
            createMemberForGroupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                const newMember = {
                    id: `member_group_only_${Date.now()}`,
                    originalCharId: null,
                    realName: document.getElementById('create-group-member-realname').value,
                    groupNickname: document.getElementById('create-group-member-nickname').value,
                    persona: document.getElementById('create-group-member-persona').value,
                    avatar: document.getElementById('create-group-member-avatar-preview').src,
                };
                group.members.push(newMember);
                sendInviteNotification(group, newMember.realName);
                await saveData();
                renderGroupMembersInSettings(group);
                renderMessages(false, true);
                showToast(`新成员 ${newMember.groupNickname} 已加入`);
                createMemberForGroupModal.classList.remove('visible');
            });
            document.getElementById('setting-group-my-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('setting-group-my-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('头像压缩失败')
                    }
                }
            });
            confirmGroupRecipientBtn.addEventListener('click', () => {
                const selectedRecipientIds = Array.from(groupRecipientSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                if (selectedRecipientIds.length === 0) {
                    return showToast('请至少选择一个收件人。');
                }
                currentGroupAction.recipients = selectedRecipientIds;
                groupRecipientSelectionModal.classList.remove('visible');

                if (currentGroupAction.type === 'transfer') {
                    sendTransferForm.reset();
                    sendTransferModal.classList.add('visible');
                } else if (currentGroupAction.type === 'gift') {
                    sendGiftForm.reset();
                    sendGiftModal.classList.add('visible');
                }
            });
            linkGroupWorldBookBtn.addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                worldBookSelectionList.innerHTML = '';
                db.worldBooks.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'world-book-select-item';
                    const isChecked = (group.worldBookIds || []).includes(book.id);
                    li.innerHTML = `<input type="checkbox" id="wb-select-group-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}><label for="wb-select-group-${book.id}">${book.name}</label>`;
                    worldBookSelectionList.appendChild(li);
                });
                worldBookSelectionModal.classList.add('visible');
            });
// (确保这是在 setupGroupChatSystem 函数内部的末尾)

const manageGroupAvatarLibraryBtn = document.getElementById('manage-group-avatar-library-btn');
const groupAvatarLibraryModal = document.getElementById('group-avatar-library-modal');
const addGroupAvatarUpload = document.getElementById('add-group-avatar-upload');
const groupAvatarLibraryGrid = document.getElementById('group-avatar-library-grid');

// 打开群头像库弹窗
manageGroupAvatarLibraryBtn.addEventListener('click', () => {
    const group = db.groups.find(g => g.id === currentChatId);
    if (group) {
        renderGroupAvatarLibrary(group);
        groupAvatarLibraryModal.classList.add('visible');
    }
});

// 关闭弹窗
groupAvatarLibraryModal.addEventListener('click', (e) => {
    if (e.target === groupAvatarLibraryModal) {
        groupAvatarLibraryModal.classList.remove('visible');
    }
});

// 上传新群头像
addGroupAvatarUpload.addEventListener('change', async (e) => {
    const files = e.target.files;
    if (!files.length) return;

    const group = db.groups.find(g => g.id === currentChatId);
    if (!group) return;

    showToast(`开始处理 ${files.length} 张图片...`);

    for (const file of files) {
        try {
            const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
            showToast(`正在让AI分析图片 ${file.name}...`);
            const aiDescription = await analyzeAndDescribeImage(compressedUrl);

            if (!group.avatarLibrary) group.avatarLibrary = [];
            group.avatarLibrary.push({ url: compressedUrl, description: aiDescription });
            showToast(`“${aiDescription}”已添加！`);
        } catch (error) {
            showToast(`图片 ${file.name} 处理失败: ${error.message}`);
        }
    }

    await saveData();
    renderGroupAvatarLibrary(group);
    e.target.value = null;
});

// 群头像库的点击事件（选择或删除）
groupAvatarLibraryGrid.addEventListener('click', async (e) => {
    const group = db.groups.find(g => g.id === currentChatId);
    if (!group) return;

    const deleteBtn = e.target.closest('.delete-avatar-btn');
    const item = e.target.closest('.avatar-library-item');

    if (deleteBtn) {
        e.stopPropagation();
        const urlToDelete = deleteBtn.parentElement.dataset.url;
        if (confirm('确定要从库中删除这张群头像吗？')) {
            group.avatarLibrary = group.avatarLibrary.filter(avatarObj => avatarObj.url !== urlToDelete);
            await saveData();
            renderGroupAvatarLibrary(group);
            showToast('群头像已删除');
        }
    } else if (item) {
        const newAvatarUrl = item.dataset.url;
        group.avatar = newAvatarUrl;
        document.getElementById('setting-group-avatar-preview').src = newAvatarUrl;
        await saveData();
        groupAvatarLibraryModal.classList.remove('visible');
        renderChatList();
        showToast('群头像已更新！');
    }
});

// 渲染群头像库内容的函数
function renderGroupAvatarLibrary(group) {
    groupAvatarLibraryGrid.innerHTML = '';
    if (!group.avatarLibrary || group.avatarLibrary.length === 0) {
        groupAvatarLibraryGrid.innerHTML = '<p class="placeholder-text">这个群的头像库是空的~</p>';
        return;
    }
    group.avatarLibrary.forEach(avatarObj => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'avatar-library-item';
        itemDiv.dataset.url = avatarObj.url;
        itemDiv.innerHTML = `
            <img src="${avatarObj.url}" alt="${avatarObj.description}" title="${avatarObj.description}">
            <button class="delete-avatar-btn">&times;</button>
        `;
        groupAvatarLibraryGrid.appendChild(itemDiv);
    });
}
        }

        function renderMemberSelectionList() {
            memberSelectionList.innerHTML = '';
            if (db.characters.length === 0) {
                memberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可选择的人设。</li>';
                return;
            }
            db.characters.forEach(char => {
                const li = document.createElement('li');
                li.className = 'member-selection-item';
                li.innerHTML = `<input type="checkbox" id="select-${char.id}" value="${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><label for="select-${char.id}">${char.remarkName}</label>`;
                memberSelectionList.appendChild(li);
            });
        }

        function loadGroupSettingsToSidebar() {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const themeSelect = document.getElementById('setting-group-theme-color');
            if (themeSelect.options.length === 0) {
                Object.keys(colorThemes).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = colorThemes[key].name;
                    themeSelect.appendChild(option);
                });
            }
            document.getElementById('setting-group-avatar-preview').src = group.avatar;
            document.getElementById('setting-group-name').value = group.name;
            document.getElementById('setting-group-my-avatar-preview').src = group.me.avatar;
            document.getElementById('setting-group-my-nickname').value = group.me.nickname;
            document.getElementById('setting-group-my-persona').value = group.me.persona;
            themeSelect.value = group.theme || 'white_pink';
            document.getElementById('setting-group-max-memory').value = group.maxMemory;
            renderGroupMembersInSettings(group);
            const useGroupCustomCssCheckbox = document.getElementById('setting-group-use-custom-css'),
                groupCustomCssTextarea = document.getElementById('setting-group-custom-bubble-css'),
                groupPreviewBox = document.getElementById('group-bubble-css-preview');
            useGroupCustomCssCheckbox.checked = group.useCustomBubbleCss || false;
            groupCustomCssTextarea.value = group.customBubbleCss || '';
            groupCustomCssTextarea.disabled = !useGroupCustomCssCheckbox.checked;
            const theme = colorThemes[group.theme || 'white_pink'];
            updateBubbleCssPreview(groupPreviewBox, group.customBubbleCss, !group.useCustomBubbleCss, theme);
             renderPresetDropdown('setting-group-my-preset'); 
        }

        function renderGroupMembersInSettings(group) {
            groupMembersListContainer.innerHTML = '';
            group.members.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'group-member';
                memberDiv.dataset.id = member.id;
                memberDiv.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><span>${member.groupNickname}</span>`;
                groupMembersListContainer.appendChild(memberDiv);
            });
            const addBtn = document.createElement('div');
            addBtn.className = 'add-member-btn';
            addBtn.innerHTML = `<div class="add-icon">+</div><span>添加</span>`;
            groupMembersListContainer.appendChild(addBtn);
        }

        function renderGroupRecipientSelectionList(actionText) {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            groupRecipientSelectionTitle.textContent = actionText;
            groupRecipientSelectionList.innerHTML = '';
            group.members.forEach(member => {
                const li = document.createElement('li');
                li.className = 'group-recipient-select-item';
                li.innerHTML = `
                        <input type="checkbox" id="recipient-select-${member.id}" value="${member.id}">
                        <label for="recipient-select-${member.id}">
                            <img src="${member.avatar}" alt="${member.groupNickname}">
                            <span>${member.groupNickname}</span>
                        </label>`;
                groupRecipientSelectionList.appendChild(li);
            });
        }

        async function saveGroupSettingsFromSidebar() {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const oldName = group.name;
            const newName = document.getElementById('setting-group-name').value;
            if (oldName !== newName) {
                group.name = newName;
                sendRenameNotification(group, newName);
            }
            group.avatar = document.getElementById('setting-group-avatar-preview').src;
            group.me.avatar = document.getElementById('setting-group-my-avatar-preview').src;
            group.me.nickname = document.getElementById('setting-group-my-nickname').value;
            group.me.persona = document.getElementById('setting-group-my-persona').value;
            group.theme = document.getElementById('setting-group-theme-color').value;
            group.maxMemory = document.getElementById('setting-group-max-memory').value;
            group.useCustomBubbleCss = document.getElementById('setting-group-use-custom-css').checked;
            group.customBubbleCss = document.getElementById('setting-group-custom-bubble-css').value;
            updateCustomBubbleStyle(currentChatId, group.customBubbleCss, group.useCustomBubbleCss);
            await saveData();
            showToast('群聊设置已保存！');
            chatRoomTitle.textContent = group.name;
            renderChatList();
            renderMessages(false, true);
        }

        function openGroupMemberEditModal(memberId) {
            const group = db.groups.find(g => g.id === currentChatId);
            const member = group.members.find(m => m.id === memberId);
            if (!member) return;
            document.getElementById('edit-group-member-title').textContent = `编辑 ${member.groupNickname}`;
            document.getElementById('editing-member-id').value = member.id;
            document.getElementById('edit-member-avatar-preview').src = member.avatar;
            document.getElementById('edit-member-group-nickname').value = member.groupNickname;
            document.getElementById('edit-member-real-name').value = member.realName;
            document.getElementById('edit-member-persona').value = member.persona;
            editGroupMemberModal.classList.add('visible');
        }

        function renderInviteSelectionList() {
            inviteMemberSelectionList.innerHTML = '';
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const currentMemberCharIds = new Set(group.members.map(m => m.originalCharId));
            const availableChars = db.characters.filter(c => !currentMemberCharIds.has(c.id));
            if (availableChars.length === 0) {
                inviteMemberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可邀请的新成员了。</li>';
                confirmInviteBtn.disabled = true;
                return;
            }
            confirmInviteBtn.disabled = false;
            availableChars.forEach(char => {
                const li = document.createElement('li');
                li.className = 'invite-member-select-item';
                li.innerHTML = `<input type="checkbox" id="invite-select-${char.id}" value="${char.id}"><label for="invite-select-${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><span>${char.remarkName}</span></label>`;
                inviteMemberSelectionList.appendChild(li);
            });
        }

        function sendInviteNotification(group, newMemberRealName) {
            const messageContent = `[${group.me.nickname}邀请${newMemberRealName}加入了群聊]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: messageContent,
                parts: [{type: 'text', text: messageContent}],
                timestamp: Date.now(),
                senderId: 'user_me'
            };
            group.history.push(message);
        }

        function sendRenameNotification(group, newName) {
            const myName = group.me.nickname;
            const messageContent = `[${myName}修改群名为：${newName}]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: messageContent,
                parts: [{type: 'text', text: messageContent}],
                timestamp: Date.now()
            };
            group.history.push(message);
        }

        // ▼▼▼ START: 新增的函数，用于控制通话记录弹窗 ▼▼▼
        function setupVideoLogModal() {
            const modal = document.getElementById('video-log-modal');
            const closeBtn = document.getElementById('close-video-log-btn');

            const closeModal = () => modal.classList.remove('visible');

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
            closeBtn.addEventListener('click', closeModal);
        }

// ▼▼▼ 再次替换此函数 ▼▼▼
function showVideoChatLogModal(messageId) {
    const chat = (currentChatType === 'private')
        ? db.characters.find(c => c.id === currentChatId)
        : db.groups.find(g => g.id === currentChatId);

    if (!chat) return;
    const message = chat.history.find(m => m.id === messageId);
    
    if (!message || !message.videoChatLog || message.videoChatLog.length === 0) {
        showToast("此通话没有文字记录。");
        return;
    }

    const log = message.videoChatLog;
    const filteredLog = log.filter(msg => !msg.text.startsWith('[系统错误:'));
    const contentDiv = document.getElementById('video-log-content');
    const modal = document.getElementById('video-log-modal');
    contentDiv.innerHTML = '';
    Object.assign(contentDiv.style, {
        display: 'flex',
        flexDirection: 'column',
        gap: '8px'
    });

    filteredLog.forEach(msg => {
        let displayName;
        if (msg.sender === 'me') {
            // 对用户：总是从当前群聊数据中获取最新的昵称
            displayName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
        } else { // 对AI角色:
            if (currentChatType === 'private') {
                displayName = chat.remarkName;
            } else { // 在群聊中
                let foundMember = null;
                // 步骤1：优先使用 senderId 查找，这是最准确的方式
                if (msg.senderId) {
                    foundMember = chat.members.find(m => m.id === msg.senderId);
                }
                
                // 步骤2：如果找不到 (可能是旧的通话记录没有存ID)，则降级为使用名字匹配
                if (!foundMember) {
                    const storedName = msg.senderName;
                    foundMember = chat.members.find(m => m.groupNickname === storedName || m.realName === storedName);
                }

                if (foundMember) {
                    // 如果通过任何一种方式找到了成员，就使用他【当前】的最新昵称
                    displayName = foundMember.groupNickname;
                } else {
                    // 如果彻底找不到，说明成员可能已离开，显示记录中的旧名字
                    displayName = msg.senderName || "群成员";
                }
            }
        }
        
        const p = document.createElement('p');
        p.innerHTML = `<strong>${displayName}:</strong><br>${msg.text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}`;
        
        let bubbleStyles = {
            padding: '8px 12px',
            borderRadius: '10px',
            lineHeight: '1.5',
            maxWidth: '85%',
            wordWrap: 'break-word',
            textAlign: 'left'
        };

        if (msg.sender === 'me') {
            Object.assign(bubbleStyles, {
                alignSelf: 'flex-end',
                backgroundColor: '#E9F5D9'
            });
        } else {
            Object.assign(bubbleStyles, {
                alignSelf: 'flex-start',
                backgroundColor: '#FFFFFF',
                border: '1px solid #eee'
            });
        }
        Object.assign(p.style, bubbleStyles);
        contentDiv.appendChild(p);
    });
    modal.classList.add('visible');
}
        // ▲▲▲ END: 新增的函数 ▲▲▲
// ▼▼▼ 将这个新函数添加到 initiateVideoCallRequest 的上方 ▼▼▼
function showCallingScreen(name, avatar, isIncoming = false) {
    document.getElementById('outgoing-call-name').textContent = name;
    document.getElementById('outgoing-call-avatar').src = avatar;
    
    const statusElem = document.getElementById('outgoing-call-status');
    const outgoingControls = document.getElementById('outgoing-controls');
    const incomingControls = document.getElementById('incoming-controls');

    if (isIncoming) {
        statusElem.textContent = '视频通话来电...';
        outgoingControls.style.display = 'none';
        incomingControls.style.display = 'flex';
    } else {
        statusElem.textContent = '正在呼叫...';
        outgoingControls.style.display = 'block';
        incomingControls.style.display = 'none';
    }
    
    switchScreen('outgoing-call-screen');
}
let isRequestingVideoCall = false;
async function initiateVideoCallRequest() {
    if (isRequestingVideoCall || isGenerating) {
        showToast('正在处理上一请求，请稍候...');
        return;
    }

    const chat = (currentChatType === 'private')
        ? db.characters.find(c => c.id === currentChatId)
        : db.groups.find(g => g.id === currentChatId);
    if (!chat) return;
    
    // 使用新函数显示呼叫界面
    const calleeName = (currentChatType === 'private') ? chat.remarkName : chat.name;
    const calleeAvatar = chat.avatar;
    showCallingScreen(calleeName, calleeAvatar, false); // false 表示是拨出

    isRequestingVideoCall = true;
    try {
        const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
        const callType = (currentChatType === 'private') ? '视频通话' : '群组视频通话';
        const requestMessageContent = `[system: ${myName} 正在尝试发起${callType}。请根据你的人设，决定是接受还是拒绝。你的回复必须且只能是 [videocall:accepted] 或 [videocall:rejected:{此处填写拒绝的理由}] 这两种格式之一。]`;
        
        const message = {
            id: `msg_sys_call_${Date.now()}`,
            role: 'user',
            content: requestMessageContent,
            parts: [{ type: 'text', text: requestMessageContent }],
            timestamp: Date.now()
        };

        if (currentChatType === 'group') {
            message.senderId = 'user_me';
        }

        chat.history.push(message);
        await saveData();
        await getAiReply();

    } catch (error) {
        console.error('发起视频通话请求失败:', error);
        showToast('呼叫失败，请检查网络或API设置');
        switchScreen('chat-room-screen');
    } finally {
        // isRequestingVideoCall 状态在 processStream 中重置
    }
}
// 用下面的代码块，替换掉您文件中已有的整个 setupVideoCallSystem 函数
function setupVideoCallSystem() {
    const videoCallBtn = document.getElementById('video-call-btn');
    const endCallBtn = document.getElementById('end-call-btn');
    const chatMessageBtn = document.getElementById('chat-message-btn');
    const chatInputModal = document.getElementById('video-chat-input-modal');
    const chatTextarea = document.getElementById('video-chat-textarea');
    const sendChatBtn = document.getElementById('video-chat-send-btn');
    const voiceToTextBtn = document.getElementById('voice-to-text-btn');

    let recognition;
    let isSpeechRecognitionActive = false;
    let finalTranscript = '';

    videoCallBtn.addEventListener('click', () => {
        initiateVideoCallRequest();
    });

    // 这是关键的修复：确保按钮能正确调用我们刚刚添加的函数
    endCallBtn.addEventListener('click', endVideoCall);

    chatMessageBtn.addEventListener('click', () => {
        chatTextarea.value = '';
        chatInputModal.classList.add('visible');
        setTimeout(() => chatTextarea.focus(), 100);
    });

    sendChatBtn.addEventListener('click', async () => {
        const text = chatTextarea.value.trim();
        chatInputModal.classList.remove('visible');
        if (text) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const senderName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            sendVideoCallChatMessage('me', text, senderName);
            await getAiVideoCallReply();
        }
    });

    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'zh-CN';

        recognition.onstart = () => {
            isSpeechRecognitionActive = true;
            finalTranscript = '';
            voiceToTextBtn.classList.add('toggled', 'recording');
            showToast('正在聆听...');
        };

        recognition.onerror = (event) => {
            showToast('语音识别错误: ' + event.error);
        };

        recognition.onend = () => {
            isSpeechRecognitionActive = false;
            voiceToTextBtn.classList.remove('toggled', 'recording');

            if (finalTranscript.trim()) {
                chatTextarea.value = finalTranscript;
                chatInputModal.classList.add('visible');
                setTimeout(() => chatTextarea.focus(), 100);
            } else {
                showToast('没有识别到语音');
            }
        };

        recognition.onresult = (event) => {
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }
        };

        voiceToTextBtn.addEventListener('click', () => {
            if (isSpeechRecognitionActive) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

    } else {
        voiceToTextBtn.disabled = true;
    }
    
    const editForm = document.getElementById('video-chat-edit-form');
    const newForm = editForm.cloneNode(true);
    editForm.parentNode.replaceChild(newForm, editForm);

    newForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const modal = document.getElementById('video-chat-edit-modal');
        const textarea = document.getElementById('video-chat-edit-textarea');
        const idInput = document.getElementById('editing-video-chat-message-id');

        const messageId = idInput.value;
        const newText = textarea.value.trim();

        const messageIndex = currentVideoCallMessages.findIndex(m => m.id === messageId);
        if (messageIndex > -1 && newText) {
            currentVideoCallMessages[messageIndex].text = newText;
            renderVideoChatLog();
            showToast('消息已更新');
        }
        modal.classList.remove('visible');
    });
}
// ▼▼▼ 将此函数作为独立函数添加到 setupVideoCallSystem 之后 ▼▼▼
function startVideoCall() {
    // 作用：在切换到通话界面前，确保移除所有“正在呼叫”的临时消息卡片。
    document.querySelectorAll('[id^="msg_temp_"]').forEach(el => el.remove());

    const chat = (currentChatType === 'private')
        ? db.characters.find(c => c.id === currentChatId)
        : db.groups.find(g => g.id === currentChatId);
    if (!chat) return;

    currentVideoCallContext = chat.history.slice(-10);
    currentVideoCallMessages = [];
    const logContainer = document.getElementById('video-chat-log');
    logContainer.innerHTML = '';
    logContainer.classList.remove('visible');
    document.getElementById('voice-to-text-btn').classList.remove('toggled', 'recording');

    if (currentChatType === 'private') {
        document.getElementById('group-video-grid').style.display = 'none';
        document.getElementById('video-area-bg').style.display = 'block';
        document.getElementById('pip-view-bg').style.display = 'block';
        document.getElementById('video-call-avatar').src = chat.avatar;
        document.getElementById('video-call-name').textContent = chat.remarkName;
        document.getElementById('video-area-bg').style.backgroundImage = `url(${chat.avatar})`;
        document.getElementById('pip-view-bg').style.backgroundImage = `url(${chat.myAvatar})`;
    } else { // 群聊UI设置
        document.getElementById('video-area-bg').style.display = 'none';
        document.getElementById('pip-view-bg').style.display = 'none';
        const grid = document.getElementById('group-video-grid');
        grid.style.display = 'grid';
        grid.innerHTML = ''; 

        const userTile = document.createElement('div');
        userTile.className = 'participant-tile';
        userTile.innerHTML = `<img src="${chat.me.avatar}" alt="${chat.me.nickname}" class="participant-avatar"><div class="participant-name">${chat.me.nickname} (你)</div>`;
        grid.appendChild(userTile);

        chat.members.forEach(member => {
            const memberTile = document.createElement('div');
            memberTile.className = 'participant-tile';
            memberTile.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}" class="participant-avatar"><div class="participant-name">${member.groupNickname}</div>`;
            grid.appendChild(memberTile);
        });

        document.getElementById('video-call-avatar').src = chat.avatar;
        document.getElementById('video-call-name').textContent = chat.name;
    }

    switchScreen('video-call-screen');

    const timerEl = document.getElementById('video-call-timer');
    videoCallSeconds = 0;
    timerEl.textContent = '00:00';
    clearInterval(videoCallTimerInterval);
    videoCallTimerInterval = setInterval(() => {
        videoCallSeconds++;
        const minutes = Math.floor(videoCallSeconds / 60);
        const seconds = videoCallSeconds % 60;
        timerEl.textContent = `${pad(minutes)}:${pad(seconds)}`;
    }, 1000);

    setTimeout(getAiVideoCallReply, 1500);
}
// 用这个新版本替换旧的同名函数
// ▼▼▼ 替换此函数 ▼▼▼
function sendVideoCallChatMessage(sender, text, senderName, senderId = null) {
    // 新增了 senderId 参数，用于记录并显示是谁在说话
    currentVideoCallMessages.push({ id: `vc_msg_${Date.now()}`, sender, text, senderName, senderId });
    renderVideoChatLog();
}

            // ▼▼▼ 请用这个【新版本】替换旧的 sendVideoCallEndMessage 函数 ▼▼▼
async function sendVideoCallEndMessage(durationInSeconds, messages) {
    // --- 核心改动：同时兼容私聊和群聊 ---
    const chat = (currentChatType === 'private')
        ? db.characters.find(c => c.id === currentChatId)
        : db.groups.find(g => g.id === currentChatId);

    if (!chat) return;
    const durationText = formatCallDuration(durationInSeconds);
    const messageContent = `[videocall:ended:${durationText}]`;

    const message = {
        id: `msg_videocall_${Date.now()}`,
        role: 'user',
        content: messageContent,
        parts: [{ type: 'text', text: messageContent }],
        timestamp: Date.now(),
        videoChatLog: messages || []
    };
    
    // 如果是群聊，需要标记发送者
    if (currentChatType === 'group') {
        message.senderId = 'user_me';
    }

    chat.history.push(message);
    addMessageBubble(message);
    await saveData();
    renderChatList();
}

    function formatCallDuration(seconds) {
        if (seconds < 60) return `${seconds}秒`;
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}分${remainingSeconds}秒`;
    }

// ▼▼▼ 使用这个新版本完整替换旧的同名函数 ▼▼▼
function generateVideoCallSystemPrompt(chat, mainChatHistory, videoCallHistory) {
    const now = new Date();
    const currentTime = `${now.getFullYear()}/${pad(now.getMonth() + 1)}/${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;

    const formatHistory = (history) => {
        if (!history || history.length === 0) return `[无记录]\n`;
        return history.map(msg => {
            let sender;
            if (msg.role === 'user' || msg.sender === 'me') {
                sender = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            } else {
                 sender = msg.senderName || ((currentChatType === 'private') ? chat.realName : "AI角色");
            }
            let content = (msg.text || msg.content).replace(/\[.*?的消息：([\s\S]+?)\]/, '$1').trim();
            return `${sender}: ${content}`;
        }).join('\n');
    };

    if (currentChatType === 'private') {
        // --- 这是根据您的新要求重写的私聊视频通话prompt ---
        let prompt = `你现在是一个场景描述引擎。你的任务是扮演角色，并以【第三人称旁观视角】来描述TA在视频通话中的所有动作和语言。\n\n`;
        prompt += `# 核心规则\n`;
        prompt += `1. **【【【视角铁律】】】**: 你的回复【绝对不能】使用第一人称“我”。必须使用第三人称，如“他”、“她”、或直接使用角色名“${chat.realName}”。\n`;
        prompt += `2. **格式**: 你的回复【必须】是一段描述性的文本。角色的对话请用「」包裹。\n\n`;
        prompt += `--- 通话设定 ---\n`;
        prompt += `1. 你的身份: ${chat.realName} (人设: ${chat.persona || "无"})\n`;
        prompt += `2. 对方身份: ${chat.myName}\n`;
        prompt += `3. 当前时间: ${currentTime}\n\n`;
        prompt += `--- 对话上下文 ---\n`;
        prompt += `通话前的聊天记录:\n${formatHistory(mainChatHistory)}\n`;
        prompt += `当前视频通话中的对话:\n${formatHistory(videoCallHistory)}\n\n`;
        prompt += `--- 你的任务 ---\n`;
        prompt += `现在，请根据以上全部信息，特别是用户的最新一句话，生成下一段符合你角色人设的、生动的场景描述。`;
        return prompt;

    } else {
        // --- 群聊的prompt保持不变 ---
        let prompt = `你是一个群聊视频通话的导演。你的任务是扮演所有【除了用户以外】的AI角色，并以【第三人称旁观视角】来描述他们在通话中的所有动作和语言。\n\n`;
        prompt += `--- 核心规则 ---\n`;
        prompt += `1.  **身份铁律**: 用户的身份是“${chat.me.nickname}”，你【不能】描述用户的行为，只能描述AI角色的行为并让他们回应用户。\n`;
        prompt += `2.  **视角铁律**: 你的回复【绝对不能】使用第一人称“我”。你是在描述别人。\n`;
        prompt += `3.  **格式铁律**: 你的回复【必须】由多个部分组成，每个部分代表一个AI角色的行动描述。每一部分的格式都必须是：\`[{角色群昵称}的行动：{旁白描述}]\`。每个角色的描述占一行。\n`;
        prompt += `4.  **角色扮演**: 严格遵守每个AI角色的设定，让他们的行为和语言符合其性格。\n\n`;
        prompt += `--- 通话参与者 ---\n`;
        prompt += `   - **用户**: “${chat.me.nickname}” (人设: ${chat.me.persona || "无"})\n`;
        chat.members.forEach(m => {
            prompt += `   - **AI角色**: “${m.groupNickname}” (人设: ${m.persona || "无"})\n`;
        });
        prompt += `\n--- 描述要求 ---\n`;
        prompt += `-   你的描述需要生动，包含角色的【动作、表情、神态】等细节。\n`;
        prompt += `-   当角色说话时，必须将他们说的话用引号「」包裹起来，并融入到旁白描述中。\n`;
        prompt += `-   例如: \`[张三的行动：张三看到消息后开心地笑了起来，他对着镜头挥挥手说「你们好呀！」]\`\n\n`;
        prompt += `--- 对话上下文 ---\n`;
        prompt += `通话前的群聊记录:\n${formatHistory(mainChatHistory)}\n`;
        prompt += `当前视频通话中的对话:\n${formatHistory(videoCallHistory)}\n\n`;
        prompt += `--- 你的任务 ---\n`;
        prompt += `现在，请根据“${chat.me.nickname}”的最新发言，作为导演，描述群里【2到4个】AI角色的反应。记住，每个角色的描述都必须使用独立的 \`[{角色群昵称}的行动：...]\` 格式，并且每个描述占一行。`;
        return prompt;
    }
}

// ▼▼▼ 替换此函数 ▼▼▼
async function getAiVideoCallReply() {
    if (isGeneratingVideoReply) return;
    const { url, key, model, provider } = db.apiSettings;
    if (!url || !key || !model) {
        showToast('API设置不完整');
        return;
    }
    const chat = (currentChatType === 'private')
        ? db.characters.find(c => c.id === currentChatId)
        : db.groups.find(g => g.id === currentChatId);
    if (!chat) return;

    isGeneratingVideoReply = true;
    const timerEl = document.getElementById('video-call-timer');
    const originalTimerText = timerEl.textContent;
    timerEl.textContent = '对方正在思考...';

    try {
        const systemPrompt = generateVideoCallSystemPrompt(chat, currentVideoCallContext, currentVideoCallMessages);
        let endpoint, headers, requestBody;

        if (provider === 'gemini') {
            let contents = currentVideoCallMessages.map(msg => ({
                role: (msg.sender === 'me') ? 'user' : 'model',
                parts: [{ text: msg.text }]
            }));

            if (contents.length === 0) {
                 const startText = `(${currentChatType === 'private' ? '视频通话已接通' : '群组视频通话已开始'}，请开始对话。)`;
                contents.push({ role: 'user', parts: [{ text: startText }] });
            }

            endpoint = `${url}/v1beta/models/${model}:generateContent?key=${getRandomValue(key)}`;
            headers = { 'Content-Type': 'application/json' };
            requestBody = {
                contents: contents,
                system_instruction: { parts: [{ text: systemPrompt }] }
            };

        } else {
            const messagesForAPI = currentVideoCallMessages.map(msg => ({
                role: (msg.sender === 'me') ? 'user' : 'assistant',
                content: msg.text
            }));

            endpoint = `${url}/v1/chat/completions`;
            headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` };
            requestBody = {
                model: model,
                messages: [ { role: 'system', content: systemPrompt }, ...messagesForAPI ],
            };
        }

        const response = await fetch(endpoint, { method: 'POST', headers: headers, body: JSON.stringify(requestBody) });
        if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
        const data = await response.json();

        let aiResponseText;
        if (provider === 'gemini') {
            aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
        } else {
            aiResponseText = data.choices[0]?.message?.content?.trim();
        }

        if (aiResponseText) {
            if (currentChatType === 'group') {
                const messages = aiResponseText.split('\n').filter(line => line.trim() !== '');
                const messageRegex = /\[(.*?)的行动：([\s\S]*)\]/;

                messages.forEach(msgLine => {
                    const match = msgLine.match(messageRegex);
                    if (match) {
                        const senderNicknameFromAI = match[1];
                        const text = match[2];
                        // 核心修复：根据AI返回的昵称查找成员，获取其唯一ID
                        const member = chat.members.find(m => m.groupNickname === senderNicknameFromAI);
                        const senderId = member ? member.id : null; // 获取ID
                        sendVideoCallChatMessage('them', text, senderNicknameFromAI, senderId); // 传递ID
                    }
                });
            } else {
                 const senderName = chat.remarkName;
                 sendVideoCallChatMessage('them', aiResponseText, senderName);
            }
        } else {
             throw new Error("API返回了空内容，可能是因为安全设置。");
        }

    } catch (error) {
        console.error('AI视频通话回复失败:', error);
        sendVideoCallChatMessage('them', `[系统错误: ${error.message}]`, '系统');
    } finally {
        isGeneratingVideoReply = false;
        timerEl.textContent = originalTimerText;
    }
}
// ▼▼▼ 请用这个【新版本】替换旧的 endVideoCall 函数 ▼▼▼
function endVideoCall() {
    clearInterval(videoCallTimerInterval);
    switchScreen('chat-room-screen');
    sendVideoCallEndMessage(videoCallSeconds, currentVideoCallMessages); 
    currentVideoCallMessages = [];
    // 清理群聊视频通话的UI
    document.getElementById('group-video-grid').style.display = 'none';
    document.getElementById('group-video-grid').innerHTML = '';
}
function renderVideoChatLog() {
    const logContainer = document.getElementById('video-chat-log');
    if (!logContainer.classList.contains('visible')) {
        logContainer.classList.add('visible');
    }
    logContainer.innerHTML = ''; // 清空之前的消息

    currentVideoCallMessages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'video-chat-message';
        messageDiv.dataset.id = msg.id; // 为每条消息添加ID

        if (msg.sender === 'me') {
            messageDiv.classList.add('my-message');
        } else {
            messageDiv.classList.add('their-message');
        }

        messageDiv.innerHTML = `<div class="message-sender">${msg.senderName}</div>${msg.text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}`;
        logContainer.appendChild(messageDiv);
        
        // 【【【核心改动】】】:
        // 将事件绑定移出 if 判断，让所有消息（包括AI的）都能响应长按
        messageDiv.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            handleVideoChatMessageLongPress(messageDiv, e.clientX, e.clientY);
        });
        messageDiv.addEventListener('touchstart', (e) => {
            // 阻止冒泡，防止触发其他元素的点击事件
            e.stopPropagation(); 
            longPressTimer = setTimeout(() => {
                const touch = e.touches[0];
                handleVideoChatMessageLongPress(messageDiv, touch.clientX, touch.clientY);
            }, 500);
        });
        messageDiv.addEventListener('touchend', () => clearTimeout(longPressTimer));
        messageDiv.addEventListener('touchmove', () => clearTimeout(longPressTimer));
    });
    logContainer.scrollTop = logContainer.scrollHeight;
}
// ▼▼▼ 请用这个【全新版本】替换旧的 handleVideoChatMessageLongPress 函数 ▼▼▼
function handleVideoChatMessageLongPress(messageDiv, x, y) {
    const messageId = messageDiv.dataset.id;
    const message = currentVideoCallMessages.find(m => m.id === messageId);
    if (!message) return;

    let menuItems = [];

    // 【【【核心改动】】】: 移除了 if (message.sender === 'me') 的判断
    // 现在所有消息，无论是你自己的还是AI角色的，都可以被编辑和删除
    menuItems.push({
        label: '编辑',
        action: () => startVideoChatEdit(messageId)
    });
    menuItems.push({
        label: '删除',
        danger: true,
        action: () => deleteVideoChatMessage(messageId)
    });
    
    // 由于现在所有消息都有菜单，可以直接创建
    createContextMenu(menuItems, x, y);
}

function startVideoChatEdit(messageId) {
    const message = currentVideoCallMessages.find(m => m.id === messageId);
    if (!message) return;

    const modal = document.getElementById('video-chat-edit-modal');
    const textarea = document.getElementById('video-chat-edit-textarea');
    const idInput = document.getElementById('editing-video-chat-message-id');

    idInput.value = messageId;
    textarea.value = message.text;
    modal.classList.add('visible');
    setTimeout(() => textarea.focus(), 100);
}

function deleteVideoChatMessage(messageId) {
    if (confirm('确定要删除这条通话消息吗？')) {
        currentVideoCallMessages = currentVideoCallMessages.filter(m => m.id !== messageId);
        renderVideoChatLog();
        showToast('消息已删除');
    }
}
        init();
    });

</script>
<!-- ▼▼▼ 请用这部分代码替换 ▼▼▼ -->
<div id="video-chat-input-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>发送通话消息</h3>
        <div class="form-group">
            <textarea id="video-chat-textarea" rows="4" placeholder="在此输入文字..."></textarea>
        </div>
        <!-- 麦克风按钮已被删除 -->
        <button id="video-chat-send-btn" class="btn btn-primary" style="width: 100%;">发送</button>
    </div>
</div>
<!-- ▲▲▲ 替换结束 ▲▲▲ -->
<!-- ▼▼▼ START: 新增的视频通话记录弹窗 ▼▼▼ -->
<div id="video-log-modal" class="modal-overlay">
    <div class="modal-window" style="max-width: 90%; width: 380px;">
        <h3>通话记录</h3>
        <div id="video-log-content" style="max-height: 60vh; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee;">
            <!-- 通话记录将通过JS动态插入这里 -->
        </div>
        <button id="close-video-log-btn" class="btn btn-primary" style="margin-top: 20px;">关闭</button>
    </div>
</div>
<!-- ▲▲▲ END: 新增的视频通话记录弹窗 ▲▲▲ -->
<div id="video-chat-edit-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>编辑通话消息</h3>
        <form id="video-chat-edit-form">
            <input type="hidden" id="editing-video-chat-message-id">
            <div class="form-group">
                <textarea id="video-chat-edit-textarea" rows="5" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">保存</button>
        </form>
    </div>
</div>
<div id="avatar-library-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>角色头像库</h3>
        <div id="avatar-library-grid" class="sticker-grid" style="margin-bottom: 20px;">
            </div>
        <input type="file" id="add-avatar-upload" accept="image/*" style="display:none;" multiple>
        <label for="add-avatar-upload" class="btn btn-primary">上传新头像</label>
    </div>
</div>
<div id="group-avatar-library-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>群头像库</h3>
        <div id="group-avatar-library-grid" class="sticker-grid" style="margin-bottom: 20px;">
            </div>
        <input type="file" id="add-group-avatar-upload" accept="image/*" style="display:none;" multiple>
        <label for="add-group-avatar-upload" class="btn btn-primary">上传新头像</label>
    </div>
</div>
</body>

</html>